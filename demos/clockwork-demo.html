<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ClockWork - Universal Health Management Platform">
    <meta name="theme-color" content="#1e3a8a">
    <title>ClockWork</title>
    
    <!-- Production React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Three.js for 3D Phoenix -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .earth-logo {
            animation: spin-slow 20s linear infinite;
        }

        @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

@keyframes wing-left {
    0%, 100% { transform: rotate(0deg) scaleX(1); }
    50% { transform: rotate(-15deg) scaleX(1.2); }
}

@keyframes wing-right {
    0%, 100% { transform: rotate(0deg) scaleX(1); }
    50% { transform: rotate(15deg) scaleX(1.2); }
}

@keyframes flicker {
    0%, 100% { opacity: 1; transform: scaleY(1); }
    50% { opacity: 0.7; transform: scaleY(1.3); }
}

@keyframes flicker-delay-1 {
    0%, 100% { opacity: 0.8; transform: scaleY(1); }
    50% { opacity: 1; transform: scaleY(1.2); }
}

@keyframes flicker-delay-2 {
    0%, 100% { opacity: 0.9; transform: scaleY(1); }
    50% { opacity: 0.6; transform: scaleY(1.4); }
}

@keyframes spark-float-1 {
    0% { transform: translate(50px, 50px); opacity: 0; }
    20% { opacity: 1; }
    100% { transform: translate(30px, -30px); opacity: 0; }
}

@keyframes spark-float-2 {
    0% { transform: translate(50px, 50px); opacity: 0; }
    30% { opacity: 1; }
    100% { transform: translate(70px, -40px); opacity: 0; }
}

@keyframes spark-float-3 {
    0% { transform: translate(50px, 50px); opacity: 0; }
    40% { opacity: 1; }
    100% { transform: translate(10px, -50px); opacity: 0; }
}

.animate-float { animation: float 3s ease-in-out infinite; }
.animate-wing-left { animation: wing-left 2s ease-in-out infinite; }
.animate-wing-right { animation: wing-right 2s ease-in-out infinite; }
.animate-flicker { animation: flicker 1.5s ease-in-out infinite; }
.animate-flicker-delay-1 { animation: flicker-delay-1 2s ease-in-out infinite; }
.animate-flicker-delay-2 { animation: flicker-delay-2 2.5s ease-in-out infinite; }
.animate-spark-float-1 { animation: spark-float-1 3s ease-out infinite; }
.animate-spark-float-2 { animation: spark-float-2 3s ease-out infinite 0.5s; }
.animate-spark-float-3 { animation: spark-float-3 3s ease-out infinite 1s; }
        /* Phoenix of Tesla Background Watermark - INSERT AT LINE 165 */
@keyframes phoenix-traverse {
    0% {
        transform: translateX(-200px) translateY(0) scale(1);
        opacity: 0.3;  /* Increased from 0.08 */
    }
    25% {
        transform: translateX(25vw) translateY(-30px) scale(1.1);
        opacity: 0.4;  /* Increased from 0.1 */
    }
    50% {
        transform: translateX(50vw) translateY(0) scale(1);
        opacity: 0.5;  /* Increased from 0.12 */
    }
    75% {
        transform: translateX(75vw) translateY(30px) scale(0.9);
        opacity: 0.4;  /* Increased from 0.1 */
    }
    100% {
        transform: translateX(calc(100vw + 200px)) translateY(0) scale(1);
        opacity: 0.3;  /* Increased from 0.08 */
    }
}
.phoenix-watermark {
    position: fixed;
    bottom: 10%;
    left: -200px;
    width: 200px;  /* Increased from 150px */
    height: 200px;  /* Increased from 150px */
    z-index: -1;
    pointer-events: none;
    animation: phoenix-traverse 30s linear infinite;
    filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));  /* Enhanced glow */
}
}

.phoenix-watermark svg {
    width: 100%;
    height: 100%;
    opacity: 1;  /* Increased from 0.8 */
}
#phoenix-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: -1;
    opacity: 0.7;
}
@keyframes phoenix-celebration {
    0% {
        transform: scale(1) rotate(0deg);
        filter: brightness(1);
    }
    50% {
        transform: scale(1.2) rotate(180deg);
        filter: brightness(1.5) drop-shadow(0 0 30px #FFD700);
    }
    100% {
        transform: scale(1) rotate(360deg);
        filter: brightness(1);
    }
}

.phoenix-celebrate {
    animation: phoenix-celebration 2s ease-in-out;
}
/* END Phoenix of Tesla CSS */
        .golden-ring {
            position: absolute;
            width: 120%;
            height: 120%;
            border: 3px solid #fbbf24;
            border-radius: 50%;
            top: -10%;
            left: -10%;
            border-top-color: transparent;
            border-bottom-color: transparent;
        }
        
        :root {
            --clockwork-primary: #3b82f6;
            --clockwork-secondary: #60a5fa;
            --clockwork-accent: #fbbf24;
            --clockwork-dark: #0f1419;   
            --clockwork-darker: #000000;
            --clockwork-card: #1a202c;
            --clockwork-input: #111827; 
            --clockwork-text: #ffffff;  
            --clockwork-success: #10b981;
            --clockwork-error: #ef4444;
        }
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0f1419;
            color: #e5e7eb;
        }
        
        /* Gradient removed for darker theme */
        
        .dark-card {
           background: #1f2937;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        
        .dark-card {
            background: #1f2937;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .coastal-button {
            background: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .coastal-button:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .coastal-button:disabled {
            background: #374151;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .coastal-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #374151;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #1f2937;
            color: #e5e7eb;
        }
        
        .coastal-input::placeholder {
            color: #6b7280;
        }
        
        .coastal-input:focus {
            outline: none;
           background: #1f2937;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.3);
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #4b5563;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        
        .modal-content {
           background: #1f2937;
            border-radius: 20px;
            padding: 2rem;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
            color: #e5e7eb;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .badge-client { background: #1e3a8a; color: #dbeafe; }
        .badge-specialist { background: #059669; color: #d1fae5; }
        .badge-admin { background: #d97706; color: #fef3c7; }
        .badge-owner { background: #7c3aed; color: #e9d5ff; }
        .badge-engineer { background: #dc2626; color: #fee2e2; }
        
        .star-rating {
            display: inline-flex;
            gap: 0.25rem;
        }
        
        .star-rating .star {
            color: #fbbf24;
            font-size: 1.25rem;
        }
        
        .star-rating .star.empty {
            color: #4b5563;
        }
        
        .progress-bar {
            background: #374151;
            border-radius: 9999px;
            height: 0.5rem;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease;
        }
        
        .metric-card {
           background: #1f2937;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            color: #e5e7eb;
        }
        
        .wellness-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #1f2937;
            border-radius: 8px;
        }
        
        .mood-emoji {
            font-size: 2rem;
        }
        
        @media (max-width: 768px) {
            .coastal-input { font-size: 16px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        // Check for wearable connection success/error
window.addEventListener('DOMContentLoaded', () => {
  const urlParams = new URLSearchParams(window.location.search);
  
  const connectedDevice = urlParams.get('wearable_connected');
  const error = urlParams.get('wearable_error');
  
  if (connectedDevice) {
    // Show success message
    alert(`üéâ ${connectedDevice.charAt(0).toUpperCase() + connectedDevice.slice(1)} connected successfully!`);
    
    // Clean up URL
    window.history.replaceState({}, '', window.location.pathname);
  }
  
  if (error) {
    // Show error message
    alert(`‚ùå Connection failed: ${error}`);
    
    // Clean up URL
    window.history.replaceState({}, '', window.location.pathname);
  }
});
        // INSERT AT LINE 203 - GLOBAL TIMEZONE CONFIGURATION
const APP_TIMEZONE = 'America/New_York';
const DateHandler = {
    toDateInput: (dateValue) => {
        // If no date, return today
        if (!dateValue || dateValue === 'Invalid Date') {
            return new Date().toLocaleDateString('en-CA');
        }
        
        // If already in YYYY-MM-DD format, return as is
        if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
            return dateValue;
        }
        
        // Try to parse whatever we got
        try {
            const date = new Date(dateValue);
            // Check if valid
            if (isNaN(date.getTime())) {
                return new Date().toLocaleDateString('en-CA');
            }
            // Format as YYYY-MM-DD
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        } catch (e) {
            return new Date().toLocaleDateString('en-CA');
        }
    },
    
    toDatabase: (dateString) => {
        if (!dateString || dateString === 'Invalid Date') return new Date().toISOString();
        try {
            return new Date(`${dateString}T12:00:00`).toISOString();
        } catch (e) {
            return new Date().toISOString();
        }
    },
    
    toDisplay: (dateValue) => {
    // Enhanced display with better user feedback
    if (!dateValue || dateValue === 'Invalid Date') {
        return 'Not set'; // More informative than empty string
    }
    
    try {
        const date = new Date(dateValue);
        if (isNaN(date.getTime())) {
            return 'Not set'; // Clear feedback for invalid dates
        }
        
        // Format the date with better readability
        const options = { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            timeZone: APP_TIMEZONE // Use app timezone
        };
        return date.toLocaleDateString('en-US', options);
    } catch (e) {
        return 'Not set'; // Consistent error handling
    }
},
    
    getCurrentETDate: () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
};
        
        // API Configuration - Railway Backend
       const API_CONFIG = {
    baseURL: 'https://cwbackend-production-314e.up.railway.app/api',
    
    getHeaders: () => ({
        'Content-Type': 'application/json',
        'Authorization': localStorage.getItem('token') ? `Bearer ${localStorage.getItem('token')}` : ''
    }),
    
    async request(endpoint, options = {}) {
        try {
            const response = await fetch(`${this.baseURL}${endpoint}`, {
                ...options,
                headers: {
                    ...this.getHeaders(),
                    ...options.headers
                }
            });
             // ‚úÖ ADD THIS NEW BLOCK HERE
        if (response.status === 401) {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ef4444;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                z-index: 9999;
                font-weight: bold;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>Session expired. Redirecting to login...</div>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                window.location.reload();
            }, 2000);
            
            throw new Error('Session expired');
        }
        // ‚úÖ END NEW BLOCK
            
            let data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || 'Request failed');
            }
            
            // GENIUS AUTO-UNWRAPPER
            let unwrapped = data;
            
            if (data && typeof data === 'object' && 'data' in data) {
                unwrapped = data.data;
            } else if (data && typeof data === 'object' && 'result' in data) {
                unwrapped = data.result;
            } else if (data && typeof data === 'object' && 'response' in data) {
                unwrapped = data.response;
            }
            
            const endpointSignatures = {
                singles: ['/users/profile', '/auth/login', '/auth/register', '/nutrition'],
                arrays: ['/users', '/workouts', '/measurements', '/goals', '/tests', '/exercises', '/messages']
            };

            const expectsSingle = endpointSignatures.singles.some(sig => endpoint.includes(sig));
            const expectsArray = !expectsSingle && (
                endpointSignatures.arrays.some(sig => endpoint.includes(sig)) ||
                endpoint.includes('/client/')
            );
            
            if (expectsArray) {
                if (Array.isArray(unwrapped)) {
                    return unwrapped;
                }
                if (unwrapped && typeof unwrapped === 'object') {
                    return [unwrapped];
                }
                return [];
            } else if (expectsSingle) {
                if (Array.isArray(unwrapped) && unwrapped.length > 0) {
                    return unwrapped[0];
                }
                return unwrapped || null;
            } else {
                return unwrapped;
            }
            
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }
};

// Add ResponseHandler and ClientManager
const ResponseHandler = {
    extractArray(response) {
        if (!response) return [];
        if (Array.isArray(response)) return response;
        if (response.data !== undefined) return this.extractArray(response.data);
        if (response.items) return this.extractArray(response.items);
        if (response.results) return this.extractArray(response.results);
        if (typeof response === 'object') return [response];
        return [];
    },
    
    extractSingle(response) {
        if (!response) return null;
        if (response && response.data !== undefined) return response.data;
        if (Array.isArray(response)) return response[0] || null;
        return response;
    }
};

const ClientManager = {
    clients: [],
    loaded: false,
    listeners: new Set(),
    selectedClientId: null,
    
    // Subscribe to client changes
    subscribe(callback) {
        this.listeners.add(callback);
        return () => this.listeners.delete(callback);
    },
    
    // Notify all subscribers
    notify() {
        this.listeners.forEach(callback => callback(this.clients, this.selectedClientId));
    },
    
    // Set selected client globally
    setSelectedClient(clientId) {
        this.selectedClientId = clientId;
        this.notify();
    },
    
    // Get selected client
    getSelectedClient() {
        return this.selectedClientId;
    },
    
    async loadClients() {
        if (this.loaded && this.clients.length > 0) {
            return this.clients;
        }
        
        try {
            const response = await API_CONFIG.request('/users?role=client');
            const users = Array.isArray(response) ? response : (response.data || []);
            this.clients = users;
            this.loaded = true;
            this.notify();
            return this.clients;
        } catch (error) {
            console.error('ClientManager: Failed to load clients', error);
            return [];
        }
    },
    
    getClients() {
        return this.clients;
    },
    
    reset() {
        this.clients = [];
        this.loaded = false;
        this.selectedClientId = null;
        this.notify();
    }
};

window.ClientManager = ClientManager;
        // Custom hook to use ClientManager
const useClientManager = () => {
    const [clients, setClients] = useState(ClientManager.getClients());
    const [selectedClient, setSelectedClient] = useState(ClientManager.getSelectedClient());
    
    useEffect(() => {
        // Subscribe to changes
        const unsubscribe = ClientManager.subscribe((newClients, newSelectedId) => {
            setClients(newClients);
            setSelectedClient(newSelectedId);
        });
        
        // Load clients if not loaded
        if (!ClientManager.loaded) {
            ClientManager.loadClients();
        }
        
        return unsubscribe;
    }, []);
    
    const selectClient = (clientId) => {
        ClientManager.setSelectedClient(clientId);
    };
    
    return { clients, selectedClient, selectClient };
};
        // === CLOCKWORK-GENESIS SYSTEM CONFIGURATION ===
const SYSTEM_CONFIG = {
    TIERS: {
        SOLO: { name: 'Solo Trainer', price: 49, maxSpecialists: 1 },
        TEAM: { name: 'Gym Team', price: 149, maxSpecialists: 5 },
        ENTERPRISE: { name: 'Enterprise', price: 299, maxSpecialists: 999 }
    },
    
    PAYMENT_TIMINGS: ['pre-pay', 'on-arrival', 'post-service', 'package'],
    CLASS_TYPES: { GROUP: 'group', ONE_ON_ONE: '1on1', APPOINTMENT: 'appointment' },
    TRIAL_DAYS: 7,
    
    SETUP_STEPS: [
        { id: 'profile', label: 'Complete Gym Profile', weight: 20 },
        { id: 'team', label: 'Add Team Members', weight: 20 },
        { id: 'client', label: 'Add First Client', weight: 20 },
        { id: 'workout', label: 'Create First Workout', weight: 20 },
        { id: 'explore', label: 'Explore Features', weight: 20 }
    ]
};

// Extended API methods
Object.assign(API_CONFIG, {
    async createGym(data) {
        return this.request('/gyms/create', { method: 'POST', body: JSON.stringify(data) });
    },
    
    async getGymProgress(gymId) {
        return this.request(`/gyms/${gymId}/progress`);
    },
    
    async getClasses(gymId) {
        return this.request(`/classes/gym/${gymId}`);
    },
    
    async createClass(gymId, data) {
        return this.request(`/classes/gym/${gymId}`, { method: 'POST', body: JSON.stringify(data) });
    },
    
    async bookClass(classId, userId) {
        return this.request(`/classes/${classId}/book`, { method: 'POST', body: JSON.stringify({ userId }) });
    },
    
    async processPayment(data) {
        return this.request('/payments/charge', { method: 'POST', body: JSON.stringify(data) });
    }
});
        
        // Main App Component
        const App = () => {
            const [user, setUser] = useState(null);
const [loading, setLoading] = useState(true);
const [activeTab, setActiveTab] = useState('dashboard');
const [globalSelectedClient, setGlobalSelectedClient] = useState(null);
const [error, setError] = useState(null);
const [success, setSuccess] = useState(null);
           
            
            // Check for saved token on mount
            useEffect(() => {
                const token = localStorage.getItem('token');
                if (token) {
                    fetchProfile();
                } else {
                    setLoading(false);
                }
            }, []);
            
            const fetchProfile = async () => {
    try {
        const token = localStorage.getItem('token');
        if (!token) {
            setLoading(false);
            return;
        }
        
        // Direct fetch with explicit headers
        const response = await fetch(`${API_CONFIG.baseURL}/users/profile`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch profile');
        }
        
        const data = await response.json();
        
        // Handle multiple response formats
        let userData = null;
        if (data.user) userData = data.user;
        else if (data.data) userData = data.data;
        else userData = data;
        
        if (userData && userData._id) {
            setUser(userData);
        } else {
            throw new Error('Invalid user data');
        }
    } catch (error) {
        console.error('Profile fetch error:', error);
        localStorage.removeItem('token');
        setUser(null);
    } finally {
        setLoading(false);
    }
};
            
            const handleLogout = () => {
                localStorage.removeItem('token');
                setUser(null);
                setActiveTab('dashboard');
            };
            
            const showError = (msg) => {
                setError(msg);
                setTimeout(() => setError(null), 5000);
            };
            
           const showSuccess = (msg) => {
    setSuccess(msg);
    setTimeout(() => setSuccess(null), 5000);
    // Phoenix celebration
    try {
        const watermark = document.querySelector('.phoenix-watermark');
        if (watermark) {
            watermark.classList.add('phoenix-celebrate');
            setTimeout(() => {
                watermark.classList.remove('phoenix-celebrate');
            }, 2000);
        }
    } catch (e) {
        // Silently fail if there's any issue
    }
};
            
            if (loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <div className="loading-spinner"></div>
                    </div>
                );
            }
            
            if (!user) {
                return <LoginPage onLogin={setUser} showError={showError} />;
            }
            
            const isOnlyClient = user.roles?.length === 1 && user.roles[0] === 'client';
            const isSpecialist = user.roles?.includes('specialist');
            const isAdmin = user.roles?.includes('admin');
            const isOwner = user.roles?.includes('owner');
            const isEngineer = user.roles?.includes('engineer');
            const isProfessional = isSpecialist || isAdmin || isOwner || isEngineer;
           
            
            return (
                <div className="min-h-screen bg-gray-800">
                    {/* Phoenix of Tesla Watermark - INSERT AT LINE 349 */}
                    <div className="phoenix-watermark">
                        <svg viewBox="0 0 100 100">
                            <defs>
                                <linearGradient id="phoenix-watermark-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stopColor="#FFD700" stopOpacity="0.6"></stop>
                                    <stop offset="50%" stopColor="#FF6B35" stopOpacity="0.8"></stop>
                                    <stop offset="100%" stopColor="#FF3300" stopOpacity="0.6"></stop>
                                </linearGradient>
                            </defs>
                            <path d="M50 70 Q35 55 35 40 Q35 25 50 10 Q65 25 65 40 Q65 55 50 70Z" 
                                  fill="url(#phoenix-watermark-gradient)"></path>
                            <path d="M35 40 Q15 35 10 45 Q15 50 25 48 Q30 45 35 40" 
                                  fill="url(#phoenix-watermark-gradient)" opacity="0.7"></path>
                            <path d="M65 40 Q70 45 75 48 Q85 50 90 45 Q85 35 65 40" 
                                  fill="url(#phoenix-watermark-gradient)" opacity="0.7"></path>
                            <circle cx="46" cy="35" r="1.5" fill="#FFFFFF"></circle>
                        </svg>
                    </div>
                    {/* END Phoenix Watermark */}
                    <Navigation 
    user={user}
    activeTab={activeTab}
    setActiveTab={setActiveTab}
    isProfessional={isProfessional}
    isClient={user.roles?.includes('client')}  // Pass true if user has client role
    onLogout={handleLogout}
/>
                    
                   {error && error !== 'Invalid Date' && (
                        <div className="max-w-7xl mx-auto px-4 mt-4">
                            <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
                                {error}
                            </div>
                        </div>
                    )}
                    
                    {success && (
                        <div className="max-w-7xl mx-auto px-4 mt-4">
                            <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded">
                                {success}
                            </div>
                        </div>
                    )}
                    
                    <main className="max-w-7xl mx-auto px-4 py-6">
    {activeTab === 'dashboard' && <Dashboard user={user} isClient={isOnlyClient} selectedClientId={globalSelectedClient} onClientChange={setGlobalSelectedClient} />}
    {activeTab === 'workouts' && <Workouts user={user} isClient={isOnlyClient} showError={showError} showSuccess={showSuccess} selectedClientId={globalSelectedClient} onClientChange={setGlobalSelectedClient} />}
    {activeTab === 'measurements' && <Measurements user={user} isClient={isOnlyClient} showError={showError} showSuccess={showSuccess} selectedClientId={globalSelectedClient} onClientChange={setGlobalSelectedClient} />}
    {activeTab === 'nutrition' && <Nutrition user={user} isClient={isOnlyClient} showError={showError} showSuccess={showSuccess} selectedClientId={globalSelectedClient} onClientChange={setGlobalSelectedClient} />}
    {activeTab === 'goals' && <Goals user={user} isClient={isOnlyClient} showError={showError} showSuccess={showSuccess} selectedClientId={globalSelectedClient} onClientChange={setGlobalSelectedClient} />}
    {activeTab === 'calendar' && <Calendar user={user} showError={showError} showSuccess={showSuccess} />}
    {activeTab === 'wearables' && <Wearables user={user} showError={showError} showSuccess={showSuccess} />}
    {activeTab === 'reports' && <Reports user={user} isClient={isOnlyClient} showSuccess={showSuccess} showError={showError} selectedClientId={globalSelectedClient} onClientChange={setGlobalSelectedClient} />}
    {activeTab === 'exercises' && <ExerciseLibrary user={user} showError={showError} showSuccess={showSuccess} />}
    {activeTab === 'tests' && <Tests user={user} showError={showError} showSuccess={showSuccess} selectedClientId={globalSelectedClient} onClientChange={setGlobalSelectedClient} />}
    {activeTab === 'users' && <Users user={user} showError={showError} showSuccess={showSuccess} />}
                    </main>
                </div>
            );
        };
        
        // Navigation Component
       const Navigation = ({ user, activeTab, setActiveTab, isProfessional, isClient, onLogout }) => {
    const tabs = [
        { id: "dashboard", label: "Dashboard", icon: "üìä" },
        { id: "workouts", label: "Workouts", icon: "üí™" },
        { id: "measurements", label: "Measurements", icon: "üìè" },
        { id: "nutrition", label: "Nutrition", icon: "ü•ó" },
        { id: "goals", label: "Goals", icon: "üéØ" },
        { id: "calendar", label: "Calendar", icon: "üìÖ" },
        { id: "wearables", label: "Wearables", icon: "‚åö" },
        { id: "reports", label: "Reports", icon: "üìÑ" }
    ];
    
    if (isProfessional) {
        tabs.push({ id: "exercises", label: "Exercise Library", icon: "üìö" });
        tabs.push({ id: "tests", label: "Tests", icon: "üß™" });
    }
    
    if (user.roles?.includes("admin") || user.roles?.includes("owner") || user.roles?.includes("engineer")) {
        tabs.push({ id: "users", label: "Users", icon: "üë•" });
    }
    
    return (
        <nav className="bg-gray-900 shadow-xl border-b border-gray-700">
            <div className="max-w-7xl mx-auto px-4">
                <div className="flex justify-between items-center py-4">
                    <div className="flex items-center gap-4">
                        <div className="flex items-center gap-2">
                            <div className="relative h-10 w-10">
                                <div className="relative h-full w-full">
                                    {/* Animated flame background */}
                                    <div className="absolute inset-0 animate-pulse">
                                        <div className="absolute inset-0 bg-gradient-to-t from-yellow-500 via-orange-500 to-red-500 opacity-30 blur-xl animate-spin-slow"></div>
                                    </div>
                                    
                                    {/* Main Phoenix */}
                                    <svg viewBox="0 0 100 100" className="relative z-10 h-full w-full animate-float">
                                        {/* Phoenix body */}
                                        <path d="M50 70 Q35 55 35 40 Q35 25 50 10 Q65 25 65 40 Q65 55 50 70Z" 
                                              fill="url(#phoenix-body)"
                                              filter="url(#glow)"/>
                                        
                                        {/* Left wing */}
                                        <path d="M35 40 Q15 35 10 45 Q15 50 25 48 Q30 45 35 40" 
                                              fill="url(#wing-gradient)"
                                              className="animate-wing-left origin-center"/>
                                        
                                        {/* Right wing */}
                                        <path d="M65 40 Q70 45 75 48 Q85 50 90 45 Q85 35 65 40" 
                                              fill="url(#wing-gradient)"
                                              className="animate-wing-right origin-center"/>
                                        
                                        {/* Flame feathers */}
                                        <path d="M50 10 Q48 5 50 0 Q52 5 50 10" fill="#fbbf24" className="animate-flicker"/>
                                        <path d="M45 12 Q43 8 42 5 Q44 8 45 12" fill="#f97316" className="animate-flicker-delay-1"/>
                                        <path d="M55 12 Q56 8 58 5 Q57 8 55 12" fill="#f97316" className="animate-flicker-delay-2"/>
                                        
                                        {/* Eye */}
                                        <circle cx="46" cy="35" r="2" fill="#fff" className="animate-pulse"/>
                                        
                                        {/* Tail feathers */}
                                        <path d="M50 70 Q45 75 40 80 Q45 77 50 70" fill="#ef4444" className="animate-flicker"/>
                                        <path d="M50 70 Q55 75 60 80 Q55 77 50 70" fill="#ef4444" className="animate-flicker-delay-1"/>
                                        
                                        <defs>
                                            <linearGradient id="phoenix-body" x1="0%" y1="0%" x2="0%" y2="100%">
                                                <stop offset="0%" stopColor="#fbbf24">
                                                    <animate attributeName="stop-color" values="#fbbf24;#f97316;#ef4444;#fbbf24" dur="3s" repeatCount="indefinite"/>
                                                </stop>
                                                <stop offset="50%" stopColor="#f97316"/>
                                                <stop offset="100%" stopColor="#ef4444">
                                                    <animate attributeName="stop-color" values="#ef4444;#fbbf24;#f97316;#ef4444" dur="3s" repeatCount="indefinite"/>
                                                </stop>
                                            </linearGradient>
                                            
                                            <linearGradient id="wing-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                                <stop offset="0%" stopColor="#fbbf24" stopOpacity="0.8"/>
                                                <stop offset="100%" stopColor="#ef4444" stopOpacity="0.3"/>
                                            </linearGradient>
                                            
                                            <filter id="glow">
                                                <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                                                <feMerge>
                                                    <feMergeNode in="coloredBlur"/>
                                                    <feMergeNode in="SourceGraphic"/>
                                                </feMerge>
                                            </filter>
                                        </defs>
                                    </svg>
                                    
                                    {/* Floating sparks */}
                                    <div className="absolute inset-0">
                                        <div className="spark-1 absolute h-1 w-1 bg-yellow-400 rounded-full animate-spark-float-1"></div>
                                        <div className="spark-2 absolute h-1 w-1 bg-orange-400 rounded-full animate-spark-float-2"></div>
                                        <div className="spark-3 absolute h-1 w-1 bg-red-400 rounded-full animate-spark-float-3"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                <span className="text-sm text-gray-200">
                                    {user.name} ({user.roles?.join(", ")})
                                </span>
                                <button onClick={onLogout} className="text-red-500 hover:text-red-600">
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex gap-2 pb-2 overflow-x-auto">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`px-4 py-2 rounded whitespace-nowrap ${
                                    activeTab === tab.id 
                                        ? "bg-blue-500 text-white" 
                                        : "bg-gray-700 hover:bg-gray-600 text-gray-300"
                                }`}
                            >
                                <span className="mr-2">{tab.icon}</span>
                                {tab.label}
                            </button>
                        ))}
                    </div>
                </div>
            </div>
        </nav>
    );
};
        
        // Login Page Component
        const LoginPage = ({ onLogin, showError }) => {
            const [isSignup, setIsSignup] = useState(false);
            const [formData, setFormData] = useState({
                name: '',
                email: '',
                password: ''
            });
            const [loading, setLoading] = useState(false);
            const [isResetting, setIsResetting] = useState(false);
const [resetEmail, setResetEmail] = useState('');
            
              const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);

    try {
        const email = formData.email?.toLowerCase().trim();
        const password = formData.password;

        // DEMO MODE: Check for hardcoded demo credentials
        if (!isSignup && email === 'demo@clockwork.com' && password === 'demo123') {
            // Simulate demo user login with fake data
            const demoUser = {
                _id: 'demo-user-456',
                name: 'Demo User',
                email: 'demo@clockwork.com',
                roles: ['specialist', 'admin'],
                createdAt: new Date().toISOString()
            };

            const demoToken = 'demo-token-clockwork-' + Date.now();

            localStorage.setItem('token', demoToken);
            localStorage.setItem('user', JSON.stringify(demoUser));

            // Short delay to simulate API call
            await new Promise(resolve => setTimeout(resolve, 500));

            onLogin(demoUser);
            setLoading(false);
            return;
        }

        // NORMAL MODE: Actual API call
        const endpoint = isSignup ? '/auth/register' : '/auth/login';

        // Direct fetch to avoid API_CONFIG wrapper issues
        const response = await fetch(`${API_CONFIG.baseURL}${endpoint}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
    name: formData.name?.trim(),
    email: email,
    password: password,
    roles: ['client']  // Add this line
})
        });

        // Always try to parse JSON response
        let data;
        try {
            data = await response.json();
        } catch (jsonError) {
            // If response isn't JSON, handle gracefully
            data = { message: 'Server response error' };
        }

        // Handle all possible response codes
        if (response.ok) {
            // Success (200-299)
            if (data.token && data.user) {
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                onLogin(data.user);
            } else {
                // Success but missing expected data
                throw new Error('Invalid server response format');
            }
        } else {
            // Error responses (400+)
            const errorMessage = data.message || data.error || `Server error (${response.status})`;

            // User-friendly error messages
            if (response.status === 400 && errorMessage.includes('already exists')) {
                throw new Error('An account with this email already exists. Please login instead.');
            } else if (response.status === 401) {
                throw new Error('Invalid email or password. Please try again.');
            } else if (response.status === 500) {
                throw new Error('Server error. Please try again later.');
            } else {
                throw new Error(errorMessage);
            }
        }
    } catch (error) {
        // Network or parsing errors
        if (error.message === 'Failed to fetch') {
            showError('Cannot connect to server. Please check your connection.');
        } else {
            showError(error.message || 'Authentication failed');
        }
    } finally {
        setLoading(false);
    }
};
      
      const handlePasswordReset = async (e) => {
    e.preventDefault();
    setLoading(true);
    
    const resetCode = e.target.resetCode.value;
    const newPassword = e.target.newPassword.value;
    const confirmPassword = e.target.confirmPassword.value;
    
    if (newPassword !== confirmPassword) {
        showError('Passwords do not match');
        setLoading(false);
        return;
    }
    
    try {
        const response = await fetch(`${API_CONFIG.baseURL}/auth/reset-password/${resetCode}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ password: newPassword })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showError('Password reset successful! Please login with your new password.');
            setIsResetting(false);
            setIsSignup(false);
        } else {
            showError(data.message || 'Invalid or expired reset code');
        }
    } catch (error) {
        showError('Failed to reset password. Please try again.');
    } finally {
        setLoading(false);
    }
};      
           return (
<div className="min-h-screen bg-gray-900 flex items-center justify-center p-4">
        {/* Phoenix of Tesla Watermark - Moving Background */}
        <div className="phoenix-watermark">
            <svg viewBox="0 0 100 100">
                <defs>
                    <linearGradient id="phoenix-watermark-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stopColor="#FFD700" stopOpacity="0.6"></stop>
                        <stop offset="50%" stopColor="#FF6B35" stopOpacity="0.8"></stop>
                        <stop offset="100%" stopColor="#FF3300" stopOpacity="0.6"></stop>
                    </linearGradient>
                </defs>
                <path d="M50 70 Q35 55 35 40 Q35 25 50 10 Q65 25 65 40 Q65 55 50 70Z" 
                      fill="url(#phoenix-watermark-gradient)"></path>
                <path d="M35 40 Q15 35 10 45 Q15 50 25 48 Q30 45 35 40" 
                      fill="url(#phoenix-watermark-gradient)" opacity="0.7"></path>
                <path d="M65 40 Q70 45 75 48 Q85 50 90 45 Q85 35 65 40" 
                      fill="url(#phoenix-watermark-gradient)" opacity="0.7"></path>
                <circle cx="46" cy="35" r="1.5" fill="#FFFFFF"></circle>
            </svg>
        </div>
        
        <div className="dark-card p-8 w-full max-w-md bg-gray-800">
                        <div className="text-center mb-6">
<div className="relative inline-block mb-4">
    <div className="relative h-24 w-24">
        {/* Animated flame background */}
        <div className="absolute inset-0 animate-pulse">
            <div className="absolute inset-0 bg-gradient-to-t from-yellow-500 via-orange-500 to-red-500 opacity-30 blur-xl animate-spin-slow"></div>
        </div>
        
        {/* Main Phoenix */}
        <svg viewBox="0 0 100 100" className="relative z-10 h-full w-full animate-float">
            {/* Phoenix body */}
            <path d="M50 70 Q35 55 35 40 Q35 25 50 10 Q65 25 65 40 Q65 55 50 70Z" 
                  fill="url(#phoenix-body)"
                  filter="url(#glow)"/>
            
            {/* Left wing */}
            <path d="M35 40 Q15 35 10 45 Q15 50 25 48 Q30 45 35 40" 
                  fill="url(#wing-gradient)"
                  className="animate-wing-left origin-center"/>
            
            {/* Right wing */}
            <path d="M65 40 Q70 45 75 48 Q85 50 90 45 Q85 35 65 40" 
                  fill="url(#wing-gradient)"
                  className="animate-wing-right origin-center"/>
            
            {/* Flame feathers */}
            <path d="M50 10 Q48 5 50 0 Q52 5 50 10" fill="#fbbf24" className="animate-flicker"/>
            <path d="M45 12 Q43 8 42 5 Q44 8 45 12" fill="#f97316" className="animate-flicker-delay-1"/>
            <path d="M55 12 Q56 8 58 5 Q57 8 55 12" fill="#f97316" className="animate-flicker-delay-2"/>
            
            {/* Eye */}
            <circle cx="46" cy="35" r="2" fill="#fff" className="animate-pulse"/>
            
            {/* Tail feathers */}
            <path d="M50 70 Q45 75 40 80 Q45 77 50 70" fill="#ef4444" className="animate-flicker"/>
            <path d="M50 70 Q55 75 60 80 Q55 77 50 70" fill="#ef4444" className="animate-flicker-delay-1"/>
            
            <defs>
                <linearGradient id="phoenix-body" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" stopColor="#fbbf24">
                        <animate attributeName="stop-color" values="#fbbf24;#f97316;#ef4444;#fbbf24" dur="3s" repeatCount="indefinite"/>
                    </stop>
                    <stop offset="50%" stopColor="#f97316"/>
                    <stop offset="100%" stopColor="#ef4444">
                        <animate attributeName="stop-color" values="#ef4444;#fbbf24;#f97316;#ef4444" dur="3s" repeatCount="indefinite"/>
                    </stop>
                </linearGradient>
                
                <linearGradient id="wing-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stopColor="#fbbf24" stopOpacity="0.8"/>
                    <stop offset="100%" stopColor="#ef4444" stopOpacity="0.3"/>
                </linearGradient>
                
                <filter id="glow">
                    <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                    <feMerge>
                        <feMergeNode in="coloredBlur"/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
            </defs>
        </svg>
        
        {/* Floating sparks */}
        <div className="absolute inset-0">
            <div className="spark-1 absolute h-1 w-1 bg-yellow-400 rounded-full animate-spark-float-1"></div>
            <div className="spark-2 absolute h-1 w-1 bg-orange-400 rounded-full animate-spark-float-2"></div>
            <div className="spark-3 absolute h-1 w-1 bg-red-400 rounded-full animate-spark-float-3"></div>
        </div>
    </div>
</div>
    <h1 className="text-3xl font-bold text-white">CLOCKWORK</h1>
    <p className="text-gray-400 text-sm uppercase tracking-wider">Universal Health Management Platform</p>
</div>
                        
                        {!isResetting && (
                        <>
                        <div className="flex mb-6">
    <button
        onClick={() => setIsSignup(false)}
        className={`flex-1 py-2 ${!isSignup ? 'bg-blue-500 text-white' : 'bg-gray-600 text-gray-200'} rounded-l`}
    >
        Login
    </button>
    <button
        onClick={() => setIsSignup(true)}
        className={`flex-1 py-2 ${isSignup ? 'bg-blue-500 text-white' : 'bg-gray-600 text-gray-200'} rounded-r`}
    >
        Sign Up
    </button>
</div>

{!isSignup && (
<div style={{background: 'linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%)', padding: '1rem', borderRadius: '8px', marginBottom: '1rem', border: '2px dashed #3b82f6'}}>
    <p style={{fontSize: '0.75rem', fontWeight: '600', color: '#1e40af', marginBottom: '0.5rem', textAlign: 'center'}}>
        üéØ Demo Login Credentials
    </p>
    <div style={{fontSize: '0.75rem', color: '#374151'}}>
        <div style={{marginBottom: '0.25rem'}}>
            <strong style={{color: '#3b82f6'}}>Email:</strong> demo@clockwork.com
        </div>
        <div>
            <strong style={{color: '#3b82f6'}}>Password:</strong> demo123
        </div>
    </div>
    <button
        type="button"
        onClick={() => setFormData({email: 'demo@clockwork.com', password: 'demo123', name: ''})}
        style={{marginTop: '0.5rem', width: '100%', padding: '0.5rem', background: '#3b82f6', color: 'white', borderRadius: '6px', border: 'none', cursor: 'pointer', fontSize: '0.75rem', fontWeight: '600'}}
    >
        Click to Auto-Fill
    </button>
</div>
)}
</>
                    )}
                        <form onSubmit={handleSubmit}>
                          {!isResetting && isSignup && (
                    <div className="mb-4">
                        <label className="block text-sm font-medium mb-2">Name</label>
                        <input
                            type="text"
                            className="coastal-input"
                            value={formData.name}
                            onChange={(e) => setFormData({...formData, name: e.target.value})}
                            required
                        />
                    </div>
                )}
                
                {!isResetting && (
                    <>
                        <div className="mb-4">
                            <label className="block text-sm font-medium mb-2">Email</label>
                            <input
                                type="email"
                                className="coastal-input"
                                value={formData.email}
                                onChange={(e) => setFormData({...formData, email: e.target.value})}
                                required
                            />
                        </div>
                        
                        <div className="mb-6">
                            <label className="block text-sm font-medium mb-2">Password</label>
                            <input
                                type="password"
                                className="coastal-input"
                                value={formData.password}
                                onChange={(e) => setFormData({...formData, password: e.target.value})}
                                required
                            />
                        </div>
                        
                        <button
                            type="submit"
                            className="coastal-button w-full"
                            disabled={loading}
                        >
                            {loading ? 'Please wait...' : (isSignup ? 'Sign Up' : 'Login')}
                        </button>
                    </>
                )}
            </form>
            
            {!isSignup && !isResetting && (
                <div className="text-center mt-4">
                    <a 
                        href="#"
                        onClick={async (e) => {
                            e.preventDefault();
                            const email = prompt('Enter your email address:');
                            if (email) {
                                try {
                                    await API_CONFIG.request('/auth/reset-password', {
                                        method: 'POST',
                                        body: JSON.stringify({ email })
                                    });
                                    alert('Password reset code sent to ' + email);
                                    setResetEmail(email);
                                    setIsResetting(true);
                                } catch (error) {
                                    showError('Failed to send reset email. Please try again.');
                                }
                            }
                        }}
                        className="text-sm text-blue-600 hover:text-blue-800"
                    >
                        Forgot your password?
                    </a>
                </div>
            )}
            
            {isResetting && (
                <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                    <h3 className="text-lg font-semibold mb-3">Reset Password</h3>
                    <p className="text-sm text-gray-400 mb-3">
                        Enter the 6-digit code sent to {resetEmail || 'your email'}
                    </p>
                    <form onSubmit={handlePasswordReset}>
                        <div className="mb-3">
                            <input
                                type="text"
                                name="resetCode"
                                className="coastal-input text-center text-2xl tracking-wider"
                                placeholder="000000"
                                maxLength="3"
                                pattern="[0-9]{6}"
                                required
                            />
                        </div>
                        <div className="mb-3">
                            <input
                                type="password"
                                name="newPassword"
                                className="coastal-input"
                                placeholder="New password"
                                required
                            />
                        </div>
                        <div className="mb-3">
                            <input
                                type="password"
                                name="confirmPassword"
                                className="coastal-input"
                                placeholder="Confirm new password"
                                required
                            />
                        </div>
                        <div className="flex gap-2">
                            <button
                                type="submit"
                                className="coastal-button flex-1"
                                disabled={loading}
                            >
                                {loading ? 'Resetting...' : 'Reset Password'}
                            </button>
                            <button
                                type="button"
                                onClick={() => setIsResetting(false)}
                                className="coastal-button bg-gray-600 flex-1"
                            >
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            )}
        </div>
    </div>
);
};
       // Goals & Habits Component (Combined)
const Goals = ({ user, isClient, showError, showSuccess }) => {
    const [goals, setGoals] = useState([]);
    const [habits, setHabits] = useState([]);
    const [selectedClient, setSelectedClient] = useState(isClient ? user._id : null);
    const [clients, setClients] = useState([]);
    const [showForm, setShowForm] = useState(false);
    const [formType, setFormType] = useState('goal'); // 'goal' or 'habit'
    const [editingItem, setEditingItem] = useState(null);
    const [formData, setFormData] = useState({
        name: '',
        target: '',
        current: 0,
        startingValue: 0,
        deadline: new Date().toISOString().split('T')[0],
        scheduledDays: [],
        progressHistory: []
    });
    const daysOfWeek = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    
useEffect(() => {
    // Only fetch if user exists and token is present
    if (user && localStorage.getItem('token')) {
        if (!isClient && (user.roles?.includes('specialist') || user.roles?.includes('admin') || user.roles?.includes('owner'))) {
            fetchClients();
        }
        if (selectedClient) {
            fetchGoals();
        }
    }
}, [selectedClient, isClient, user]);
    
    const fetchClients = async () => {
    const clients = await ClientManager.loadClients();
    setClients(clients);
};
    
    const fetchGoals = async () => {
        try {
            const data = await API_CONFIG.request(`/goals/client/${selectedClient}`);
            const allData = Array.isArray(data) ? data : (data.data || []);
            // Separate goals and habits
            setGoals(allData.filter(item => !item.isHabit));
            setHabits(allData.filter(item => item.isHabit));
        } catch (error) {
            console.error('Error fetching goals:', error);
        }
    };
    
    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            const method = editingItem ? 'PUT' : 'POST';
            const endpoint = editingItem 
                ? `/goals/${editingItem}`
                : `/goals/client/${selectedClient}`;
            
            // Prepare submit data
            let submitData;
            if (formType === 'habit') {
                submitData = {
                    ...formData,
                    target: 1,
                    current: 0,
                    startingValue: 0,
                    isHabit: true,
                    scheduledDays: formData.scheduledDays
                };
            } else {
                // For goals, ensure startingValue is set
submitData = {
    ...formData,
    deadline: DateHandler.toDatabase(formData.deadline),
    scheduledDays: [],
    isHabit: false,
    startingValue: parseFloat(formData.startingValue) || parseFloat(formData.current) || 0,
    current: parseFloat(formData.current) || 0,
    target: parseFloat(formData.target)
};
            }
            
            await API_CONFIG.request(endpoint, {
                method,
                body: JSON.stringify(submitData)
            });
            
            showSuccess(editingItem ? 'Updated successfully' : 'Created successfully');
            resetForm();
            fetchGoals();
        } catch (error) {
            showError(error.message);
        }
    };
    
    const resetForm = () => {
        setShowForm(false);
        setEditingItem(null);
        setFormData({
            name: '',
            target: '',
            current: 0,
            startingValue: 0,
            deadline: DateHandler.getCurrentETDate(),
            scheduledDays: [],
            progressHistory: []
        });
    };
    
    const updateProgress = async (goalId) => {
        const goal = goals.find(g => g._id === goalId);
        const newValue = prompt(`Update progress for "${goal.name}" (current: ${goal.current}/${goal.target}):`);
        
        if (newValue !== null && !isNaN(newValue)) {
            try {
                const updatedGoal = {
                    ...goal,
                    current: parseFloat(newValue),
                    progressHistory: [
                        ...(goal.progressHistory || []),
                        {
                            date: new Date(),
                            value: parseFloat(newValue),
                            notes: ''
                        }
                    ]
                };
                
                await API_CONFIG.request(`/goals/${goalId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updatedGoal)
                });
                
                showSuccess('Progress updated successfully');
                fetchGoals();
            } catch (error) {
                showError(error.message);
            }
        }
    };
    
    const toggleHabit = async (habitId, date) => {
        try {
            const habit = habits.find(h => h._id === habitId);
            const dateKey = new Date(date).toDateString();
            const completions = habit.completions || {};
            
            completions[dateKey] = !completions[dateKey];
            
            await API_CONFIG.request(`/goals/${habitId}`, {
                method: 'PUT',
                body: JSON.stringify({ completions })
            });
            
            showSuccess('Habit updated');
            fetchGoals();
        } catch (error) {
            showError(error.message);
        }
    };
    
    const deleteItem = async (itemId) => {
        if (confirm('Are you sure you want to delete this?')) {
            try {
                await API_CONFIG.request(`/goals/${itemId}`, {
                    method: 'DELETE'
                });
                showSuccess('Deleted successfully');
                fetchGoals();
            } catch (error) {
                showError(error.message);
            }
        }
    };
    
    const calculateProgress = (current, target, startingValue) => {
        if (!target && target !== 0) return 0;
        
        // If we have a starting value and it's a decrease goal
        if (startingValue && startingValue > target) {
            const totalDecrease = startingValue - target;
            const currentDecrease = startingValue - current;
            const progress = Math.round((currentDecrease / totalDecrease) * 100);
            return Math.min(Math.max(0, progress), 100);
        }
        
        // For increase goals
        if (target === 0) return 0;
        return Math.min(Math.round((current / target) * 100), 100);
    };
    
    const getDaysRemaining = (deadline) => {
        const today = new Date();
        const deadlineDate = new Date(deadline);
        const timeDiff = deadlineDate - today;
        const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
        return daysDiff;
    };
    
    const toggleDay = (day) => {
        if (formData.scheduledDays.includes(day)) {
            setFormData({
                ...formData,
                scheduledDays: formData.scheduledDays.filter(d => d !== day)
            });
        } else {
            setFormData({
                ...formData,
                scheduledDays: [...formData.scheduledDays, day]
            });
        }
    };
    
    const getWeekDates = () => {
        const today = new Date();
        const currentDay = today.getDay();
        const monday = new Date(today);
        monday.setDate(today.getDate() - (currentDay === 0 ? 6 : currentDay - 1));
        
        return daysOfWeek.map((day, index) => {
            const date = new Date(monday);
            date.setDate(monday.getDate() + index);
            return { day, date };
        });
    };
    
    const weekDates = getWeekDates();
    
    return (
        <div className="space-y-6">
            <div className="dark-card p-6">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-bold text-white">
                        {isClient ? 'My Goals & Habits' : 'Goals & Habits'}
                    </h2>
                    {!isClient && selectedClient && (
                        <div className="flex gap-2">
                            <button onClick={() => { setFormType('goal'); setShowForm(true); }} className="coastal-button">
                                <i className="fas fa-bullseye mr-2"></i>
                                Add Goal
                            </button>
                            <button onClick={() => { setFormType('habit'); setShowForm(true); }} className="coastal-button bg-green-600">
                                <i className="fas fa-check mr-2"></i>
                                Add Habit
                            </button>
                        </div>
                    )}
                </div>
                
                {!isClient && (
                    <select
                        className="coastal-input"
                        value={selectedClient || ''}
                        onChange={(e) => setSelectedClient(e.target.value)}
                    >
                        <option value="">Select a client...</option>
                        {clients.map(client => (
                            <option key={client._id} value={client._id}>
                                {client.name}
                            </option>
                        ))}
                    </select>
                )}
            </div>
            
            {showForm && (
                <div className="dark-card p-6">
                    <h3 className="text-xl font-semibold mb-4">
                        {editingItem ? 'Edit' : 'Create'} {formType === 'goal' ? 'Goal' : 'Habit'}
                    </h3>
                    <form onSubmit={handleSubmit}>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-2">
                                    {formType === 'goal' ? 'Goal Name' : 'Habit Name'}
                                </label>
                                <input
                                    type="text"
                                    className="coastal-input"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    placeholder={formType === 'goal' ? "e.g., Lose 10 pounds" : "e.g., Drink 8 glasses of water"}
                                    required
                                />
                            </div>
                            
                            {formType === 'goal' ? (
                                <>
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Target Value</label>
                                            <input
                                                type="number"
                                                step="0.1"
                                                className="coastal-input"
                                                value={formData.target}
                                                onChange={(e) => setFormData({...formData, target: e.target.value})}
                                                placeholder="e.g., 10"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Current Value</label>
                                            <input
                                                type="number"
                                                step="0.1"
                                                className="coastal-input"
                                                value={formData.current}
                                                onChange={(e) => setFormData({...formData, current: e.target.value})}
                                                placeholder="e.g., 0"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Starting Value</label>
                                            <input
                                                type="number"
                                                step="0.1"
                                                className="coastal-input"
                                                value={formData.startingValue}
                                                onChange={(e) => setFormData({...formData, startingValue: e.target.value})}
                                                placeholder="e.g., 20"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Target Date</label>
                                            <input
                                                type="date"
                                                className="coastal-input"
                                                value={formData.deadline}
                                                onChange={(e) => setFormData({...formData, deadline: e.target.value})}
                                                required
                                            />
                                        </div>
                                    </div>
                                </>
                            ) : (
                                <div>
                                    <label className="block text-sm font-medium mb-2">Scheduled Days</label>
                                    <div className="flex flex-wrap gap-2">
                                        {daysOfWeek.map(day => (
                                            <label 
                                                key={day}
                                                className={`flex items-center px-3 py-2 rounded cursor-pointer ${
                                                    formData.scheduledDays.includes(day) 
                                                        ? 'bg-blue-500 text-white' 
                                                       : 'bg-gray-700 hover:bg-gray-600 text-gray-300'
                                                }`}
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={formData.scheduledDays.includes(day)}
                                                    onChange={() => toggleDay(day)}
                                                    className="sr-only"
                                                />
                                                {day}
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <div className="flex gap-4 mt-6">
                            <button type="submit" className="coastal-button">
                                {editingItem ? 'Update' : 'Create'} {formType === 'goal' ? 'Goal' : 'Habit'}
                            </button>
                            <button type="button" onClick={resetForm} className="coastal-button bg-gray-600 hover:bg-gray-700">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            )}
            
            {selectedClient && habits.length > 0 && (
                <div className="dark-card p-6">
                    <h3 className="text-lg font-semibold mb-4">Daily Habits</h3>
                    <div className="overflow-x-auto">
                        <table className="w-full">
                            <thead>
                                <tr>
                                    <th className="text-left p-2">Habit</th>
                                    {weekDates.map(({ day, date }) => (
                                        <th key={day} className="text-center p-2 min-w-[60px]">
                                            <div>{day}</div>
                                            <div className="text-xs text-gray-500">
                                                {date.getDate()}
                                            </div>
                                        </th>
                                    ))}
                                    {!isClient && <th className="text-right p-2">Actions</th>}
                                </tr>
                            </thead>
                            <tbody>
                                {habits.map(habit => (
                                    <tr key={habit._id} className="border-t">
                                        <td className="p-2 font-medium">{habit.name}</td>
                                        {weekDates.map(({ day, date }) => {
                                            const dateKey = date.toDateString();
                                            const isScheduled = habit.scheduledDays?.includes(day);
                                            const isCompleted = habit.completions?.[dateKey];
                                            const isToday = date.toDateString() === new Date().toDateString();
                                            const isFuture = date > new Date();
                                            
                                            return (
                                                <td key={day} className={`text-center p-2 ${isToday ? 'bg-blue-50' : ''}`}>
                                                    {isScheduled && !isFuture && (
                                                        <input
                                                            type="checkbox"
                                                            className="w-5 h-5 cursor-pointer"
                                                            checked={isCompleted || false}
                                                            onChange={() => toggleHabit(habit._id, date)}
                                                        />
                                                    )}
                                                    {isScheduled && isFuture && (
                                                        <span className="text-gray-300">-</span>
                                                    )}
                                                    {!isScheduled && (
                                                        <span className="text-gray-300">‚Ä¢</span>
                                                    )}
                                                </td>
                                            );
                                        })}
                                        {!isClient && (
                                            <td className="text-right p-2">
                                                <button
                                                    onClick={() => {
                                                        setEditingItem(habit._id);
                                                        setFormType('habit');
                                                        setFormData({
                                                            name: habit.name,
                                                            target: 1,
                                                            current: 0,
                                                            startingValue: 0,
                                                            deadline: habit.deadline || new Date().toISOString().split('T')[0],
                                                            scheduledDays: habit.scheduledDays || [],
                                                            progressHistory: []
                                                        });
                                                        setShowForm(true);
                                                    }}
                                                    className="text-blue-500 hover:text-blue-600 mr-2"
                                                >
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                <button
                                                    onClick={() => deleteItem(habit._id)}
                                                    className="text-red-500 hover:text-red-600"
                                                >
                                                    <i className="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}
            
            {selectedClient && goals.length > 0 && (
                <>
                    <h3 className="text-lg font-semibold">Goals</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {goals.map(goal => {
                            const progress = calculateProgress(goal.current, goal.target, goal.startingValue);
                            const daysRemaining = getDaysRemaining(goal.deadline);
                            const isDecreaseGoal = goal.startingValue > goal.target;
                            
                            return (
                                <div key={goal._id} className="dark-card p-6">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 className="text-lg font-semibold">{goal.name}</h3>
                                            <p className="text-sm text-gray-400">
                                                Progress: {goal.current} / {goal.target}
                                                {isDecreaseGoal && (
                                                    <span className="text-xs text-gray-500 ml-2">
                                                        (from {goal.startingValue})
                                                    </span>
                                                )}
                                            </p>
                                        </div>
                                        <div className="text-right">
                                            {goal.completed ? (
                                                <span className="bg-green-100 text-green-700 px-3 py-1 rounded text-sm text-gray-300">
                                                    ‚úì Complete
                                                </span>
                                            ) : (
                                                <span className={`text-sm ${daysRemaining < 7 ? 'text-red-600' : 'text-gray-400'}`}>
                                                    {daysRemaining > 0 ? `${daysRemaining} days left` : 'Overdue'}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                    
                                    <div className="mb-4">
                                        <div className="progress-bar bg-gray-200" style={{height: '12px'}}>
                                            <div 
                                                className={`progress-bar-fill ${goal.completed ? 'bg-green-500' : 'bg-blue-500'}`}
                                                style={{width: `${progress}%`, height: '100%'}}
                                            ></div>
                                        </div>
                                        <p className="text-sm text-gray-400 mt-1">{progress}% Complete</p>
                                    </div>
                                    
                                    <div className="flex gap-2">
                                        {(isClient || !isClient) && !goal.completed && (
                                            <button
                                                onClick={() => updateProgress(goal._id)}
                                                className="coastal-button text-sm py-1 px-3"
                                            >
                                                Update Progress
                                            </button>
                                        )}
                                        {!isClient && (
                                            <>
                                                <button
                                                    onClick={() => {
                                                        setEditingItem(goal._id);
                                                        setFormType('goal');
                                                        setFormData({
                                                            name: goal.name,
                                                            target: goal.target,
                                                            current: goal.current,
                                                            startingValue: goal.startingValue || 0,
                                                            deadline: goal.deadline.split('T')[0],
                                                            scheduledDays: [],
                                                            progressHistory: goal.progressHistory || []
                                                        });
                                                        setShowForm(true);
                                                    }}
                                                    className="text-blue-500 hover:text-blue-600"
                                                >
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                <button
                                                    onClick={() => deleteItem(goal._id)}
                                                    className="text-red-500 hover:text-red-600"
                                                >
                                                    <i className="fas fa-trash"></i>
                                                </button>
                                            </>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </>
            )}
            
            {selectedClient && goals.length === 0 && habits.length === 0 && (
                <div className="dark-card p-8 text-center text-gray-500">
                    <p>No goals or habits set up yet.</p>
                    {!isClient && <p className="mt-2">Click "Add Goal" or "Add Habit" to get started.</p>}
                </div>
            )}
        </div>
    );
};
        // Enhanced Dashboard Component - ULTIMATE VERSION
       // ClockWork Intelligence Dashboard
const Dashboard = ({ user, isClient, selectedClientId, onClientChange }) => {
    const [selectedClient, setSelectedClient] = useState(
        selectedClientId || (isClient ? user._id : null)
    );
    const [clients, setClients] = useState([]);
    const [intelligence, setIntelligence] = useState(null);
    const [loading, setLoading] = useState(false);
    const [syncing, setSyncing] = useState(false);
    const [lastSync, setLastSync] = useState(null);
    
    useEffect(() => {
        if (!isClient && (user.roles?.includes('specialist') || user.roles?.includes('admin') || user.roles?.includes('owner'))) {
            fetchClients();
        }
        if (selectedClient) {
            fetchIntelligence();
        }
    }, [selectedClient, isClient]);
    
    const fetchClients = async () => {
        const clients = await ClientManager.loadClients();
        setClients(clients);
    };
    
    const fetchIntelligence = async () => {
        setLoading(true);
        try {
            const data = await API_CONFIG.request(`/intelligence/${selectedClient}`);
            setIntelligence(data);
            setLastSync(new Date());
        } catch (error) {
            console.error('Intelligence fetch error:', error);
        } finally {
            setLoading(false);
        }
    };
    
    const handleSync = async () => {
        setSyncing(true);
        try {
            // Sync wearable first if connected
            const connections = await API_CONFIG.request('/wearables/connections').catch(() => ({connections: []}));
            const connectedDevices = Array.isArray(connections) ? connections : (connections.connections || []);
            
            if (connectedDevices.length > 0) {
                await API_CONFIG.request(`/wearables/sync/${connectedDevices[0].provider}`, {
                    method: 'POST'
                });
            }
            
            // Refresh intelligence
            await fetchIntelligence();
            
            // Success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-check-circle" style="font-size: 24px;"></i>
                    <div>
                        <div style="font-weight: bold;">Sync Complete</div>
                        <div style="font-size: 12px; opacity: 0.9;">Intelligence updated</div>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
            
        } catch (error) {
            console.error('Sync error:', error);
        } finally {
            setSyncing(false);
        }
    };
    
    const ScoreRing = ({ score, label, color, insights }) => {
        const radius = 45;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (score / 100) * circumference;
        
        return (
            <div className="flex flex-col items-center">
                <div className="relative w-32 h-32 mb-3">
                    <svg className="transform -rotate-90 w-32 h-32">
                        <circle
                            cx="64" cy="64" r={radius}
                            stroke="#374151"
                            strokeWidth="8"
                            fill="none"
                        />
                        <circle
                            cx="64" cy="64" r={radius}
                            stroke={color}
                            strokeWidth="8"
                            fill="none"
                            strokeDasharray={circumference}
                            strokeDashoffset={offset}
                            strokeLinecap="round"
                            className="transition-all duration-1000"
                        />
                    </svg>
                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                        <span className="text-3xl font-bold text-white">{score}</span>
                        <span className="text-xs text-gray-400">/ 100</span>
                    </div>
                </div>
                <h4 className="font-semibold text-white mb-2">{label}</h4>
                {insights && insights.length > 0 && (
                    <div className="space-y-1">
                        {insights.slice(0, 2).map((insight, i) => (
                            <div key={i} className="text-xs text-gray-400 flex items-start gap-1">
                                <span className="text-yellow-400">‚ñ∏</span>
                                <span>{insight}</span>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    };
    
    if (loading && !intelligence) {
        return (
            <div className="flex items-center justify-center min-h-screen">
                <div className="loading-spinner"></div>
            </div>
        );
    }
    
    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="dark-card p-6">
                <div className="flex justify-between items-center">
                    <div>
                        <h2 className="text-2xl font-bold text-white flex items-center gap-3">
                            <span className="text-3xl">üß†</span>
                            ClockWork Intelligence
                        </h2>
                        <p className="text-sm text-gray-400 mt-1">
                            AI-powered health insights and performance analytics
                        </p>
                    </div>
                    
                    <div className="flex items-center gap-3">
                        {lastSync && (
                            <span className="text-xs text-gray-500">
                                Last sync: {lastSync.toLocaleTimeString()}
                            </span>
                        )}
                        <button
                            onClick={handleSync}
                            disabled={syncing}
                            className="coastal-button bg-blue-600 hover:bg-blue-700"
                        >
                            <i className={`fas fa-sync mr-2 ${syncing ? 'fa-spin' : ''}`}></i>
                            {syncing ? 'Syncing...' : 'Sync Now'}
                        </button>
                    </div>
                </div>
                
                {!isClient && (
                    <select
                        className="coastal-input mt-4"
                        value={selectedClient || ''}
                        onChange={(e) => setSelectedClient(e.target.value)}
                    >
                        <option value="">Select a client...</option>
                        {clients.map(client => (
                            <option key={client._id} value={client._id}>
                                {client.name}
                            </option>
                        ))}
                    </select>
                )}
            </div>
            
            {intelligence && (
                <>
                    {/* Data Quality Indicators */}
                    <div className="dark-card p-4">
                        <div className="flex items-center justify-between">
                            <span className="text-sm text-gray-400">Data Sources:</span>
                            <div className="flex gap-3">
                                <div className={`flex items-center gap-1 text-xs ${intelligence.dataQuality?.wearable ? 'text-green-400' : 'text-gray-500'}`}>
                                    <i className="fas fa-watch"></i>
                                    Wearable
                                </div>
                                <div className={`flex items-center gap-1 text-xs ${intelligence.dataQuality?.workouts ? 'text-green-400' : 'text-gray-500'}`}>
                                    <i className="fas fa-dumbbell"></i>
                                    Workouts
                                </div>
                                <div className={`flex items-center gap-1 text-xs ${intelligence.dataQuality?.measurements ? 'text-green-400' : 'text-gray-500'}`}>
                                    <i className="fas fa-ruler"></i>
                                    Measurements
                                </div>
                                <div className={`flex items-center gap-1 text-xs ${intelligence.dataQuality?.nutrition ? 'text-green-400' : 'text-gray-500'}`}>
                                    <i className="fas fa-utensils"></i>
                                    Nutrition
                                </div>
                                <div className={`flex items-center gap-1 text-xs ${intelligence.dataQuality?.goals ? 'text-green-400' : 'text-gray-500'}`}>
                                    <i className="fas fa-bullseye"></i>
                                    Goals
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* 4 ClockWork Scores */}
                    <div className="dark-card p-8">
                        <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <span className="text-yellow-400">‚ö°</span>
                            ClockWork Performance Metrics
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                            <ScoreRing
                                score={intelligence.clockworkScores?.recovery?.score || 0}
                                label="Recovery"
                                color="#10b981"
                                insights={intelligence.clockworkScores?.recovery?.insights}
                            />
                            <ScoreRing
                                score={intelligence.clockworkScores?.performance?.score || 0}
                                label="Performance"
                                color="#3b82f6"
                                insights={intelligence.clockworkScores?.performance?.insights}
                            />
                            <ScoreRing
                                score={intelligence.clockworkScores?.wellness?.score || 0}
                                label="Wellness"
                                color="#f59e0b"
                                insights={intelligence.clockworkScores?.wellness?.insights}
                            />
                            <ScoreRing
                                score={intelligence.clockworkScores?.progress?.score || 0}
                                label="Progress"
                                color="#8b5cf6"
                                insights={intelligence.clockworkScores?.progress?.insights}
                            />
                        </div>
                    </div>
                    
                    {/* AI Insights */}
                    {intelligence.insights && (
                        <div className="dark-card p-6">
                            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                <span className="text-2xl">ü§ñ</span>
                                AI-Powered Insights
                            </h3>
                            <div className="bg-gradient-to-br from-blue-900 to-purple-900 bg-opacity-30 rounded-lg p-6 border border-blue-700">
                                <div className="prose prose-invert max-w-none text-gray-300 whitespace-pre-line">
                                    {intelligence.insights}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Key Metrics Grid */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="dark-card p-4">
                            <div className="text-xs text-gray-400 mb-1">Steps Today</div>
                            <div className="text-2xl font-bold text-white">
                                {intelligence.metrics?.steps?.toLocaleString() || 0}
                            </div>
                        </div>
                        <div className="dark-card p-4">
                            <div className="text-xs text-gray-400 mb-1">Sleep Last Night</div>
                            <div className="text-2xl font-bold text-white">
                                {Math.floor((intelligence.metrics?.sleep || 0) / 60)}h {(intelligence.metrics?.sleep || 0) % 60}m
                            </div>
                        </div>
                        <div className="dark-card p-4">
                            <div className="text-xs text-gray-400 mb-1">Workouts This Week</div>
                            <div className="text-2xl font-bold text-white">
                                {intelligence.metrics?.workoutsThisWeek || 0} / {intelligence.metrics?.totalWorkouts || 0}
                            </div>
                        </div>
                        <div className="dark-card p-4">
                            <div className="text-xs text-gray-400 mb-1">Current Weight</div>
                            <div className="text-2xl font-bold text-white">
                                {intelligence.metrics?.weight || '--'} lbs
                            </div>
                        </div>
                    </div>
                    
                    {/* Active Goals */}
                    {intelligence.metrics?.goals && intelligence.metrics.goals.length > 0 && (
                        <div className="dark-card p-6">
                            <h3 className="text-lg font-bold text-white mb-4">üéØ Active Goals</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {intelligence.metrics.goals.map((goal, i) => (
                                    <div key={i} className="bg-gray-800 rounded-lg p-4">
                                        <div className="flex justify-between items-start mb-2">
                                            <span className="font-medium text-white">{goal.name}</span>
                                            <span className="text-sm text-gray-400">{goal.progress}%</span>
                                        </div>
                                        <div className="progress-bar bg-gray-700">
                                            <div 
                                                className="progress-bar-fill bg-green-500"
                                                style={{width: `${goal.progress}%`}}
                                            ></div>
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">
                                            {goal.current} / {goal.target}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </>
            )}
            
            {!intelligence && selectedClient && (
                <div className="dark-card p-12 text-center">
                    <div className="text-6xl mb-4">üß†</div>
                    <h3 className="text-xl font-bold text-white mb-2">No Intelligence Data</h3>
                    <p className="text-gray-400 mb-4">
                        Start tracking workouts, measurements, and connect a wearable to see AI-powered insights.
                    </p>
                    <button onClick={handleSync} className="coastal-button">
                        <i className="fas fa-sync mr-2"></i>
                        Sync Data
                    </button>
                </div>
            )}
        </div>
    );
};
        // Add this at line 1435
        // Workout Session Component - Interactive workout guide
          // Workout Session Component - Interactive workout guide
        const WorkoutSession = ({ workoutId, onClose, showSuccess, showError }) => {
            const [workout, setWorkout] = useState(null);
const [currentExerciseIndex, setCurrentExerciseIndex] = useState(0);
const [currentSet, setCurrentSet] = useState(1);
const [previousWorkoutData, setPreviousWorkoutData] = useState({});
const [currentSessionData, setCurrentSessionData] = useState({});
const [sessionData, setSessionData] = useState({
    startTime: new Date(),
    exerciseData: [],
    totalPainLevel: 0,
    painCount: 0
});
            const [showInstructions, setShowInstructions] = useState(true);
            const [showExerciseDetails, setShowExerciseDetails] = useState(false);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
const [timeRemaining, setTimeRemaining] = useState(0);
const [timerInterval, setTimerInterval] = useState(null);
            
            useEffect(() => {
    fetchWorkoutDetails();
    
    // Cleanup timer on unmount
    return () => {
        if (timerInterval) {
            clearInterval(timerInterval);
        }
    };
}, [workoutId]);

// Add new useEffect for previous data
useEffect(() => {
    if (workout) {
        fetchPreviousWorkoutData();
    }
}, [workout]);
            
          const fetchWorkoutDetails = async () => {
    try {
        // Fetch the specific workout with populated exercise details
        const response = await fetch(`${API_CONFIG.baseURL}/workouts/${workoutId}`, {
            headers: API_CONFIG.getHeaders()
        });
        const data = await response.json();
        const workoutData = data.data || data;
        
        // For each exercise, fetch details from library if needed
        if (workoutData.exercises) {
            const exercisesWithDetails = await Promise.all(
                workoutData.exercises.map(async (exercise) => {
                    // Try to get exercise details from library
                    try {
                        const libResponse = await fetch(`${API_CONFIG.baseURL}/exercises?search=${encodeURIComponent(exercise.name)}`, {
                            headers: API_CONFIG.getHeaders()
                        });
                        const libData = await libResponse.json();
                        const libraryExercise = libData.data?.find(e => e.name.toLowerCase() === exercise.name.toLowerCase());
                        
                        if (libraryExercise) {
                            return {
                                ...exercise,
                                description: libraryExercise.description || exercise.notes,
                                instructions: libraryExercise.instructions || [],
                                tips: libraryExercise.tips || [],
                                commonMistakes: libraryExercise.commonMistakes || [],
                                muscleCategory: libraryExercise.muscleCategory,
                                secondaryMuscles: libraryExercise.secondaryMuscles || [],
                                difficulty: libraryExercise.difficulty,
                                equipmentNeeded: libraryExercise.equipmentNeeded,
                                imageUrl: libraryExercise.imageUrl,
                                videoUrl: exercise.youtubeLink || libraryExercise.videoUrl
                            };
                        }
                    } catch (err) {
                        console.log('Could not fetch library details for', exercise.name);
                    }
                    return exercise;
                })
            );
            workoutData.exercises = exercisesWithDetails;
        }
        
        setWorkout(workoutData);
    } catch (error) {
        showError('Failed to load workout');
        onClose();
    }
};

const fetchPreviousWorkoutData = async () => {
    try {
        // Get client ID more reliably
        let clientId;
        if (workout.clientId && typeof workout.clientId === 'object') {
            clientId = workout.clientId._id;
        } else if (workout.clientId) {
            clientId = workout.clientId;
        } else {
            // Try to get from current user if client
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            if (currentUser.roles?.includes('client')) {
                clientId = currentUser._id;
            }
        }
        
        if (!clientId) {
            console.log('No clientId found, skipping previous data fetch');
            return;
        }
        
        // Get all workouts for this client
        const response = await fetch(`${API_CONFIG.baseURL}/workouts/client/${clientId}`, {
            headers: API_CONFIG.getHeaders()
        });
        
        if (!response.ok) {
            console.log('Failed to fetch previous workouts');
            return;
        }
        
        const data = await response.json();
        const allWorkouts = Array.isArray(data) ? data : (data.data || data);
        
        // Build a map of ALL previous exercise data, not just from same workout name
        const prevData = {};
        
        // Get all completed workouts, sorted by date (newest first)
        const completedWorkouts = allWorkouts
            .filter(w => w.completed && w._id !== workoutId)
            .sort((a, b) => new Date(b.completedAt || b.createdAt) - new Date(a.completedAt || a.createdAt));
        
        // For each exercise in current workout, find its most recent data
        workout.exercises?.forEach(currentExercise => {
            // Normalize the exercise name for matching
            const normalizedName = currentExercise.name.toLowerCase().trim();
            
            // Search through all completed workouts for this exercise
            for (const prevWorkout of completedWorkouts) {
                const matchingExercise = prevWorkout.exercises?.find(e => 
                    e.name.toLowerCase().trim() === normalizedName
                );
                
                if (matchingExercise && !prevData[currentExercise.name]) {
                    prevData[currentExercise.name] = {
                        weight: matchingExercise.weight || 0,
                        reps: matchingExercise.reps || 0,
                        setDetails: matchingExercise.setDetails || [],
                        lastPerformed: prevWorkout.completedAt || prevWorkout.createdAt,
                        fromWorkout: prevWorkout.name
                    };
                    break; // Found the most recent, stop searching
                }
            }
        });
        
        console.log(`Found previous data for ${Object.keys(prevData).length} exercises`);
        setPreviousWorkoutData(prevData);
        
    } catch (error) {
        console.log('Error fetching previous workout data:', error);
        // Don't crash, just continue without previous data
    }
};

const currentExercise = workout?.exercises[currentExerciseIndex];
            const startTimer = (seconds) => {
    setTimeRemaining(seconds);
    setIsTimerRunning(true);
    
    const interval = setInterval(() => {
        setTimeRemaining(prev => {
            if (prev <= 1) {
                clearInterval(interval);
                setIsTimerRunning(false);
                // Play a sound or show completion
                alert('Timer complete! Great job!');
                return 0;
            }
            return prev - 1;
        });
    }, 1000);
    
    setTimerInterval(interval);
};

const stopTimer = () => {
    if (timerInterval) {
        clearInterval(timerInterval);
        setTimerInterval(null);
    }
    setIsTimerRunning(false);
    setTimeRemaining(0);
};
            
    // REPLACE the completeSet function (around line 1500) with this:

const completeSet = () => {
    // Check if this exercise has individual set details
    const targetReps = currentExercise.setDetails?.[currentSet - 1]?.reps || currentExercise.reps;
    const targetWeight = currentExercise.setDetails?.[currentSet - 1]?.weight || currentExercise.weight || 0;
    
    const reps = prompt(`How many reps did you complete? (Target: ${targetReps})`);
    const weight = prompt(`What weight did you use? (Target: ${targetWeight} lbs)`);
    const difficulty = prompt('How difficult was it? (1-5, where 5 is very hard)');
    const painLevel = prompt('Pain level? (0-10, where 0 is no pain)');
    const notes = prompt('Any notes for this set? (optional)');
    
    if (reps && weight) {
        const actualReps = parseInt(reps);
        const actualWeight = parseFloat(weight);
        
        const setData = {
            reps: actualReps,
            weight: actualWeight,
            difficulty: parseInt(difficulty) || 3,
            painLevel: parseInt(painLevel) || 0,
            notes: notes || '',
            timestamp: new Date()
        };
        
        // UPDATE CURRENT SESSION DATA
        setCurrentSessionData(prev => ({
            ...prev,
            [currentExercise.name]: {
                ...prev[currentExercise.name],
                [`set${currentSet}`]: {
                    reps: actualReps,
                    weight: actualWeight
                },
                lastSet: currentSet,
                lastReps: actualReps,
                lastWeight: actualWeight
            }
        }));
        
        // Track in session data WITH EXERCISE NAME
        setSessionData(prev => ({
            ...prev,
            totalPainLevel: prev.totalPainLevel + (parseInt(painLevel) || 0),
            painCount: prev.painCount + 1,
            exerciseData: [...prev.exerciseData, {
                exercise: currentExercise.name,  // CRITICAL: Include exercise name
                set: currentSet,
                ...setData
            }],
            lastCompletedSet: {
                exercise: currentExercise.name,
                set: currentSet,
                reps: actualReps,
                weight: actualWeight
            }
        }));
        
        // Determine next move based on grouping
        const nextExercise = workout.exercises[currentExerciseIndex + 1];
        
        // GROUP-BASED LOGIC
        if (currentExercise.grouping && currentExercise.grouping !== 'none') {
            const currentGroup = currentExercise.grouping;
            
            if (nextExercise && nextExercise.grouping === currentGroup) {
                setCurrentExerciseIndex(currentExerciseIndex + 1);
            } else {
                if (currentSet < currentExercise.sets) {
                    setCurrentSet(currentSet + 1);
                    let firstGroupIndex = currentExerciseIndex;
                    while (firstGroupIndex > 0 && 
                           workout.exercises[firstGroupIndex - 1]?.grouping === currentGroup) {
                        firstGroupIndex--;
                    }
                    setCurrentExerciseIndex(firstGroupIndex);
                } else {
                    moveToNextExercise();
                }
            }
        } else {
            if (currentSet < currentExercise.sets) {
                setCurrentSet(currentSet + 1);
            } else {
                moveToNextExercise();
            }
        }
    }
};

// REPLACE the completeWorkout function (around line 1435) with this ENHANCED version:

const completeWorkout = async () => {
    const duration = Math.round((new Date() - sessionData.startTime) / 60000);
    const avgPainLevel = sessionData.painCount > 0 
        ? (sessionData.totalPainLevel / sessionData.painCount).toFixed(1)
        : 0;
    
    const mood = prompt('Rate your overall workout (1-5):\n1=üòî 2=üòï 3=üòê 4=üôÇ 5=üòÑ');
    const finalNotes = prompt('Any final notes about the workout?');
    
    try {
        // GENIUS FIX: Update the workout WITH the actual performed data
        const updatedExercises = workout.exercises.map((exercise, index) => {
            const exerciseSessionData = sessionData.exerciseData.filter(
                data => data.exercise === exercise.name
            );
            
            // If we have session data for this exercise, update its setDetails
            if (exerciseSessionData.length > 0) {
                const setDetails = exerciseSessionData.map(data => ({
                    reps: data.reps,
                    weight: data.weight
                }));
                
                return {
                    ...exercise,
                    setDetails: setDetails,
                    // Also update the main values with the average/last
                    weight: setDetails[setDetails.length - 1]?.weight || exercise.weight,
                    reps: setDetails[setDetails.length - 1]?.reps || exercise.reps
                };
            }
            
            return exercise;
        });
        
        // First, update the workout with the actual performed data
        await API_CONFIG.request(`/workouts/${workoutId}`, {
            method: 'PUT',
            body: JSON.stringify({
                exercises: updatedExercises,
                completed: true,
                completedAt: new Date(),
                duration,
                moodFeedback: parseInt(mood) || 3,
                notes: finalNotes || '',
                averagePainLevel: parseFloat(avgPainLevel)
            })
        });
        
        // Then mark it as complete
        await API_CONFIG.request(`/workouts/${workoutId}/complete`, {
            method: 'POST',
            body: JSON.stringify({
                duration,
                moodFeedback: parseInt(mood) || 3,
                notes: finalNotes || '',
                averagePainLevel: parseFloat(avgPainLevel),
                sessionData: sessionData.exerciseData
            })
        });
        
        showSuccess(`Workout completed! Great job! üí™ Duration: ${duration} min, Avg Pain Level: ${avgPainLevel}/10`);
        onClose();
    } catch (error) {
        showError('Failed to complete workout');
    }
};

const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
};

if (!workout || !currentExercise) {
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="loading-spinner"></div>
        </div>
    );
}

return (
    <div className="fixed inset-0 bg-gray-900 text-white z-50 overflow-auto">
        <div className="max-w-4xl mx-auto p-4">
            <div className="flex justify-between items-center mb-6">
                <h1 className="text-3xl font-bold">{workout.name}</h1>
                <button onClick={() => {
                    if (confirm('Are you sure you want to exit the workout?')) {
                        onClose();
                    }
                }} className="text-gray-400 hover:text-white">
                    <i className="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div className="mb-8">
                <div className="bg-gray-700 rounded-full h-3">
                    <div 
                        className="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all"
                        style={{width: `${((currentExerciseIndex) / workout.exercises.length) * 100}%`}}
                    ></div>
                </div>
                <p className="text-sm mt-2 text-gray-400">
                    Exercise {currentExerciseIndex + 1} of {workout.exercises.length}
                </p>
            </div>
            
            
            <div className="bg-gray-800 rounded-lg p-6 mb-6">
    <h2 className="text-3xl font-bold mb-2">{currentExercise.name}</h2>
    
    {/* Target and Previous Display */}
<div className="grid grid-cols-2 gap-3 mb-4">
    {/* Target for THIS workout */}
    <div className="bg-yellow-900 bg-opacity-50 p-3 rounded-lg">
        <p className="text-yellow-300 text-sm font-semibold">
            <i className="fas fa-bullseye mr-2"></i>
            Target: {
                currentExercise.setDetails?.[currentSet - 1] 
                    ? `${currentExercise.setDetails[currentSet - 1].reps} reps @ ${currentExercise.setDetails[currentSet - 1].weight} lbs`
                    : `${currentExercise.reps} reps @ ${currentExercise.weight || 0} lbs`
            }
        </p>
    </div>
    
   {/* Current Session Data - Shows what was just completed */}
{currentSessionData[currentExercise.name] && currentSessionData[currentExercise.name].lastSet && (
    <div className="bg-green-900 bg-opacity-50 p-3 rounded-lg mb-2 animate-pulse">
        <p className="text-green-300 text-sm font-semibold">
            <i className="fas fa-check-circle mr-2"></i>
            Just Completed: {currentSessionData[currentExercise.name].lastReps} reps @ {currentSessionData[currentExercise.name].lastWeight} lbs (set {currentSessionData[currentExercise.name].lastSet})
        </p>
    </div>
)}

{/* Historical Data from Previous Workouts */}
<div className="bg-blue-900 bg-opacity-50 p-3 rounded-lg">
    <p className="text-blue-300 text-sm font-semibold">
        <i className="fas fa-history mr-2"></i>
        {previousWorkoutData[currentExercise.name] ? (
            <>
                Last Workout: {
                    previousWorkoutData[currentExercise.name].setDetails?.[currentSet - 1] 
                        ? `${previousWorkoutData[currentExercise.name].setDetails[currentSet - 1].reps} reps @ ${previousWorkoutData[currentExercise.name].setDetails[currentSet - 1].weight} lbs`
                        : `${previousWorkoutData[currentExercise.name].reps} reps @ ${previousWorkoutData[currentExercise.name].weight} lbs`
                }
                {previousWorkoutData[currentExercise.name].lastPerformed && (
                    <span className="text-xs text-blue-400 ml-2">
                        ({new Date(previousWorkoutData[currentExercise.name].lastPerformed).toLocaleDateString()})
                    </span>
                )}
            </>
        ) : (
            'No previous workout data'
        )}
    </p>
</div>
</div>
    
    <div className="flex gap-4 text-gray-400 mb-4">
        <span className="bg-gray-700 px-3 py-1 rounded">
            Set {currentSet} of {currentExercise.sets}
        </span>
        <span className="bg-gray-700 px-3 py-1 rounded">
            {currentExercise.setDetails?.[currentSet - 1]?.reps || currentExercise.reps} reps
        </span>
        {(currentExercise.setDetails?.[currentSet - 1]?.weight > 0 || currentExercise.weight > 0) && (
            <span className="bg-gray-700 px-3 py-1 rounded">
                {currentExercise.setDetails?.[currentSet - 1]?.weight || currentExercise.weight} lbs
            </span>
        )}
    </div>
                
                {currentExercise.notes && (
                    <div className="bg-gray-700 p-4 rounded-lg mb-4">
                        <h4 className="font-semibold text-yellow-400 mb-2">Notes from Specialist</h4>
                        <p className="text-gray-300">{currentExercise.notes}</p>
                    </div>
                )}
                {currentExercise.holdTime && currentExercise.holdTime > 0 && (
                    <div className="bg-purple-900 bg-opacity-50 p-4 rounded-lg mb-4">
                        <h4 className="font-semibold text-purple-300 mb-2">
                            <i className="fas fa-clock mr-2"></i>
                            Hold Time: {currentExercise.holdTime} seconds
                        </h4>
                        {!isTimerRunning ? (
                            <button
                                onClick={() => startTimer(currentExercise.holdTime)}
                                className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded transition"
                            >
                                <i className="fas fa-play mr-2"></i>
                                Start Timer
                            </button>
                        ) : (
                            <div className="text-center">
                                <div className="text-4xl font-bold text-white mb-2">
                                    {Math.floor(timeRemaining / 60)}:{(timeRemaining % 60).toString().padStart(2, '0')}
                                </div>
                                <button
                                    onClick={stopTimer}
                                    className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition"
                                >
                                    <i className="fas fa-stop mr-2"></i>
                                    Stop Timer
                                </button>
                            </div>
                        )}
                    </div>
                )}
                {/* Just Completed Indicator */}
{sessionData.lastCompletedSet && sessionData.lastCompletedSet.exercise === currentExercise.name && (
    <div className="bg-green-900 bg-opacity-50 p-3 rounded-lg mb-4 animate-pulse">
        <p className="text-green-300 text-sm font-semibold">
            <i className="fas fa-check-circle mr-2"></i>
            Just completed: Set {sessionData.lastCompletedSet.set} - {sessionData.lastCompletedSet.reps} reps @ {sessionData.lastCompletedSet.weight} lbs
        </p>
    </div>
)}
                {currentExercise.grouping && currentExercise.grouping !== 'none' && (() => {
    // Count exercises in the same group
    const exercisesInGroup = workout.exercises.filter(e => e.grouping === currentExercise.grouping).length;
    return (
        <div className="bg-purple-900 bg-opacity-50 p-3 rounded-lg mb-4">
            <p className="text-purple-300">
                <i className="fas fa-link mr-2"></i>
                {exercisesInGroup} exercises in Group {currentExercise.grouping}
            </p>
        </div>
    );
})()}
                
                {/* Action Buttons */}
                <div className="flex gap-3">
                    <button
                        onClick={() => setShowExerciseDetails(true)}
                        className="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition"
                    >
                        <i className="fas fa-info-circle"></i>
                        View Details
                    </button>
                    
                    {currentExercise.youtubeLink && (
                        <a 
                            href={currentExercise.youtubeLink}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition"
                        >
                            <i className="fab fa-youtube"></i>
                            Watch Tutorial
                        </a>
                    )}
                </div>
                        
                <button 
                    onClick={completeSet}
                    className="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-lg text-xl font-bold transition"
                >
                    Complete Set {currentSet}
                </button>
                        
                        <div className="grid grid-cols-3 gap-4 mt-6">
                            <div className="bg-gray-800 rounded-lg p-4 text-center">
                                <p className="text-gray-400 text-sm">Duration</p>
                                <p className="text-xl font-bold">
                                    {Math.round((new Date() - sessionData.startTime) / 60000)} min
                                </p>
                            </div>
                            <div className="bg-gray-800 rounded-lg p-4 text-center">
                                <p className="text-gray-400 text-sm">Avg Pain</p>
                                <p className="text-xl font-bold">
                                    {sessionData.painCount > 0 
                                        ? (sessionData.totalPainLevel / sessionData.painCount).toFixed(1)
                                        : '0'}/10
                                </p>
                            </div>
                            <div className="bg-gray-800 rounded-lg p-4 text-center">
                                <p className="text-gray-400 text-sm">Sets Done</p>
                                <p className="text-xl font-bold">{sessionData.exerciseData.length}</p>
                            </div>
                        </div>
                    </div>
                        {/* Exercise Details Modal */}
                        {showExerciseDetails && currentExercise && (
                            <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" onClick={() => setShowExerciseDetails(false)}>
                                <div className="bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6" onClick={(e) => e.stopPropagation()}>
                                    <div className="flex justify-between items-start mb-4">
                                        <h2 className="text-2xl font-bold text-white">{currentExercise.name}</h2>
                                        <button
                                            onClick={() => setShowExerciseDetails(false)}
                                            className="text-gray-400 hover:text-white"
                                        >
                                            <i className="fas fa-times text-xl"></i>
                                        </button>
                                    </div>
                                    
                                    {currentExercise.imageUrl && (
                                        <img 
                                            src={currentExercise.imageUrl} 
                                            alt={currentExercise.name}
                                            className="w-full max-h-64 object-contain rounded mb-4"
                                        />
                                    )}
                                    
                                    <div className="space-y-4 text-gray-300">
                                        <div className="grid grid-cols-2 gap-4 mb-4">
                                            {currentExercise.muscleCategory && (
                                                <div>
                                                    <h3 className="font-semibold text-yellow-400 mb-1">Primary Muscle</h3>
                                                    <p className="text-white">{currentExercise.muscleCategory}</p>
                                                </div>
                                            )}
                                            
                                            {currentExercise.difficulty && (
                                                <div>
                                                    <h3 className="font-semibold text-yellow-400 mb-1">Difficulty</h3>
                                                    <p className="text-white capitalize">{currentExercise.difficulty}</p>
                                                </div>
                                            )}
                                            
                                            {currentExercise.equipmentNeeded && (
                                                <div>
                                                    <h3 className="font-semibold text-yellow-400 mb-1">Equipment</h3>
                                                    <p className="text-white">{currentExercise.equipmentNeeded}</p>
                                                </div>
                                            )}
                                            
                                            {currentExercise.secondaryMuscles && currentExercise.secondaryMuscles.length > 0 && (
                                                <div>
                                                    <h3 className="font-semibold text-yellow-400 mb-1">Secondary Muscles</h3>
                                                    <p className="text-white">{currentExercise.secondaryMuscles.join(', ')}</p>
                                                </div>
                                            )}
                                        </div>
                                        
                                        {currentExercise.description && (
                                            <div className="bg-gray-700 p-4 rounded-lg">
                                                <h3 className="font-semibold text-yellow-400 mb-2">Description</h3>
                                                <p className="text-white">{currentExercise.description}</p>
                                            </div>
                                        )}
                                        
                                        {currentExercise.instructions && currentExercise.instructions.length > 0 && (
                                            <div className="bg-gray-700 p-4 rounded-lg">
                                                <h3 className="font-semibold text-yellow-400 mb-2">Step-by-Step Instructions</h3>
                                                <ol className="list-decimal list-inside space-y-2 text-white">
                                                    {currentExercise.instructions.filter(i => i).map((instruction, index) => (
                                                        <li key={index}>{instruction}</li>
                                                    ))}
                                                </ol>
                                            </div>
                                        )}
                                        
                                        {currentExercise.tips && currentExercise.tips.length > 0 && (
                                            <div className="bg-green-900 bg-opacity-50 p-4 rounded-lg">
                                                <h3 className="font-semibold text-green-400 mb-2">
                                                    <i className="fas fa-lightbulb mr-2"></i>Pro Tips
                                                </h3>
                                                <ul className="list-disc list-inside space-y-1 text-white">
                                                    {currentExercise.tips.filter(t => t).map((tip, index) => (
                                                        <li key={index}>{tip}</li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}
                                        
                                        {currentExercise.commonMistakes && currentExercise.commonMistakes.length > 0 && (
                                            <div className="bg-red-900 bg-opacity-50 p-4 rounded-lg">
                                                <h3 className="font-semibold text-red-400 mb-2">
                                                    <i className="fas fa-exclamation-triangle mr-2"></i>Common Mistakes to Avoid
                                                </h3>
                                                <ul className="list-disc list-inside space-y-1 text-white">
                                                    {currentExercise.commonMistakes.filter(m => m).map((mistake, index) => (
                                                        <li key={index}>{mistake}</li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}
                                        
                                        {currentExercise.youtubeLink && (
                                            <div className="mt-4">
                                                <a 
                                                    href={currentExercise.youtubeLink}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition"
                                                >
                                                    <i className="fab fa-youtube"></i>
                                                    Watch Video Tutorial
                                                </a>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
  
        
        // Enhanced Workouts Component
        const Workouts = ({ user, isClient, showError, showSuccess }) => {
            const [workouts, setWorkouts] = useState([]);
            const [selectedClient, setSelectedClient] = useState(isClient ? user._id : null);
            const [clients, setClients] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [formData, setFormData] = useState({
    name: '',
 scheduledDate: new Date().toISOString().split('T')[0], // This was using DateHandler.getCurrentETDate()
    exercises: [],
    youtubeLink: ''
});
              const [editingWorkout, setEditingWorkout] = useState(null);
            const [activeSession, setActiveSession] = useState(null);
            
  // Exercise Library Search States
const [showExerciseSearch, setShowExerciseSearch] = useState(false);
const [exerciseSearchTerm, setExerciseSearchTerm] = useState('');
const [libraryExercises, setLibraryExercises] = useState([]);
const [filteredLibraryExercises, setFilteredLibraryExercises] = useState([]);

const uploadToCloudinary = async (file) => {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', 'ml_default');
    
    try {
        const response = await fetch(
            'https://api.cloudinary.com/v1_1/dgpt2oxmi/image/upload',
            {
                method: 'POST',
                body: formData
            }
        );
        const data = await response.json();
        return data.secure_url;
    } catch (error) {
        console.error('Upload failed:', error);
        return null;
    }
};

const fetchLibraryExercises = async () => {
    try {
        const data = await API_CONFIG.request('/exercises');
        console.log('Library exercises fetched:', data); // Debug log
        const exercisesArray = Array.isArray(data) ? data : (data.data || []);
        console.log('Processed exercises:', exercisesArray); // Debug log
        setLibraryExercises(exercisesArray);
    } catch (error) {
        console.error('Error fetching library exercises:', error);
        setLibraryExercises([]);
    }
};
            useEffect(() => {
    if (!isClient && (user.roles?.includes('specialist') || user.roles?.includes('admin') || user.roles?.includes('owner'))) {
        fetchClients();
    }
    if (selectedClient) {
        fetchWorkouts();
    }
}, [selectedClient, isClient]);

// Fetch library exercises when component mounts
useEffect(() => {
    if (!isClient) {
        fetchLibraryExercises();
    }
}, [isClient]);

// Filter exercises based on search term
useEffect(() => {
    console.log('Search term changed:', exerciseSearchTerm); // Debug log
    console.log('Available exercises:', libraryExercises.length); // Debug log
    
    if (exerciseSearchTerm.trim() === '') {
        setFilteredLibraryExercises([]);
    } else {
        const searchLower = exerciseSearchTerm.toLowerCase();
        const filtered = libraryExercises.filter(exercise => 
            exercise.name?.toLowerCase().includes(searchLower) ||
            exercise.muscleCategory?.toLowerCase().includes(searchLower) ||
            exercise.equipmentNeeded?.toLowerCase().includes(searchLower) ||
            exercise.difficulty?.toLowerCase().includes(searchLower) ||
            exercise.tags?.some(tag => tag.toLowerCase().includes(searchLower))
        );
        console.log('Filtered results:', filtered.length); // Debug log
        setFilteredLibraryExercises(filtered);
    }
}, [exerciseSearchTerm, libraryExercises]);
            const fetchClients = async () => {
    const clients = await ClientManager.loadClients();
    setClients(clients);
};
            

const fetchWorkouts = async () => {
    try {
        console.log('Fetching workouts for client:', selectedClient);
const response = await API_CONFIG.request(`/workouts/client/${selectedClient}`);
        console.log('Raw response:', response);
        console.log('Response type:', typeof response);
        console.log('Is array?:', Array.isArray(response));
        
       const workoutsArray = Array.isArray(response) ? response : (response.data || []);
        setWorkouts(workoutsArray);
    } catch (error) {
        console.error('Error fetching workouts:', error);
        setWorkouts([]);
    }
};
            
            const handleSubmit = async (e) => {
    e.preventDefault();
    try {
        const method = editingWorkout ? 'PUT' : 'POST';
        const endpoint = editingWorkout 
            ? `/workouts/client/${selectedClient}/${editingWorkout}`
            : `/workouts/client/${selectedClient}`;
        
        await API_CONFIG.request(endpoint, {
            method,
            body: JSON.stringify({
                ...formData,
                clientId: selectedClient,  
                createdBy: user._id,     
                scheduledDate: formData.scheduledDate || undefined,
                youtubeLink: formData.youtubeLink || ''  // <-- This line was missing a comma or had an issue
            })
        });
    
        
        showSuccess(editingWorkout ? 'Workout updated successfully' : 'Workout created successfully');
        setShowForm(false);
        setEditingWorkout(null);
        fetchWorkouts();
        setFormData({
    name: '',
    scheduledDate: new Date().toISOString().split('T')[0], // Direct date formatting
    exercises: [],
    youtubeLink: ''
});
    } catch (error) {
        showError(error.message);
    }
};
        
       
            
            const handleComplete = async (workoutId) => {
                const mood = prompt('Rate your workout (1-5):\n1 = Poor\n2 = Below Average\n3 = Average\n4 = Good\n5 = Excellent');
                if (!mood || mood < 1 || mood > 5) {
                    showError('Please enter a mood rating between 1-5');
                    return;
                }
                
                const notes = prompt('Any notes about the workout? (optional)');
                
                try {
                    await API_CONFIG.request(`/workouts/client/${selectedClient}/${workoutId}/complete`, {
                        method: 'POST',
                        body: JSON.stringify({ 
                            moodFeedback: parseInt(mood),
                            notes: notes || ''
                        })
                    });
                    showSuccess('Workout completed!');
                    fetchWorkouts();
                } catch (error) {
                    showError(error.message);
                }
            };
            const handleDelete = async (workoutId) => {
    if (confirm('Are you sure you want to delete this workout?')) {
        try {
            // Try the client-specific delete endpoint first
            await API_CONFIG.request(`/workouts/client/${selectedClient}/${workoutId}`, {
                method: 'DELETE'
            });
            showSuccess('Workout deleted successfully');
            fetchWorkouts();
            setShowForm(false);
            setEditingWorkout(null);
            // Reset form data
            setFormData({
    name: '',
    scheduledDate: new Date().toISOString().split('T')[0],
    exercises: [],
    youtubeLink: ''
});
        } catch (error) {
            // If that fails, try the general delete endpoint
            try {
                await API_CONFIG.request(`/workouts/${workoutId}`, {
                    method: 'DELETE'
                });
                showSuccess('Workout deleted successfully');
                fetchWorkouts();
                setShowForm(false);
                setEditingWorkout(null);
                setFormData({
                    name: '',
                    scheduledDate: DateHandler.getCurrentETDate(),
                    exercises: [],
                    youtubeLink: ''
                });
            } catch (secondError) {
                showError('Delete functionality not available. Contact your administrator.');
                console.error('Delete error:', secondError);
            }
        }
    }
};
      const addExerciseFromLibrary = (exercise) => {
    setFormData({
        ...formData,
        exercises: [...formData.exercises, {
            name: exercise.name,
            sets: 3,
            reps: 10,
            weight: 0,
            notes: exercise.description || '',
            grouping: 'none',
            youtubeLink: exercise.videoUrl || ''
        }]
    });
    setShowExerciseSearch(false);
    setExerciseSearchTerm('');
    setFilteredLibraryExercises([]);
    showSuccess(`Added "${exercise.name}" to workout`);
};
const addExercise = () => {
    // Check if an exercise was selected from library
    if (window.selectedExerciseFromLibrary) {
        const libraryExercise = window.selectedExerciseFromLibrary;
        setFormData({
            ...formData,
            exercises: [...formData.exercises, {
                name: libraryExercise.name,
                sets: 3,
                reps: 10,
                weight: 0,
                notes: libraryExercise.description,
                grouping: 'none' // 'none', 'superset', 'triset'
            }]
        });
        // Clear the selected exercise
        window.selectedExerciseFromLibrary = null;
        showSuccess(`Added "${libraryExercise.name}" from library`);
    } else {
        // Default empty exercise
        setFormData({
            ...formData,
            exercises: [...formData.exercises, {
                name: '',
                sets: 3,
                reps: 10,
                weight: 0,
                notes: '',
                grouping: 'none' // 'none', 'superset', 'triset'
            }]
        });
    }
};

const groupExercises = (indices, groupType) => {
    const groupId = Date.now(); // Simple unique ID
    const updatedExercises = [...formData.exercises];
    indices.forEach(index => {
        updatedExercises[index].groupId = groupId;
        updatedExercises[index].groupType = groupType;
    });
    setFormData({...formData, exercises: updatedExercises});
};

const ungroupExercise = (index) => {
    const updatedExercises = [...formData.exercises];
    updatedExercises[index].groupId = null;
    updatedExercises[index].groupType = null;
    setFormData({...formData, exercises: updatedExercises});
};
            
            const updateExercise = (index, field, value) => {
                const exercises = [...formData.exercises];
                exercises[index][field] = value;
                setFormData({...formData, exercises});
            };
            
            const removeExercise = (index) => {
                setFormData({
                    ...formData,
                    exercises: formData.exercises.filter((_, i) => i !== index)
                });
            };
            
            const renderStars = (rating) => {
                return (
                    <div className="star-rating">
                        {[1, 2, 3, 4, 5].map(star => (
                            <span key={star} className={`star ${star <= rating ? '' : 'empty'}`}>
                                ‚òÖ
                            </span>
                        ))}
                    </div>
                );
            };
            
            return (
                <div className="space-y-6">
                    <div className="dark-card p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold text-white">
                                {isClient ? 'My Workouts' : 'Workouts'}
                            </h2>
                            {!isClient && selectedClient && (
                                <button onClick={() => setShowForm(true)} className="coastal-button">
                                    <i className="fas fa-plus mr-2"></i>
                                    Add Workout
                                </button>
                            )}
                        </div>
                        
                        {!isClient && (
                            <select
                                className="coastal-input"
                                value={selectedClient || ''}
                                onChange={(e) => setSelectedClient(e.target.value)}
                            >
                                <option value="">Select a client...</option>
                                {clients.map(client => (
                                    <option key={client._id} value={client._id}>
                                        {client.name}
                                    </option>
                                ))}
                            </select>
                        )}
                    </div>
                    
                    {showForm && (
                        <div className="dark-card p-6">
                            <h3 className="text-xl font-semibold mb-4">Create Workout</h3>
                            <form onSubmit={handleSubmit}>
                              <div className="space-y-4 mb-4">
    <div>
        <label className="block text-sm font-medium mb-2">Workout Name</label>
        <input
            type="text"
            className="coastal-input"
            value={formData.name}
            onChange={(e) => setFormData({...formData, name: e.target.value})}
            required
        />
    </div>
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
    <label className="block text-sm font-medium mb-2">Scheduled Date</label>
    <input
        type="date"
        className="coastal-input"
        value={formData.scheduledDate}
        onChange={(e) => setFormData({...formData, scheduledDate: e.target.value})}
        min={DateHandler.getCurrentETDate()} // Allow today and future dates
    />
</div>
        <div className="flex items-end">
            <label className="flex items-center">
                <input
                    type="checkbox"
                    checked={formData.repeatWeekly || false}
                    onChange={(e) => setFormData({...formData, repeatWeekly: e.target.checked})}
                    className="mr-2"
                />
                Repeat weekly for 4 weeks
            </label>
        </div>
    </div>
    
</div>
  <div>
    <label className="block text-sm font-medium mb-2">Workout Video (YouTube)</label>
    <input
        type="text"
        placeholder="YouTube link for entire workout (optional)"
        className="coastal-input"
        value={formData.youtubeLink || ''}
        onChange={(e) => setFormData({...formData, youtubeLink: e.target.value})}
    />
</div>                              
                        <div className="mb-4">
    <div className="flex justify-between items-center mb-2">
        <label className="block text-sm font-medium">Exercises</label>
        <div className="flex gap-2">
            <button 
    type="button" 
    onClick={async () => {
        console.log('Search button clicked, isClient:', isClient);
        console.log('Current library exercises:', libraryExercises.length);
        
        // Force fetch if empty
        if (libraryExercises.length === 0) {
            console.log('Fetching library exercises...');
            await fetchLibraryExercises();
        }
        
        setShowExerciseSearch(true);
    }}
    className="text-purple-500 hover:text-purple-600"
>
    <i className="fas fa-search mr-1"></i>
    Search Exercises {libraryExercises.length > 0 && `(${libraryExercises.length})`}
</button>
            <button type="button" onClick={addExercise} className="text-blue-500 hover:text-blue-600">
                <i className="fas fa-plus mr-1"></i>
                Add Exercise
            </button>
        </div>
    </div>

   {/* Exercise Search Modal */}
{showExerciseSearch && (
    <div className="modal-overlay" onClick={() => {
        setShowExerciseSearch(false);
        setExerciseSearchTerm('');
    }}>
        <div className="modal-content max-w-2xl" onClick={(e) => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-xl font-semibold text-white">Search Exercise Library</h3>
                <button 
                    onClick={() => {
                        setShowExerciseSearch(false);
                        setExerciseSearchTerm('');
                    }}
                    className="text-gray-400 hover:text-white"
                >
                    <i className="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div className="mb-4">
                <div className="relative">
                    <input
                        type="text"
                        placeholder="Search by name, muscle group, or equipment..."
                        className="coastal-input pl-10"
                        value={exerciseSearchTerm}
                        onChange={(e) => setExerciseSearchTerm(e.target.value)}
                        autoFocus
                    />
                    <i className="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
                <p className="text-xs text-gray-400 mt-2">
                    {libraryExercises.length === 0 ? (
                        <span className="text-yellow-400">Loading exercise library...</span>
                    ) : (
                        `${libraryExercises.length} exercises available`
                    )}
                </p>
            </div>
            
            <div className="max-h-96 overflow-y-auto">
                {libraryExercises.length === 0 ? (
                    <div className="text-center py-8 text-gray-400">
                        <div className="loading-spinner mx-auto mb-3"></div>
                        <p>Loading exercises from library...</p>
                    </div>
                ) : exerciseSearchTerm.trim() === '' ? (
                    <div className="text-center py-8 text-gray-400">
                        <i className="fas fa-search text-4xl mb-3 opacity-50"></i>
                        <p>Start typing to search exercises...</p>
                        <p className="text-sm mt-2">Search by name, muscle group, difficulty, or equipment</p>
                    </div>
                ) : filteredLibraryExercises.length > 0 ? (
                    <div className="space-y-2">
                        {filteredLibraryExercises.map(exercise => (
                            <div 
                                key={exercise._id} 
                                className="flex justify-between items-center p-3 bg-gray-800 rounded-lg hover:bg-gray-700 transition"
                            >
                                <div className="flex-1">
                                    <h4 className="font-medium text-white">{exercise.name}</h4>
                                    <div className="flex gap-2 mt-1">
                                        <span className="text-xs bg-blue-900 bg-opacity-50 text-blue-300 px-2 py-1 rounded">
                                            {exercise.muscleCategory}
                                        </span>
                                        <span className="text-xs bg-purple-900 bg-opacity-50 text-purple-300 px-2 py-1 rounded">
                                            {exercise.difficulty}
                                        </span>
                                        <span className="text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded">
                                            {exercise.equipmentNeeded}
                                        </span>
                                    </div>
                                </div>
                                <button
                                    type="button"
                                    onClick={() => {
                                        addExerciseFromLibrary(exercise);
                                    }}
                                    className="coastal-button text-sm py-2 px-4 ml-3"
                                >
                                    <i className="fas fa-plus mr-1"></i>
                                    Add
                                </button>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="text-center py-8 text-gray-400">
                        <i className="fas fa-exclamation-circle text-4xl mb-3 opacity-50"></i>
                        <p>No exercises found matching "{exerciseSearchTerm}"</p>
                        <p className="text-sm mt-2">Try different keywords</p>
                    </div>
                )}
            </div>
        </div>
    </div>
)}
                                    
                     {formData.exercises.map((exercise, index) => (
    <div key={index} className="bg-gray-800 p-4 rounded mb-3">
        <div className="space-y-2">
            <div className="grid grid-cols-6 gap-2">
                <input
                    type="text"
                    placeholder="Exercise name"
                    className="coastal-input col-span-2"
                    value={exercise.name}
                    onChange={(e) => updateExercise(index, 'name', e.target.value)}
                    required
                />
                <div>
                    <label className="text-xs text-gray-400">Sets</label>
                    <input
                        type="number"
                        className="coastal-input"
                        value={exercise.sets}
                        onChange={(e) => updateExercise(index, 'sets', parseInt(e.target.value))}
                        required
                    />
                </div>
                <div>
                    <label className="text-xs text-gray-400">Reps/Range</label>
                    <input
                        type="text"
                        className="coastal-input"
                        placeholder="10 or 8-12"
                        value={exercise.reps}
                        onChange={(e) => updateExercise(index, 'reps', e.target.value)}
                        required
                    />
                </div>
                <div>
                    <label className="text-xs text-gray-400">Weight (lbs)</label>
                    <input
                        type="number"
                        className="coastal-input"
                        value={exercise.weight}
                        onChange={(e) => updateExercise(index, 'weight', parseFloat(e.target.value))}
                    />
                </div>
                <div>
                    <label className="text-xs text-gray-400">Hold Time (sec)</label>
                    <input
                        type="number"
                        className="coastal-input"
                        placeholder="For isometric"
                        value={exercise.holdTime || ''}
                        onChange={(e) => updateExercise(index, 'holdTime', parseInt(e.target.value) || 0)}
                    />
                </div>
            </div>
            
            {/* Grouping selector - only show if not the last exercise */}
            {index < formData.exercises.length - 1 && (
                <div className="flex items-center gap-4">
                    <label className="text-sm font-medium">Exercise Grouping:</label>
                   <select
    className="dark-input flex-1"  // Keep dark theme
    value={exercise.grouping || 'none'}
    onChange={(e) => updateExercise(index, 'grouping', e.target.value)}
>
    <option value="none">No group</option>
    {['A', 'B', 'C', 'D', 'E'].map(letter => (
        <option key={letter} value={letter}>Group {letter}</option>
    ))}
</select>
                </div>
            )}
            
            <textarea
                placeholder="Specialist notes for client (optional)"
                className="coastal-input"
                rows="2"
                value={exercise.notes}
                onChange={(e) => updateExercise(index, 'notes', e.target.value)}
            ></textarea>
        </div>
        
        {/* Visual indicators for groupings */}
        {exercise.grouping === 'superset' && index < formData.exercises.length - 1 && (
            <div className="text-center mt-3 text-blue-600 font-medium">
                <i className="fas fa-link"></i> Superset with next exercise
            </div>
        )}
        {exercise.grouping === 'triset' && index < formData.exercises.length - 2 && (
            <div className="text-center mt-3 text-purple-600 font-medium">
                <i className="fas fa-link"></i> Tri-set with next 2 exercises
            </div>
        )}
        
        <button
            type="button"
            onClick={() => removeExercise(index)}
            className="text-red-500 hover:text-red-600 mt-2"
        >
            <i className="fas fa-trash mr-1"></i>
            Remove Exercise
        </button>
    </div>
))}
                                </div>
                                
                                <div className="flex gap-4">
    <button type="submit" className="coastal-button">
        {editingWorkout ? 'Update' : 'Create'} Workout
    </button>
    {editingWorkout && (
        <button 
            type="button" 
            onClick={() => handleDelete(editingWorkout)}
            className="coastal-button bg-red-500 hover:bg-red-600"
        >
            <i className="fas fa-trash mr-2"></i>
            Delete Workout
        </button>
    )}
    <button type="button" onClick={() => setShowForm(false)} className="coastal-button bg-gray-600 hover:bg-gray-700">
        Cancel
    </button>
</div>
                            </form>
                        </div>
                    )}
                    
                    {selectedClient && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {workouts.map(workout => (
                                <div key={workout._id} className="dark-card p-6">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 className="text-lg font-semibold">{workout.name}</h3>
                                            <p className="text-sm text-gray-400">
                                                {workout.exercises?.length || 0} exercises
                                            </p>
                                            <p className="text-sm text-blue-600">
    {workout.scheduledDate ? `Scheduled: ${DateHandler.toDisplay(workout.scheduledDate)}` : 'Not scheduled'}
</p>
                                            {workout.youtubeLink && (
    <a 
        href={workout.youtubeLink}
        target="_blank"
        rel="noopener noreferrer"
        className="text-sm text-blue-500 hover:text-blue-600 block mt-2"
    >
        <i className="fab fa-youtube mr-1"></i>
        Watch Workout Video
    </a>
)}
                                            {workout.moodFeedback && (
                                                <div className="mt-2">
                                                    {renderStars(workout.moodFeedback)}
                                                </div>
                                            )}
                                        </div>
                                        {workout.completed ? (
                                            <span className="bg-green-100 text-green-700 px-3 py-1 rounded text-sm text-gray-300">
                                                ‚úì Complete
                                            </span>
                                       ) : (
    <div className="flex gap-2">
        <button
            onClick={() => setActiveSession(workout._id)}
            className="coastal-button text-sm py-1 px-3"
        >
            Start
        </button>
        {!isClient && (
            <button
                onClick={() => {
    setEditingWorkout(workout._id);
    setFormData({
        ...workout,
        scheduledDate: workout.scheduledDate ? DateHandler.toDateInput(workout.scheduledDate) : DateHandler.getCurrentETDate()
    });
                    console.log('Edit date:', workout.scheduledDate, 'Converted:', DateHandler.toDateInput(workout.scheduledDate));
    setShowForm(true);
}}
                className="text-blue-500 hover:text-blue-600"
            >
                <i className="fas fa-edit"></i>
            </button>
        )}
    </div>
)}
                                    </div>
                                    
<div className="space-y-2">
                        {workout.exercises?.map((exercise, index) => (
                            <div key={index} className="border-l-2 border-gray-200 pl-3">
                                <div className="font-medium text-sm text-gray-300">
                                    {exercise.name}: {exercise.sets} √ó {exercise.reps}
                                    {exercise.weight > 0 && ` @ ${exercise.weight}lbs`}
                                </div>
                                {exercise.notes && (
                                    <p className="text-xs text-gray-400 italic mt-1">
                                        Note: {exercise.notes}
                                    </p>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            ))}
        </div>
    )}
    {/* Render WorkoutSession if active */}
        {activeSession && (
            <WorkoutSession 
                workoutId={activeSession}
                onClose={() => {
                    setActiveSession(null);
                    fetchWorkouts(); // Refresh workouts after session ends
                }}
                showSuccess={showSuccess}
                showError={showError}
            />
        )}                
</div>
   );
}; 
// Exercise Library Component
const ExerciseLibrary = ({ user, showError, showSuccess }) => {
    console.log('ExerciseLibrary component rendered!', user);  // ADD THIS LINE HERE
    const [exercises, setExercises] = useState([]);
    const [showForm, setShowForm] = useState(false);
    const [showDetails, setShowDetails] = useState(null);
    const [searchTerm, setSearchTerm] = useState('');
    const [selectedCategory, setSelectedCategory] = useState('all');
    const [selectedEquipment, setSelectedEquipment] = useState('all');
    const [selectedDifficulty, setSelectedDifficulty] = useState('all');
    const [editingExercise, setEditingExercise] = useState(null);
    const [formData, setFormData] = useState({
        name: '',
        muscleCategory: '',
        secondaryMuscles: [],
        equipmentNeeded: 'none',
        difficulty: 'intermediate',
        description: '',
        instructions: [''],
        tips: [''],
        commonMistakes: [''],
        imageUrl: '',
        videoUrl: '',
        tags: []
    });
    
    const muscleCategories = [
        'Chest', 'Back', 'Shoulders', 'Biceps', 'Triceps', 
        'Legs', 'Glutes', 'Core', 'Cardio', 'Full Body'
    ];
    
    const equipmentTypes = [
        { value: 'none', label: 'No Equipment' },
        { value: 'barbell', label: 'Barbell' },
        { value: 'dumbbells', label: 'Dumbbells' },
        { value: 'machine', label: 'Machine' },
        { value: 'cable', label: 'Cable' },
        { value: 'bands', label: 'Resistance Bands' },
        { value: 'bodyweight', label: 'Bodyweight' },
        { value: 'other', label: 'Other' }
    ];
    
    const uploadToCloudinary = async (file) => {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', 'ml_default');
        
        try {
            const response = await fetch(
                'https://api.cloudinary.com/v1_1/dgpt2oxmi/image/upload',
                {
                    method: 'POST',
                    body: formData
                }
            );
            const data = await response.json();
            return data.secure_url;
        } catch (error) {
            console.error('Upload failed:', error);
            return null;
        }
    };
    
    useEffect(() => {
        fetchExercises();
    }, [selectedCategory, selectedEquipment, selectedDifficulty, searchTerm]);
    
    const fetchExercises = async () => {
        try {
            const params = new URLSearchParams();
            if (searchTerm) params.append('search', searchTerm);
            if (selectedCategory !== 'all') params.append('category', selectedCategory);
            if (selectedEquipment !== 'all') params.append('equipment', selectedEquipment);
            if (selectedDifficulty !== 'all') params.append('difficulty', selectedDifficulty);
            
            const data = await API_CONFIG.request(`/exercises?${params.toString()}`);
           setExercises(Array.isArray(data) ? data : (data.data || []));
        } catch (error) {
            console.error('Error fetching exercises:', error);
        }
    };
    
    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            const method = editingExercise ? 'PUT' : 'POST';
            const endpoint = editingExercise 
                ? `/exercises/${editingExercise._id}`
                : '/exercises';
            
            // Clean up empty strings from arrays
            const cleanedData = {
                ...formData,
                instructions: formData.instructions.filter(i => i.trim()),
                tips: formData.tips.filter(t => t.trim()),
                commonMistakes: formData.commonMistakes.filter(m => m.trim()),
                tags: formData.tags
            };
            
            await API_CONFIG.request(endpoint, {
                method,
                body: JSON.stringify(cleanedData)
            });
            
            showSuccess(editingExercise ? 'Exercise updated' : 'Exercise added to library');
            resetForm();
            fetchExercises();
        } catch (error) {
            showError(error.message);
        }
    };
    
    const resetForm = () => {
        setShowForm(false);
        setEditingExercise(null);
        setFormData({
            name: '',
            muscleCategory: '',
            secondaryMuscles: [],
            equipmentNeeded: 'none',
            difficulty: 'intermediate',
            description: '',
            instructions: [''],
            tips: [''],
            commonMistakes: [''],
            imageUrl: '',
            videoUrl: '',
            tags: []
        });
    };
    
    const handleEdit = (exercise) => {
        setEditingExercise(exercise);
        setFormData({
            ...exercise,
            instructions: exercise.instructions?.length ? exercise.instructions : [''],
            tips: exercise.tips?.length ? exercise.tips : [''],
            commonMistakes: exercise.commonMistakes?.length ? exercise.commonMistakes : [''],
            secondaryMuscles: exercise.secondaryMuscles || [],
            tags: exercise.tags || []
        });
        setShowForm(true);
        setShowDetails(null);
    };
    
    const handleDelete = async (exerciseId) => {
        if (confirm('Delete this exercise from library?')) {
            try {
                await API_CONFIG.request(`/exercises/${exerciseId}`, {
                    method: 'DELETE'
                });
                showSuccess('Exercise removed');
                fetchExercises();
                setShowDetails(null);
            } catch (error) {
                showError(error.message);
            }
        }
    };
    
    const addArrayItem = (field) => {
        setFormData({
            ...formData,
            [field]: [...formData[field], '']
        });
    };
    
    const updateArrayItem = (field, index, value) => {
        const updated = [...formData[field]];
        updated[index] = value;
        setFormData({
            ...formData,
            [field]: updated
        });
    };
    
    const removeArrayItem = (field, index) => {
        setFormData({
            ...formData,
            [field]: formData[field].filter((_, i) => i !== index)
        });
    };
    
    const toggleSecondaryMuscle = (muscle) => {
        if (formData.secondaryMuscles.includes(muscle)) {
            setFormData({
                ...formData,
                secondaryMuscles: formData.secondaryMuscles.filter(m => m !== muscle)
            });
        } else {
            setFormData({
                ...formData,
                secondaryMuscles: [...formData.secondaryMuscles, muscle]
            });
        }
    };
    
    const getDifficultyColor = (difficulty) => {
        switch(difficulty) {
            case 'beginner': return 'bg-green-100 text-green-700';
            case 'intermediate': return 'bg-yellow-100 text-yellow-700';
            case 'advanced': return 'bg-red-100 text-red-700';
            default: return 'bg-gray-100 text-gray-700';
        }
    };
    
    const getEquipmentIcon = (equipment) => {
        switch(equipment) {
            case 'barbell': return 'üèãÔ∏è';
            case 'dumbbells': return 'üí™';
            case 'machine': return '‚öôÔ∏è';
            case 'cable': return 'üîó';
            case 'bands': return 'ü™¢';
            case 'bodyweight': return 'ü§∏';
            case 'none': return 'üôå';
            default: return 'üì¶';
        }
    };
    
    // Can clients view the library?
    const canView = true; // All logged-in users can view
    const canEdit = user.roles?.includes('specialist') || user.roles?.includes('admin') || user.roles?.includes('owner');
    
    return (
        <div className="space-y-6">
            <div className="dark-card p-6">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-bold text-white">Exercise Library</h2>
                    {canEdit && (
                        <button 
                            onClick={() => setShowForm(!showForm)} 
                            className="coastal-button"
                        >
                            <i className={`fas fa-${showForm ? 'minus' : 'plus'} mr-2`}></i>
                            {showForm ? 'Close Form' : 'Add Exercise'}
                        </button>
                    )}
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div className="relative">
                        <input
                            type="text"
                            placeholder="Search exercises..."
                            className="coastal-input pl-10"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                        <i className="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    
                    <select
                        className="coastal-input"
                        value={selectedCategory}
                        onChange={(e) => setSelectedCategory(e.target.value)}
                    >
                        <option value="all">All Muscles</option>
                        {muscleCategories.map(cat => (
                            <option key={cat} value={cat}>{cat}</option>
                        ))}
                    </select>
                    
                    <select
                        className="coastal-input"
                        value={selectedEquipment}
                        onChange={(e) => setSelectedEquipment(e.target.value)}
                    >
                        <option value="all">All Equipment</option>
                        {equipmentTypes.map(type => (
                            <option key={type.value} value={type.value}>{type.label}</option>
                        ))}
                    </select>
                    
                    <select
                        className="coastal-input"
                        value={selectedDifficulty}
                        onChange={(e) => setSelectedDifficulty(e.target.value)}
                    >
                        <option value="all">All Levels</option>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>
            </div>
            
            {showForm && canEdit && (
                <div className="dark-card p-6">
                    <h3 className="text-xl font-semibold mb-4">
                        {editingExercise ? 'Edit Exercise' : 'Add Exercise to Library'}
                    </h3>
                    <form onSubmit={handleSubmit}>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-2">Exercise Name*</label>
                                <input
                                    type="text"
                                    className="coastal-input"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    placeholder="e.g., Bench Press"
                                    required
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium mb-2">Primary Muscle*</label>
                                <select
                                    className="coastal-input"
                                    value={formData.muscleCategory}
                                    onChange={(e) => setFormData({...formData, muscleCategory: e.target.value})}
                                    required
                                >
                                    <option value="">Select muscle...</option>
                                    {muscleCategories.map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium mb-2">Equipment Needed</label>
                                <select
                                    className="coastal-input"
                                    value={formData.equipmentNeeded}
                                    onChange={(e) => setFormData({...formData, equipmentNeeded: e.target.value})}
                                >
                                    {equipmentTypes.map(type => (
                                        <option key={type.value} value={type.value}>{type.label}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                        
                        <div className="mt-4">
                            <label className="block text-sm font-medium mb-2">Difficulty Level</label>
                            <div className="flex gap-4">
                                {['beginner', 'intermediate', 'advanced'].map(level => (
                                    <label key={level} className="flex items-center">
                                        <input
                                            type="radio"
                                            name="difficulty"
                                            value={level}
                                            checked={formData.difficulty === level}
                                            onChange={(e) => setFormData({...formData, difficulty: e.target.value})}
                                            className="mr-2"
                                        />
                                        {level.charAt(0).toUpperCase() + level.slice(1)}
                                    </label>
                                ))}
                            </div>
                        </div>
                        
                        <div className="mt-4">
                            <label className="block text-sm font-medium mb-2">Secondary Muscles</label>
                            <div className="flex flex-wrap gap-2">
                                {muscleCategories.filter(m => m !== formData.muscleCategory).map(muscle => (
                                    <label 
                                        key={muscle}
                                        className={`flex items-center px-3 py-1 rounded cursor-pointer ${
                                            formData.secondaryMuscles.includes(muscle) 
                                                ? 'bg-blue-100 text-blue-700' 
                                                : 'bg-gray-100 hover:bg-gray-200'
                                        }`}
                                    >
                                        <input
                                            type="checkbox"
                                            checked={formData.secondaryMuscles.includes(muscle)}
                                            onChange={() => toggleSecondaryMuscle(muscle)}
                                            className="sr-only"
                                        />
                                        {muscle}
                                    </label>
                                ))}
                            </div>
                        </div>
                        
                        <div className="mt-4">
                            <label className="block text-sm font-medium mb-2">Description*</label>
                            <textarea
                                className="coastal-input"
                                rows="3"
                                value={formData.description}
                                onChange={(e) => setFormData({...formData, description: e.target.value})}
                                placeholder="Brief description of the exercise..."
                                required
                            />
                        </div>
                        
                        <div className="mt-4">
                            <label className="block text-sm font-medium mb-2">Step-by-Step Instructions</label>
                            {formData.instructions.map((instruction, index) => (
                                <div key={index} className="flex gap-2 mb-2">
                                    <span className="text-sm font-medium mt-2">{index + 1}.</span>
                                    <input
                                        type="text"
                                        className="coastal-input flex-1"
                                        value={instruction}
                                        onChange={(e) => updateArrayItem('instructions', index, e.target.value)}
                                        placeholder="Enter instruction..."
                                    />
                                    <button
                                        type="button"
                                        onClick={() => removeArrayItem('instructions', index)}
                                        className="text-red-500 hover:text-red-600"
                                        disabled={formData.instructions.length === 1}
                                    >
                                        <i className="fas fa-times"></i>
                                    </button>
                                </div>
                            ))}
                            <button
                                type="button"
                                onClick={() => addArrayItem('instructions')}
                                className="text-blue-500 hover:text-blue-600 text-sm"
                            >
                                <i className="fas fa-plus mr-1"></i>
                                Add instruction
                            </button>
                        </div>
                        
                        <div className="mt-4">
                            <label className="block text-sm font-medium mb-2">Pro Tips</label>
                            {formData.tips.map((tip, index) => (
                                <div key={index} className="flex gap-2 mb-2">
                                    <input
                                        type="text"
                                        className="coastal-input flex-1"
                                        value={tip}
                                        onChange={(e) => updateArrayItem('tips', index, e.target.value)}
                                        placeholder="Enter tip..."
                                    />
                                    <button
                                        type="button"
                                        onClick={() => removeArrayItem('tips', index)}
                                        className="text-red-500 hover:text-red-600"
                                        disabled={formData.tips.length === 1}
                                    >
                                        <i className="fas fa-times"></i>
                                    </button>
                                </div>
                            ))}
                            <button
                                type="button"
                                onClick={() => addArrayItem('tips')}
                                className="text-blue-500 hover:text-blue-600 text-sm"
                            >
                                <i className="fas fa-plus mr-1"></i>
                                Add tip
                            </button>
                        </div>
                        
                        <div className="mt-4">
                            <label className="block text-sm font-medium mb-2">Common Mistakes</label>
                            {formData.commonMistakes.map((mistake, index) => (
                                <div key={index} className="flex gap-2 mb-2">
                                    <input
                                        type="text"
                                        className="coastal-input flex-1"
                                        value={mistake}
                                        onChange={(e) => updateArrayItem('commonMistakes', index, e.target.value)}
                                        placeholder="Enter common mistake..."
                                    />
                                    <button
                                        type="button"
                                        onClick={() => removeArrayItem('commonMistakes', index)}
                                        className="text-red-500 hover:text-red-600"
                                        disabled={formData.commonMistakes.length === 1}
                                    >
                                        <i className="fas fa-times"></i>
                                    </button>
                                </div>
                            ))}
                            <button
                                type="button"
                                onClick={() => addArrayItem('commonMistakes')}
                                className="text-blue-500 hover:text-blue-600 text-sm"
                            >
                                <i className="fas fa-plus mr-1"></i>
                                Add common mistake
                            </button>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label className="block text-sm font-medium mb-2">Exercise Image</label>
                                <input
                                    type="file"
                                    accept="image/*"
                                    className="coastal-input"
                                    onChange={async (e) => {
                                        const file = e.target.files[0];
                                        if (file) {
                                            const url = await uploadToCloudinary(file);
                                            if (url) {
                                                setFormData({...formData, imageUrl: url});
                                                showSuccess('Image uploaded successfully');
                                            } else {
                                                showError('Failed to upload image');
                                            }
                                        }
                                    }}
                                />
                                {formData.imageUrl && (
                                    <img src={formData.imageUrl} alt="Exercise preview" className="mt-2 h-32 object-cover rounded" />
                                )}
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium mb-2">Video URL (YouTube/Vimeo)</label>
                                <input
                                    type="text"
                                    className="coastal-input"
                                    value={formData.videoUrl}
                                    onChange={(e) => setFormData({...formData, videoUrl: e.target.value})}
                                    placeholder="https://youtube.com/watch?v=..."
                                />
                            </div>
                        </div>
                        
                        <div className="mt-4">
                            <label className="block text-sm font-medium mb-2">Tags (comma separated)</label>
                            <input
                                type="text"
                                className="coastal-input"
                                value={formData.tags.join(', ')}
                                onChange={(e) => setFormData({
                                    ...formData, 
                                    tags: e.target.value.split(',').map(t => t.trim()).filter(t => t)
                                })}
                                placeholder="e.g., strength, compound, push"
                            />
                        </div>
                        
                        <div className="flex gap-4 mt-6">
                            <button type="submit" className="coastal-button">
                                {editingExercise ? 'Update' : 'Save'} Exercise
                            </button>
                            <button type="button" onClick={resetForm} className="coastal-button bg-gray-600 hover:bg-gray-700">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            )}
            
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {exercises.map(exercise => (
                    <div key={exercise._id} className="dark-card p-4">
                        {exercise.imageUrl && (
                            <img 
                                src={exercise.imageUrl} 
                                alt={exercise.name}
                                className="w-full h-48 object-cover rounded mb-3"
                                onError={(e) => e.target.style.display = 'none'}
                            />
                        )}
                        <div className="flex justify-between items-start mb-2">
                            <h4 className="font-semibold text-lg">{exercise.name}</h4>
                            <span className="text-2xl">{getEquipmentIcon(exercise.equipmentNeeded)}</span>
                        </div>
                        <div className="flex gap-2 mb-2">
                            <span className="inline-block px-2 py-1 text-xs rounded bg-blue-100 text-blue-700">
                                {exercise.muscleCategory}
                            </span>
                            <span className={`inline-block px-2 py-1 text-xs rounded ${getDifficultyColor(exercise.difficulty)}`}>
                                {exercise.difficulty}
                            </span>
                        </div>
                        <p className="text-sm text-gray-400 mb-3 line-clamp-2">{exercise.description}</p>
                        
                        <div className="flex justify-between items-center">
                            <button
                                onClick={() => setShowDetails(exercise)}
                                className="text-blue-600 hover:text-blue-700 font-medium text-sm"
                            >
                                <i className="fas fa-info-circle mr-1"></i>
                                View Details
                            </button>
                            
                            <div className="flex gap-2">
    
                                {canEdit && (
                                    <>
                                        <button
                                            onClick={() => handleEdit(exercise)}
                                            className="text-blue-500 hover:text-blue-600"
                                        >
                                            <i className="fas fa-edit"></i>
                                        </button>
                                        <button
                                            onClick={() => handleDelete(exercise._id)}
                                            className="text-red-500 hover:text-red-600"
                                        >
                                            <i className="fas fa-trash"></i>
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                ))}
            </div>
            
           {exercises.length === 0 && (
                <div className="text-center py-8 text-gray-500">
                    No exercises found. {searchTerm && 'Try a different search term.'}
                </div>
            )}
            
            {/* Exercise Details Modal */}
            {showDetails && (
                <div className="modal-overlay" onClick={() => setShowDetails(null)}>
                    <div className="modal-content max-w-3xl" onClick={(e) => e.stopPropagation()}>
                        <div className="flex justify-between items-start mb-4">
                            <h2 className="text-2xl font-bold text-white">{showDetails.name}</h2>
                            <button
                                onClick={() => setShowDetails(null)}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        {showDetails.imageUrl && (
                            <img 
                                src={showDetails.imageUrl} 
                                alt={showDetails.name}
                                className="w-full max-h-96 object-contain rounded mb-4"
                            />
                        )}
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <p className="text-sm text-gray-400">Primary Muscle</p>
                                <p className="font-semibold">{showDetails.muscleCategory}</p>
                            </div>
                            <div>
                                <p className="text-sm text-gray-400">Equipment</p>
                                <p className="font-semibold">{equipmentTypes.find(e => e.value === showDetails.equipmentNeeded)?.label}</p>
                            </div>
                            <div>
                                <p className="text-sm text-gray-400">Difficulty</p>
                                <p className="font-semibold">{showDetails.difficulty}</p>
                            </div>
                            {showDetails.secondaryMuscles?.length > 0 && (
                                <div>
                                    <p className="text-sm text-gray-400">Secondary Muscles</p>
                                    <p className="font-semibold">{showDetails.secondaryMuscles.join(', ')}</p>
                                </div>
                            )}
                        </div>
                        
                        <div className="mb-4">
                            <h3 className="font-semibold mb-2">Description</h3>
                            <p className="text-gray-300">{showDetails.description}</p>
                        </div>
                        
                        {showDetails.instructions?.length > 0 && (
                            <div className="mb-4">
                                <h3 className="font-semibold mb-2">Instructions</h3>
                                <ol className="list-decimal list-inside space-y-1">
                                    {showDetails.instructions.map((instruction, index) => (
                                        <li key={index} className="text-gray-300">{instruction}</li>
                                    ))}
                                </ol>
                            </div>
                        )}
                        
                        {showDetails.tips?.length > 0 && (
                            <div className="mb-4">
                                <h3 className="font-semibold mb-2">Pro Tips</h3>
                                <ul className="list-disc list-inside space-y-1">
                                    {showDetails.tips.map((tip, index) => (
                                        <li key={index} className="text-gray-300">{tip}</li>
                                    ))}
                                </ul>
                            </div>
                        )}
                        
                        {showDetails.commonMistakes?.length > 0 && (
                            <div className="mb-4">
                                <h3 className="font-semibold mb-2">Common Mistakes to Avoid</h3>
                                <ul className="list-disc list-inside space-y-1">
                                    {showDetails.commonMistakes.map((mistake, index) => (
                                        <li key={index} className="text-gray-300">{mistake}</li>
                                    ))}
                                </ul>
                            </div>
                        )}
                        
                        {showDetails.videoUrl && (
                            <div className="mb-4">
                                <a 
                                    href={showDetails.videoUrl}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="coastal-button"
                                >
                                    <i className="fab fa-youtube mr-2"></i>
                                    Watch Video Tutorial
                                </a>
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
};
        // Enhanced Measurements Component with Circumference and Caliper
        const Measurements = ({ user, isClient, showError, showSuccess }) => {
            const [measurements, setMeasurements] = useState([]);
            const [selectedClient, setSelectedClient] = useState(isClient ? user._id : null);
            const [clients, setClients] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [measurementType, setMeasurementType] = useState('basic');
            const [editingMeasurement, setEditingMeasurement] = useState(null);
            const [formData, setFormData] = useState({
                date: DateHandler.getCurrentETDate(),
                weight: '',
                bodyFat: '',
                bmr: '',
                bloodPressure: '',
                circumference: {
                    neck: '',
                    shoulders: '',
                    chest: '',
                    upperArm: '',
                    lowerArm: '',
                    waist: '',
                    hips: '',
                    upperThigh: '',
                    calf: ''
                },
                caliper: {
                    chest: '',
                    abdominal: '',
                    thigh: '',
                    bicep: '',
                    tricep: '',
                    subscapular: '',
                    suprailiac: '',
                    lowerBack: '',
                    calfSkin: ''
                }
            });
            
            useEffect(() => {
                if (!isClient && (user.roles?.includes('specialist') || user.roles?.includes('admin') || user.roles?.includes('owner'))) {
                    fetchClients();
                }
                if (selectedClient) {
                    fetchMeasurements();
                }
            }, [selectedClient, isClient]);
            
            const fetchClients = async () => {
    const clients = await ClientManager.loadClients();
    setClients(clients);
};
            
            const fetchMeasurements = async () => {
                try {
                    const response = await API_CONFIG.request(`/measurements/client/${selectedClient}`);
                    const measurementsData = Array.isArray(response) ? response : (response.data || []);
                    setMeasurements(measurementsData);
                } catch (error) {
                    console.error('Error fetching measurements:', error);
                    setMeasurements([]);
                }
            };
            
          const handleSubmit = async (e) => {
    e.preventDefault();
    if (!selectedClient) {
        showError('Please select a client first');
        return;
    }
    
    try {
        // Prepare the data based on measurement type
        let submitData = {
           date: DateHandler.toDatabase(formData.date),
            weight: formData.weight || 0,  // Always include weight
            bodyFat: formData.bodyFat || null,
            bloodPressure: formData.bloodPressure || null
        };
        
        // Add circumference data if any values are present
        if (measurementType === 'circumference') {
            submitData.circumference = formData.circumference;
        }
        
        // Add caliper data if any values are present
        if (measurementType === 'caliper') {
            submitData.caliper = formData.caliper;
        }
        
        const method = editingMeasurement ? 'PUT' : 'POST';
        const endpoint = editingMeasurement 
            ? `/measurements/${editingMeasurement}`  // Fixed endpoint for editing
            : `/measurements/client/${selectedClient}`;
            
        await API_CONFIG.request(endpoint, {
            method,
            body: JSON.stringify(submitData)  // Use submitData instead of formData
        });
        
        showSuccess(editingMeasurement ? 'Measurement updated successfully' : 'Measurement saved successfully');
        setShowForm(false);
        setEditingMeasurement(null);
        await fetchMeasurements();
        
        // Reset form
        setFormData({
            date: new Date().toISOString().split('T')[0],
            weight: '',
            bodyFat: '',
            bmr: '',
            bloodPressure: '',
            circumference: {
                neck: '', shoulders: '', chest: '', upperArm: '',
                lowerArm: '', waist: '', hips: '', upperThigh: '', calf: ''
            },
            caliper: {
                chest: '', abdominal: '', thigh: '', bicep: '', tricep: '',
                subscapular: '', suprailiac: '', lowerBack: '', calfSkin: ''
            }
        });
        setMeasurementType('basic'); // Reset to basic type
    } catch (error) {
        showError(error.message);
    }
};
            
            const updateCircumference = (field, value) => {
                setFormData({
                    ...formData,
                    circumference: {
                        ...formData.circumference,
                        [field]: value
                    }
                });
            };
            
            const updateCaliper = (field, value) => {
                setFormData({
                    ...formData,
                    caliper: {
                        ...formData.caliper,
                        [field]: value
                    }
                });
            };
            
            return (
                <div className="space-y-6">
                    <div className="dark-card p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold text-white">
                                {isClient ? 'My Measurements' : 'Measurements'}
                            </h2>
                           {selectedClient && (
    <button onClick={() => setShowForm(true)} className="coastal-button">
        <i className="fas fa-plus mr-2"></i>
        Add Measurement
    </button>
)}
                        </div>
                        
                        {!isClient && (
                            <select
                                className="coastal-input"
                                value={selectedClient || ''}
                                onChange={(e) => setSelectedClient(e.target.value)}
                            >
                                <option value="">Select a client...</option>
                                {clients.map(client => (
                                    <option key={client._id} value={client._id}>
                                        {client.name}
                                    </option>
                                ))}
                            </select>
                        )}
                    </div>
                    
                    {showForm && (
                        <div className="dark-card p-6">
                            <h3 className="text-xl font-semibold mb-4">Add Measurement</h3>
                            
                            <div className="flex gap-2 mb-4">
                                <button
                                    type="button"
                                    onClick={() => setMeasurementType('basic')}
                                    className={`px-4 py-2 rounded ${measurementType === 'basic' ? 'bg-blue-500 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
                                >
                                    Basic
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setMeasurementType('circumference')}
                                    className={`px-4 py-2 rounded ${measurementType === 'circumference' ? 'bg-blue-500 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
                                >
                                    Circumference
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setMeasurementType('caliper')}
                                    className={`px-4 py-2 rounded ${measurementType === 'caliper' ? 'bg-blue-500 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
                                >
                                    Caliper
                                </button>
                            </div>
                            
                            <form onSubmit={handleSubmit}>
                                {measurementType === 'basic' && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Date</label>
                                            <input
                                                type="date"
                                                className="coastal-input"
                                                value={formData.date}
                                                onChange={(e) => setFormData({...formData, date: e.target.value})}
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Weight (lbs)</label>
                                            <input
                                                type="number"
                                                step="0.1"
                                                className="coastal-input"
                                                value={formData.weight}
                                                onChange={(e) => setFormData({...formData, weight: e.target.value})}
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Body Fat %</label>
                                            <input
                                                type="number"
                                                step="0.1"
                                                className="coastal-input"
                                                value={formData.bodyFat}
                                                onChange={(e) => setFormData({...formData, bodyFat: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Blood Pressure</label>
                                            <input
                                                type="text"
                                                className="coastal-input"
                                                placeholder="120/80"
                                                value={formData.bloodPressure}
                                                onChange={(e) => setFormData({...formData, bloodPressure: e.target.value})}
                                            />
                                        </div>
                                    </div>
                                )}
                                
                                {measurementType === 'circumference' && (
                                    <div>
                                        <p className="text-sm text-gray-400 mb-4">All measurements in inches</p>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Neck</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.circumference.neck}
                                                    onChange={(e) => updateCircumference('neck', e.target.value)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Shoulders</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.circumference.shoulders}
                                                    onChange={(e) => updateCircumference('shoulders', e.target.value)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Chest</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.circumference.chest}
                                                    onChange={(e) => updateCircumference('chest', e.target.value)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Upper Arm</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.circumference.upperArm}
                                                    onChange={(e) => updateCircumference('upperArm', e.target.value)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Lower Arm</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.circumference.lowerArm}
                                                    onChange={(e) => updateCircumference('lowerArm', e.target.value)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Waist</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.circumference.waist}
                                                    onChange={(e) => updateCircumference('waist', e.target.value)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Hips</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.circumference.hips}
                                                    onChange={(e) => updateCircumference('hips', e.target.value)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Upper Thigh</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.circumference.upperThigh}
                                                    onChange={(e) => updateCircumference('upperThigh', e.target.value)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Calf</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.circumference.calf}
                                                    onChange={(e) => updateCircumference('calf', e.target.value)}
                                                />
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {measurementType === 'caliper' && (
                                    <div>
                                        <p className="text-sm text-gray-400 mb-4">All measurements in millimeters</p>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Chest</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.caliper.chest}
                                                    onChange={(e) => updateCaliper('chest', e.target.value)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Abdominal</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.caliper.abdominal}
                                                    onChange={(e) => updateCaliper('abdominal', e.target.value)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Thigh</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.caliper.thigh}
                                                    onChange={(e) => updateCaliper('thigh', e.target.value)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Bicep</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.caliper.bicep}
                                                    onChange={(e) => updateCaliper('bicep', e.target.value)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Tricep</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.caliper.tricep}
                                                    onChange={(e) => updateCaliper('tricep', e.target.value)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Subscapular</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.caliper.subscapular}
                                                    onChange={(e) => updateCaliper('subscapular', e.target.value)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Suprailiac</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.caliper.suprailiac}
                                                    onChange={(e) => updateCaliper('suprailiac', e.target.value)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Lower Back</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.caliper.lowerBack}
                                                    onChange={(e) => updateCaliper('lowerBack', e.target.value)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Calf</label>
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    className="coastal-input"
                                                    value={formData.caliper.calfSkin}
                                                    onChange={(e) => updateCaliper('calfSkin', e.target.value)}
                                                />
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                <div className="flex gap-4">
                                    <button type="submit" className="coastal-button">
                                        Save Measurement
                                    </button>
                                    <button type="button" onClick={() => setShowForm(false)} className="coastal-button bg-gray-600 hover:bg-gray-700">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}
                    
                    {selectedClient && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {measurements.length > 0 ? (
                                measurements.map(measurement => (
                                    <div key={measurement._id} className="dark-card p-6">
    <div className="flex justify-between items-start mb-2">
        <h3 className="text-lg font-semibold">
         {DateHandler.toDisplay(measurement.date)}   
        </h3>
        {!isClient && (
    <button
        onClick={() => {
            setEditingMeasurement(measurement._id);
            setFormData({
              date: DateHandler.toDateInput(measurement.date),
                weight: measurement.weight || '',
                bodyFat: measurement.bodyFat || '',
                bmr: measurement.bmr || '',
                bloodPressure: measurement.bloodPressure || '',
                circumference: measurement.circumference || {
                    neck: '', shoulders: '', chest: '', upperArm: '',
                    lowerArm: '', waist: '', hips: '', upperThigh: '', calf: ''
                },
                caliper: measurement.caliper || {
                    chest: '', abdominal: '', thigh: '', bicep: '', tricep: '',
                    subscapular: '', suprailiac: '', lowerBack: '', calfSkin: ''
                }
            });
            setShowForm(true);
        }}
        className="text-blue-500 hover:text-blue-600"
    >
        <i className="fas fa-edit"></i>
    </button>
)}
    </div>
                                        <div className="space-y-2">
                                            <div className="flex justify-between">
                                                <span className="text-gray-300">Weight:</span>
                                                <span className="font-medium">{measurement.weight} lbs</span>
                                            </div>
                                            {measurement.bodyFat && (
                                                <div className="flex justify-between">
                                                    <span className="text-gray-300">Body Fat:</span>
                                                    <span className="font-medium">{measurement.bodyFat}%</span>
                                                </div>
                                            )}
                                            {measurement.bloodPressure && (
                                                <div className="flex justify-between">
                                                    <span className="text-gray-300">BP:</span>
                                                    <span className="font-medium">{measurement.bloodPressure}</span>
                                                </div>
                                            )}
                                            {measurement.circumference && Object.values(measurement.circumference).some(v => v) && (
                                                <div className="mt-2 pt-2 border-t">
                                                    <p className="text-xs text-gray-500 mb-1">Circumference Data Available</p>
                                                </div>
                                            )}
                                            {measurement.caliper && Object.values(measurement.caliper).some(v => v) && (
                                                <div className="mt-2 pt-2 border-t">
                                                    <p className="text-xs text-gray-500 mb-1">Caliper Data Available</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="col-span-full text-center text-gray-400 py-8">
                                    No measurements recorded yet. Click "Add Measurement" to get started.
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };
        
        // Enhanced Nutrition Component with Meal Planning
        const Nutrition = ({ user, isClient, showError, showSuccess }) => {
            const [nutrition, setNutrition] = useState(null);
            const [selectedClient, setSelectedClient] = useState(isClient ? user._id : null);
            const [clients, setClients] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [editingNutrition, setEditingNutrition] = useState(null);
            const [formData, setFormData] = useState({
                protein: { target: 0, current: 0 },
                carbs: { target: 0, current: 0 },
                fat: { target: 0, current: 0 },
                calories: { target: 0, current: 0 },
                mealPlan: {
                    breakfast: '',
                    lunch: '',
                    dinner: '',
                    snacks: ''
                }
            });
            
            useEffect(() => {
                if (!isClient && (user.roles?.includes('specialist') || user.roles?.includes('admin') || user.roles?.includes('owner'))) {
                    fetchClients();
                }
                if (selectedClient) {
                    fetchNutrition();
                }
            }, [selectedClient, isClient]);
            
            const fetchClients = async () => {
    const clients = await ClientManager.loadClients();
    setClients(clients);
};
            
      const fetchNutrition = async () => {
    try {
        const data = await API_CONFIG.request(`/nutrition/client/${selectedClient}`);
        console.log('Nutrition data received:', data);
        const nutritionData = data;
        console.log('Nutrition data processed:', nutritionData);
        setNutrition(nutritionData);
        if (nutritionData) {
            setFormData({
                protein: nutritionData.protein || { target: 0, current: 0 },
                carbs: nutritionData.carbs || { target: 0, current: 0 },
                fat: nutritionData.fat || { target: 0, current: 0 },
                calories: nutritionData.calories || { target: 0, current: 0 },
                mealPlan: nutritionData.mealPlan || {
                    breakfast: '',
                    lunch: '',
                    dinner: '',
                    snacks: ''
                }
            });
        }
    } catch (error) {
        console.error('Error fetching nutrition:', error);
        // Set default empty structure on error
        setNutrition(null);
        setFormData({
            protein: { target: 0, current: 0 },
            carbs: { target: 0, current: 0 },
            fat: { target: 0, current: 0 },
            calories: { target: 0, current: 0 },
            mealPlan: {
                breakfast: '',
                lunch: '',
                dinner: '',
                snacks: ''
            }
        });
    }
};
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                   const method = editingNutrition ? 'PUT' : 'POST';
                   const endpoint = editingNutrition 
    ? `/nutrition/client/${selectedClient}/${editingNutrition}`
    : `/nutrition/client/${selectedClient}`;
await API_CONFIG.request(endpoint, {
                        method,
                        body: JSON.stringify(formData)
                    });
                    showSuccess('Nutrition plan saved successfully');
                 setEditingNutrition(null);
                    setShowForm(false);
                    fetchNutrition();
                } catch (error) {
                    showError(error.message);
                }
            };
            
            const handleLog = async () => {
                const logData = {
                    protein: prompt('Protein consumed today (g):'),
                    carbs: prompt('Carbs consumed today (g):'),
                    fat: prompt('Fat consumed today (g):')
                };
                
                if (logData.protein && logData.carbs && logData.fat) {
                    const calories = (logData.protein * 4) + (logData.carbs * 4) + (logData.fat * 9);
                    try {
                        await API_CONFIG.request(`/nutrition/client/${selectedClient}/log`, {
                            method: 'POST',
                            body: JSON.stringify({
                                ...logData,
                                calories
                            })
                        });
                        showSuccess('Daily nutrition logged successfully');
                        fetchNutrition();
                    } catch (error) {
                        showError(error.message);
                    }
                }
            };
            
            const calculatePercentage = (current, target) => {
                if (!target || target === 0) return 0;
                return Math.min(Math.round((current / target) * 100), 100);
            };
            
            return (
                <div className="space-y-6">
                    <div className="dark-card p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold text-white">
                                {isClient ? 'My Nutrition' : 'Nutrition Plans'}
                            </h2>
                            {selectedClient && (
                                <div className="flex gap-2">
                                    {isClient && (
                                        <button onClick={handleLog} className="coastal-button bg-green-500">
                                            <i className="fas fa-plus mr-2"></i>
                                            Log Today
                                        </button>
                                    )}
                                    {!isClient && (
                                        <button onClick={() => setShowForm(true)} className="coastal-button">
                                            <i className="fas fa-edit mr-2"></i>
                                            {nutrition ? 'Edit Plan' : 'Create Plan'}
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>
                        
                        {!isClient && (
                            <select
                                className="coastal-input"
                                value={selectedClient || ''}
                                onChange={(e) => setSelectedClient(e.target.value)}
                            >
                                <option value="">Select a client...</option>
                                {clients.map(client => (
                                    <option key={client._id} value={client._id}>
                                        {client.name}
                                    </option>
                                ))}
                            </select>
                        )}
                    </div>
                    
                    {showForm && (
                        <div className="dark-card p-6">
                            <h3 className="text-xl font-semibold mb-4">Nutrition Plan</h3>
                            <form onSubmit={handleSubmit}>
                                <div className="mb-6">
                                    <h4 className="font-semibold mb-3">Daily Macro Targets</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Protein (g)</label>
                                            <input
                                                type="number"
                                                className="coastal-input"
                                                value={formData.protein.target}
                                                onChange={(e) => setFormData({
                                                    ...formData,
                                                    protein: {...formData.protein, target: parseInt(e.target.value)}
                                                })}
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Carbs (g)</label>
                                            <input
                                                type="number"
                                                className="coastal-input"
                                                value={formData.carbs.target}
                                                onChange={(e) => setFormData({
                                                    ...formData,
                                                    carbs: {...formData.carbs, target: parseInt(e.target.value)}
                                                })}
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Fat (g)</label>
                                            <input
                                                type="number"
                                                className="coastal-input"
                                                value={formData.fat.target}
                                                onChange={(e) => setFormData({
                                                    ...formData,
                                                    fat: {...formData.fat, target: parseInt(e.target.value)}
                                                })}
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Calories</label>
                                            <input
                                                type="number"
                                                className="coastal-input"
                                                value={formData.calories.target}
                                                onChange={(e) => setFormData({
                                                    ...formData,
                                                    calories: {...formData.calories, target: parseInt(e.target.value)}
                                                })}
                                                required
                                            />
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="mb-6">
                                    <h4 className="font-semibold mb-3">Daily Meal Plan</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-2">
                                                <span className="mr-2">üç≥</span>Breakfast
                                            </label>
                                            <textarea
                                                className="coastal-input"
                                                rows="2"
                                                value={formData.mealPlan.breakfast}
                                                onChange={(e) => setFormData({
                                                    ...formData,
                                                    mealPlan: {...formData.mealPlan, breakfast: e.target.value}
                                                })}
                                                placeholder="e.g., Oatmeal with berries and protein powder"
                                            ></textarea>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">
                                                <span className="mr-2">ü•ó</span>Lunch
                                            </label>
                                            <textarea
                                                className="coastal-input"
                                                rows="2"
                                                value={formData.mealPlan.lunch}
                                                onChange={(e) => setFormData({
                                                    ...formData,
                                                    mealPlan: {...formData.mealPlan, lunch: e.target.value}
                                                })}
                                                placeholder="e.g., Grilled chicken salad with quinoa"
                                            ></textarea>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">
                                                <span className="mr-2">üçΩÔ∏è</span>Dinner
                                            </label>
                                            <textarea
                                                className="coastal-input"
                                                rows="2"
                                                value={formData.mealPlan.dinner}
                                                onChange={(e) => setFormData({
                                                    ...formData,
                                                    mealPlan: {...formData.mealPlan, dinner: e.target.value}
                                                })}
                                                placeholder="e.g., Salmon with vegetables and sweet potato"
                                            ></textarea>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">
                                                <span className="mr-2">üçé</span>Snacks
                                            </label>
                                            <textarea
                                                className="coastal-input"
                                                rows="2"
                                                value={formData.mealPlan.snacks}
                                                onChange={(e) => setFormData({
                                                    ...formData,
                                                    mealPlan: {...formData.mealPlan, snacks: e.target.value}
                                                })}
                                                placeholder="e.g., Greek yogurt, nuts, protein shake"
                                            ></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="flex gap-4">
                                    <button type="submit" className="coastal-button">
                                        Save Plan
                                    </button>
                                    <button type="button" onClick={() => setShowForm(false)} className="coastal-button bg-gray-600 hover:bg-gray-700">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}
                    
                    {nutrition && selectedClient && (
                        <>
                            {/* Macro Tracking Cards */}
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div className="dark-card p-6">
                                    <h4 className="font-semibold mb-2 flex items-center">
                                        <span className="text-2xl mr-2">ü•©</span>
                                        Protein
                                    </h4>
                                    <p className="text-2xl font-bold text-white">
                                        {nutrition.protein?.current || 0}g / {nutrition.protein?.target || 0}g
                                    </p>
                                    <div className="mt-3">
                                        <div className="progress-bar">
                                            <div 
                                                className="progress-bar-fill bg-blue-500"
                                                style={{width: `${calculatePercentage(nutrition.protein?.current, nutrition.protein?.target)}%`}}
                                            ></div>
                                        </div>
                                        <p className="text-sm text-gray-400 mt-1">
                                            {calculatePercentage(nutrition.protein?.current, nutrition.protein?.target)}% of daily goal
                                        </p>
                                    </div>
                                </div>
                                
                                <div className="dark-card p-6">
                                    <h4 className="font-semibold mb-2 flex items-center">
                                        <span className="text-2xl mr-2">üåæ</span>
                                        Carbs
                                    </h4>
                                    <p className="text-2xl font-bold text-white">
                                        {nutrition.carbs?.current || 0}g / {nutrition.carbs?.target || 0}g
                                    </p>
                                    <div className="mt-3">
                                        <div className="progress-bar">
                                            <div 
                                                className="progress-bar-fill bg-yellow-500"
                                                style={{width: `${calculatePercentage(nutrition.carbs?.current, nutrition.carbs?.target)}%`}}
                                            ></div>
                                        </div>
                                        <p className="text-sm text-gray-400 mt-1">
                                            {calculatePercentage(nutrition.carbs?.current, nutrition.carbs?.target)}% of daily goal
                                        </p>
                                    </div>
                                </div>
                                
                                <div className="dark-card p-6">
                                    <h4 className="font-semibold mb-2 flex items-center">
                                        <span className="text-2xl mr-2">ü•ë</span>
                                        Fat
                                    </h4>
                                    <p className="text-2xl font-bold text-white">
                                        {nutrition.fat?.current || 0}g / {nutrition.fat?.target || 0}g
                                    </p>
                                    <div className="mt-3">
                                        <div className="progress-bar">
                                            <div 
                                                className="progress-bar-fill bg-green-500"
                                                style={{width: `${calculatePercentage(nutrition.fat?.current, nutrition.fat?.target)}%`}}
                                            ></div>
                                        </div>
                                        <p className="text-sm text-gray-400 mt-1">
                                            {calculatePercentage(nutrition.fat?.current, nutrition.fat?.target)}% of daily goal
                                        </p>
                                    </div>
                                </div>
                                
                                <div className="dark-card p-6">
                                    <h4 className="font-semibold mb-2 flex items-center">
                                        <span className="text-2xl mr-2">üî•</span>
                                        Calories
                                    </h4>
                                    <p className="text-2xl font-bold text-white">
                                        {nutrition.calories?.current || 0} / {nutrition.calories?.target || 0}
                                    </p>
                                    <div className="mt-3">
                                        <div className="progress-bar">
                                            <div 
                                                className="progress-bar-fill bg-purple-500"
                                                style={{width: `${calculatePercentage(nutrition.calories?.current, nutrition.calories?.target)}%`}}
                                            ></div>
                                        </div>
                                        <p className="text-sm text-gray-400 mt-1">
                                            {calculatePercentage(nutrition.calories?.current, nutrition.calories?.target)}% of daily goal
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Meal Plan Display */}
                            {nutrition.mealPlan && Object.values(nutrition.mealPlan).some(meal => meal) && (
                                <div className="dark-card p-6">
                                    <h3 className="text-xl font-bold mb-4">Daily Meal Plan</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {nutrition.mealPlan.breakfast && (
                                            <div className="p-4 bg-gray-800 rounded-lg">
                                                <h4 className="font-semibold mb-2">
                                                    <span className="mr-2">üç≥</span>Breakfast
                                                </h4>
                                                <p className="text-gray-700">{nutrition.mealPlan.breakfast}</p>
                                            </div>
                                        )}
                                        {nutrition.mealPlan.lunch && (
                                            <div className="p-4 bg-gray-800 rounded-lg">
                                                <h4 className="font-semibold mb-2">
                                                    <span className="mr-2">ü•ó</span>Lunch
                                                </h4>
                                                <p className="text-gray-700">{nutrition.mealPlan.lunch}</p>
                                            </div>
                                        )}
                                        {nutrition.mealPlan.dinner && (
                                            <div className="p-4 bg-gray-800 rounded-lg">
                                                <h4 className="font-semibold mb-2">
                                                    <span className="mr-2">üçΩÔ∏è</span>Dinner
                                                </h4>
                                                <p className="text-gray-700">{nutrition.mealPlan.dinner}</p>
                                            </div>
                                        )}
                                        {nutrition.mealPlan.snacks && (
                                            <div className="p-4 bg-gray-800 rounded-lg">
                                                <h4 className="font-semibold mb-2">
                                                    <span className="mr-2">üçé</span>Snacks
                                                </h4>
                                                <p className="text-gray-700">{nutrition.mealPlan.snacks}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </>
                    )}
                </div>
            );
        };
       const Wearables = ({ user, showError, showSuccess }) => {
    const [connections, setConnections] = useState([]);
    const [wearableData, setWearableData] = useState([]);
    const [insights, setInsights] = useState(null);
    const [showManualEntry, setShowManualEntry] = useState(false);
    const [selectedMetric, setSelectedMetric] = useState('steps');
    const [healthMetrics, setHealthMetrics] = useState({
        heartRate: { current: 0, zones: [], trend: 'stable' },
        sleep: { score: 0, duration: 0, deep: 0, rem: 0, light: 0, awake: 0 },
        recovery: { score: 0, hrv: 0, restingHR: 0 },
        activity: { steps: 0, activeMinutes: 0, calories: 0, distance: 0 }
    });
    const [syncing, setSyncing] = useState(null);
    const [manualData, setManualData] = useState({
        date: new Date().toISOString().split('T')[0],
        steps: '',
        distance: '',
        activeMinutes: '',
        sleepDuration: '',
        caloriesBurned: '',
        restingHeartRate: ''
    });
    
    const providers = [
        { id: 'fitbit', name: 'Fitbit', icon: 'üèÉ', color: 'bg-teal-500' },
        { id: 'apple', name: 'Apple Watch', icon: '‚åö', color: 'bg-gray-800' },
        { id: 'garmin', name: 'Garmin', icon: 'üèîÔ∏è', color: 'bg-blue-600' },
        { id: 'whoop', name: 'WHOOP', icon: 'üí™', color: 'bg-black' },
        { id: 'oura', name: 'Oura Ring', icon: 'üíç', color: 'bg-purple-600' },
        { id: 'polar', name: 'Polar', icon: '‚ùÑÔ∏è', color: 'bg-red-500' }
    ];
    
    const metrics = [
        { id: 'steps', label: 'Steps', icon: 'üë£', unit: 'steps' },
        { id: 'distance', label: 'Distance', icon: 'üìè', unit: 'miles' },
        { id: 'activeMinutes', label: 'Active Minutes', icon: '‚è±Ô∏è', unit: 'min' },
        { id: 'caloriesBurned', label: 'Calories', icon: 'üî•', unit: 'cal' },
        { id: 'sleepDuration', label: 'Sleep', icon: 'üò¥', unit: 'hrs' },
        { id: 'restingHeartRate', label: 'Resting HR', icon: '‚ù§Ô∏è', unit: 'bpm' },
        { id: 'hrv', label: 'HRV', icon: 'üìä', unit: 'ms' }
    ];
    
    
    const fetchConnections = async () => {
        try {
            const response = await API_CONFIG.request('/wearables/connections');
            let connectionsData = [];
            if (Array.isArray(response)) {
                connectionsData = response;
            } else if (response.connections && Array.isArray(response.connections)) {
                connectionsData = response.connections;
            } else if (response.data && Array.isArray(response.data)) {
                connectionsData = response.data;
            }
            setConnections(connectionsData);
        } catch (error) {
            console.error('Error fetching connections:', error);
            setConnections([]);
        }
    };
    
    const fetchWearableData = async () => {
        try {
            const response = await API_CONFIG.request(`/wearables/user/${user._id}?days=30`);
            let wearableDataArray = [];
            if (Array.isArray(response)) {
                wearableDataArray = response;
            } else if (response.data && Array.isArray(response.data)) {
                wearableDataArray = response.data;
            } else if (response.wearableData && Array.isArray(response.wearableData)) {
                wearableDataArray = response.wearableData;
            }
            setWearableData(wearableDataArray);
        } catch (error) {
            console.error('Error fetching wearable data:', error);
            setWearableData([]);
        }
    };
    
    const fetchInsights = async () => {
        try {
            const response = await API_CONFIG.request(`/wearables/insights/${user._id}?days=7`);
            let insightsData = null;
            if (response.insights) {
                insightsData = response.insights;
            } else if (response.data) {
                insightsData = response.data;
            } else {
                insightsData = response;
            }
            setInsights(insightsData);
        } catch (error) {
            console.error('Error fetching insights:', error);
            setInsights(null);
        }
    };
    
    const fetchHealthMetrics = async () => {
    try {
        // Fetch last 2 days to ensure we have complete data
        const recent = await API_CONFIG.request(`/wearables/user/${user._id}?days=2`);
        const recentArray = Array.isArray(recent) ? recent : (recent.data || []);
        
        // Sort by date descending (most recent first)
        recentArray.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // Smart selection: Use today if it has data, otherwise yesterday
        let recentData = {};
        
        if (recentArray.length > 0) {
            const today = recentArray[0];
            const yesterday = recentArray[1];
            
            // Use today if it has meaningful activity OR sleep data
            if (today && (today.steps > 100 || today.sleepDuration > 0)) {
                recentData = today;
            } else if (yesterday) {
                // Fall back to yesterday's complete data
                recentData = yesterday;
                console.log('‚ö†Ô∏è Using yesterday\'s data (today incomplete)');
            } else {
                recentData = today || {};
            }
        }
        
        // Fetch 7-day data for training load chart
        const weekData = await API_CONFIG.request(`/wearables/user/${user._id}?days=7`);
        const weekArray = Array.isArray(weekData) ? weekData : (weekData.data || []);
        setWearableData(weekArray);
        
        setHealthMetrics({
            heartRate: {
                current: recentData.restingHeartRate || 0,
                zones: recentData.heartRateZones || [],
                trend: 'stable'
            },
            sleep: {
                score: recentData.sleepScore || 0,
                duration: recentData.sleepDuration || 0,
                deep: recentData.deepSleep || 0,
                rem: recentData.remSleep || 0,
                light: recentData.lightSleep || 0,
                awake: recentData.awakeTime || 0,
                efficiency: recentData.sleepEfficiency || 0
            },
            recovery: {
                score: recentData.recoveryScore || 0,
                hrv: recentData.hrv || 0,
                restingHR: recentData.restingHeartRate || 0
            },
            activity: {
                steps: recentData.steps || 0,
                activeMinutes: recentData.activeMinutes || 0,
                calories: recentData.caloriesBurned || 0,
                distance: recentData.distance || 0
            }
        });
    } catch (error) {
        console.error('Error fetching health metrics:', error);
    }
};
    
    const handleConnect = async (provider) => {
        try {
            const response = await fetch(`${API_CONFIG.baseURL}/wearables/connect/${provider}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (response.ok && data.authUrl) {
                window.location.href = data.authUrl;
            } else {
                showError(data.error || 'Failed to initiate connection');
            }
        } catch (error) {
            showError('Failed to connect: ' + error.message);
        }
    };
    
const handleSync = async (provider) => {
    setSyncing(provider);
    try {
        const response = await fetch(`${API_CONFIG.baseURL}/wearables/sync/${provider}`, {
            method: 'POST',
            headers: API_CONFIG.getHeaders()
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(`${provider} synced successfully!`);
            
            // Update health metrics with synced data
            if (result.data) {
                setHealthMetrics({
                    heartRate: {
                        current: result.data.restingHeartRate || 0,
                        zones: [],
                        trend: 'stable'
                    },
                    sleep: {
                        score: 0,
                        duration: result.data.sleepDuration || 0,
                        deep: result.data.deepSleep || 0,
                        rem: result.data.remSleep || 0,
                        light: result.data.lightSleep || 0,
                        awake: 0
                    },
                    recovery: {
                        score: 0,
                        hrv: 0,
                        restingHR: result.data.restingHeartRate || 0
                    },
                    activity: {
                        steps: result.data.steps || 0,
                        activeMinutes: result.data.activeMinutes || 0,
                        calories: result.data.caloriesBurned || 0,
                        distance: result.data.distance || 0
                    }
                });
            }
            
            // Refresh connections and insights
            fetchConnections();
            fetchHealthMetrics();
        } else {
            showError(result.error || 'Sync failed');
        }
    } catch (error) {
        showError('Failed to sync: ' + error.message);
    } finally {
        setSyncing(null);
    }
};

 useEffect(() => {
        fetchConnections();
        fetchWearableData();
        fetchInsights();
        fetchHealthMetrics();
    }, []);
           
    const handleDisconnect = async (provider) => {
        if (confirm(`Disconnect ${provider}?`)) {
            try {
                await API_CONFIG.request(`/wearables/disconnect/${provider}`, {
                    method: 'DELETE'
                });
                showSuccess(`${provider} disconnected`);
                fetchConnections();
            } catch (error) {
                showError(error.message);
            }
        }
    };
    
    const handleManualSubmit = async (e) => {
        e.preventDefault();
        try {
            await API_CONFIG.request(`/wearables/user/${user._id}/manual`, {
                method: 'POST',
                body: JSON.stringify(manualData)
            });
            showSuccess('Data logged successfully');
            setShowManualEntry(false);
            fetchWearableData();
            fetchInsights();
            fetchHealthMetrics();
        } catch (error) {
            showError(error.message);
        }
    };
    
    const isConnected = (providerId) => {
        return connections.some(c => c.provider === providerId && c.connected);
    };
    
    const safeGet = (obj, path, defaultValue = 0) => {
        try {
            const value = path.split('.').reduce((acc, part) => acc && acc[part], obj);
            return value !== undefined && value !== null ? value : defaultValue;
        } catch {
            return defaultValue;
        }
    };
    
    const RecoveryRing = ({ score, label }) => {
        const percentage = Math.min(score, 100);
        const strokeDasharray = 2 * Math.PI * 45;
        const strokeDashoffset = strokeDasharray - (strokeDasharray * percentage) / 100;
        
        return (
            <div className="relative w-32 h-32">
                <svg className="transform -rotate-90 w-32 h-32">
                    <circle cx="64" cy="64" r="45" stroke="#374151" strokeWidth="8" fill="none" />
                    <circle 
                        cx="64" cy="64" r="45" 
                        stroke={percentage >= 70 ? '#10b981' : percentage >= 40 ? '#f59e0b' : '#ef4444'}
                        strokeWidth="8" 
                        fill="none"
                        strokeDasharray={strokeDasharray}
                        strokeDashoffset={strokeDashoffset}
                        className="transition-all duration-1000"
                    />
                </svg>
                <div className="absolute inset-0 flex flex-col items-center justify-center">
                    <span className="text-2xl font-bold text-white">{Math.round(score)}</span>
                    <span className="text-xs text-gray-400">{label}</span>
                </div>
            </div>
        );
    };
    
    return (
        <div className="space-y-6">
            {/* ULTIMATE HEALTH METRICS DASHBOARD */}
         <div className="dark-card p-6">
    <h2 className="text-2xl font-bold mb-6 text-white flex items-center justify-between">
        <span>Health Metrics Dashboard</span>
        <span className="text-sm text-gray-400 font-normal">
            Last synced: {new Date().toLocaleTimeString()}
        </span>
    </h2>  
                {/* Recovery & Sleep Rings */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div className="bg-gray-800 rounded-lg p-6 flex flex-col items-center">
                        <RecoveryRing score={healthMetrics.recovery.score} label="Recovery" />
                        <div className="mt-4 text-center">
                            <p className="text-sm text-gray-400">HRV: {healthMetrics.recovery.hrv} ms</p>
                            <p className="text-sm text-gray-400">Resting HR: {healthMetrics.recovery.restingHR} bpm</p>
                        </div>
                    </div>
                    
                    <div className="bg-gray-800 rounded-lg p-6 flex flex-col items-center">
                        <RecoveryRing score={healthMetrics.sleep.score} label="Sleep Score" />
                        <div className="mt-4 text-center">
                            <p className="text-sm text-gray-400">
                                Duration: {Math.floor(healthMetrics.sleep.duration / 60)}h {healthMetrics.sleep.duration % 60}m
                            </p>
                        </div>
                    </div>
                    
                    <div className="bg-gray-800 rounded-lg p-6">
                        <h4 className="text-sm font-semibold text-gray-300 mb-3">Sleep Architecture</h4>
                        <div className="space-y-2">
                            <div>
                                <div className="flex justify-between text-xs mb-1">
                                    <span className="text-gray-400">Deep</span>
                                    <span className="text-purple-400">{healthMetrics.sleep.deep} min</span>
                                </div>
                                <div className="h-2 bg-gray-700 rounded">
                                    <div 
                                        className="h-full bg-purple-500 rounded"
                                        style={{width: `${(healthMetrics.sleep.deep / healthMetrics.sleep.duration * 100) || 0}%`}}
                                    ></div>
                                </div>
                            </div>
                            <div>
                                <div className="flex justify-between text-xs mb-1">
                                    <span className="text-gray-400">REM</span>
                                    <span className="text-blue-400">{healthMetrics.sleep.rem} min</span>
                                </div>
                                <div className="h-2 bg-gray-700 rounded">
                                    <div 
                                        className="h-full bg-blue-500 rounded"
                                        style={{width: `${(healthMetrics.sleep.rem / healthMetrics.sleep.duration * 100) || 0}%`}}
                                    ></div>
                                </div>
                            </div>
                            <div>
                                <div className="flex justify-between text-xs mb-1">
                                    <span className="text-gray-400">Light</span>
                                    <span className="text-green-400">{healthMetrics.sleep.light} min</span>
                                </div>
                                <div className="h-2 bg-gray-700 rounded">
                                    <div 
                                        className="h-full bg-green-500 rounded"
                                        style={{width: `${(healthMetrics.sleep.light / healthMetrics.sleep.duration * 100) || 0}%`}}
                                    ></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {/* Activity Metrics */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div className="bg-gradient-to-br from-blue-900 to-blue-800 rounded-lg p-4">
                        <div className="text-3xl mb-2">üë£</div>
                        <div className="text-2xl font-bold text-white">{healthMetrics.activity.steps.toLocaleString()}</div>
                        <div className="text-xs text-gray-300">Steps Today</div>
                    </div>
                    
                    <div className="bg-gradient-to-br from-orange-900 to-orange-800 rounded-lg p-4">
                        <div className="text-3xl mb-2">üî•</div>
                        <div className="text-2xl font-bold text-white">{healthMetrics.activity.calories}</div>
                        <div className="text-xs text-gray-300">Calories Burned</div>
                    </div>
                    
                    <div className="bg-gradient-to-br from-green-900 to-green-800 rounded-lg p-4">
                        <div className="text-3xl mb-2">‚è±Ô∏è</div>
                        <div className="text-2xl font-bold text-white">{healthMetrics.activity.activeMinutes}</div>
                        <div className="text-xs text-gray-300">Active Minutes</div>
                    </div>
                    
                    <div className="bg-gradient-to-br from-purple-900 to-purple-800 rounded-lg p-4">
                        <div className="text-3xl mb-2">üìè</div>
                        <div className="text-2xl font-bold text-white">{healthMetrics.activity.distance.toFixed(1)}</div>
                        <div className="text-xs text-gray-300">Miles</div>
                    </div>
                </div>
                
                {/* Heart Rate Zones */}
                {healthMetrics.heartRate.zones.length > 0 && (
                    <div className="bg-gray-800 rounded-lg p-4 mb-6">
                        <h4 className="text-sm font-semibold text-gray-300 mb-3">Heart Rate Zones Today</h4>
                        <div className="space-y-2">
                            {healthMetrics.heartRate.zones.map((zone, i) => (
                                <div key={i}>
                                    <div className="flex justify-between text-xs mb-1">
                                        <span className="text-gray-400">{zone.name}</span>
                                        <span className="text-gray-300">{zone.minutes} min</span>
                                    </div>
                                    <div className="h-2 bg-gray-700 rounded overflow-hidden">
                                        <div 
                                            className={`h-full ${
                                                i === 0 ? 'bg-gray-500' :
                                                i === 1 ? 'bg-blue-500' :
                                                i === 2 ? 'bg-green-500' :
                                                i === 3 ? 'bg-yellow-500' :
                                                'bg-red-500'
                                            }`}
                                            style={{width: `${zone.percentage}%`}}
                                        ></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>
            
            {/* Device Connections */}
            <div className="dark-card p-6">
                <h2 className="text-2xl font-bold mb-4 text-white">Wearable Devices</h2>
                
              <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
    {providers.map(provider => {
        const connected = isConnected(provider.id);
        const isAvailable = provider.id === 'fitbit' || provider.id === 'polar';
        
        return (
            <div key={provider.id} className={`p-4 rounded-lg border-2 transition ${
                connected ? 'border-green-500 bg-green-900 bg-opacity-20' : 'border-gray-600 hover:border-gray-500 bg-gray-800'
            }`}>
                <div className="text-center">
                    <div className="text-4xl mb-2">{provider.icon}</div>
                    <h3 className="font-semibold text-white">{provider.name}</h3>
                    {isAvailable ? (
                        <span className="text-xs text-green-400 block mt-1 font-semibold">
                            <i className="fas fa-check-circle mr-1"></i>Active
                        </span>
                    ) : (
                        <span className="text-xs text-yellow-400 block mt-1">Coming Soon</span>
                    )}
                   {isAvailable && (
    connected ? (
        <div className="flex flex-col gap-2 mt-2">
            <button
                onClick={() => handleSync(provider.id)}
                className="coastal-button text-sm py-1 px-3 bg-blue-600 hover:bg-blue-700"
                disabled={syncing === provider.id}
            >
                {syncing === provider.id ? (
                    <>
                        <i className="fas fa-spinner fa-spin mr-1"></i>
                        Syncing...
                    </>
                ) : (
                    <>
                        <i className="fas fa-sync mr-1"></i>
                        Sync Now
                    </>
                )}
            </button>
            <button
                onClick={() => handleDisconnect(provider.id)}
                className="text-sm text-red-400 hover:text-red-300"
            >
                Disconnect
            </button>
        </div>
    ) : (
        <button
            onClick={() => handleConnect(provider.id)}
            className="mt-2 coastal-button text-sm py-1 px-3"
        >
            Connect
        </button>
    )
)}
                </div>
            </div>
        );
    })}
</div>
                
                <button
                    onClick={() => setShowManualEntry(true)}
                    className="coastal-button bg-purple-600 hover:bg-purple-700"
                >
                    <i className="fas fa-keyboard mr-2"></i>
                    Manual Entry
                </button>
            </div>
            
            {/* Insights */}
            {insights && insights.averages && (
                <div className="dark-card p-6">
                    <h3 className="text-xl font-bold mb-4 text-white">7-Day Insights</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="metric-card">
                            <div className="text-sm text-gray-400">Avg Steps</div>
                            <div className="text-2xl font-bold text-white">
                                {safeGet(insights, 'averages.steps', 0).toLocaleString()}
                            </div>
                            <div className={`text-sm ${
                                safeGet(insights, 'trends.steps') === 'improving' ? 'text-green-400' :
                                safeGet(insights, 'trends.steps') === 'declining' ? 'text-red-400' : 'text-gray-400'
                            }`}>
                                {safeGet(insights, 'trends.steps') === 'improving' && '‚ÜóÔ∏è Improving'}
                                {safeGet(insights, 'trends.steps') === 'declining' && '‚ÜòÔ∏è Declining'}
                                {safeGet(insights, 'trends.steps') === 'stable' && '‚Üí Stable'}
                                {!insights.trends?.steps && '‚Äî'}
                            </div>
                        </div>
                        
                        <div className="metric-card">
                            <div className="text-sm text-gray-400">Avg Sleep</div>
                            <div className="text-2xl font-bold text-white">
                                {Math.floor(safeGet(insights, 'averages.sleep', 0) / 60)}h {safeGet(insights, 'averages.sleep', 0) % 60}m
                            </div>
                        </div>
                        
                        <div className="metric-card">
                            <div className="text-sm text-gray-400">Active Minutes</div>
                            <div className="text-2xl font-bold text-white">
                                {safeGet(insights, 'averages.activeMinutes', 0)}
                            </div>
                        </div>
                        
                        <div className="metric-card">
                            <div className="text-sm text-gray-400">Resting HR</div>
                            <div className="text-2xl font-bold text-white">
                                {safeGet(insights, 'averages.restingHR', 0) || '--'}
                            </div>
                        </div>
                    </div>
                    
                    {insights.streaks && (
                        <div className="mt-4 grid grid-cols-2 gap-4">
                            <div className="bg-blue-900 bg-opacity-30 rounded-lg p-3">
                                <div className="text-sm text-gray-400">10K Steps Streak</div>
                                <div className="text-xl font-bold text-white">
                                    {safeGet(insights, 'streaks.steps.current', 0)} days
                                </div>
                                <div className="text-xs text-gray-500">
                                    Best: {safeGet(insights, 'streaks.steps.max', 0)} days
                                </div>
                            </div>
                            
                            <div className="bg-purple-900 bg-opacity-30 rounded-lg p-3">
                                <div className="text-sm text-gray-400">7+ Hour Sleep Streak</div>
                                <div className="text-xl font-bold text-white">
                                    {safeGet(insights, 'streaks.sleep.current', 0)} days
                                </div>
                                <div className="text-xs text-gray-500">
                                    Best: {safeGet(insights, 'streaks.sleep.max', 0)} days
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            )}
            
            {!insights && (
                <div className="dark-card p-6 text-center">
                    <p className="text-gray-400">
                        No insights available yet. Connect a wearable device or log manual data to see insights.
                    </p>
                </div>
            )}
            
            {/* Manual Entry Modal */}
            {showManualEntry && (
                <div className="modal-overlay" onClick={() => setShowManualEntry(false)}>
                    <div className="modal-content max-w-2xl" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-xl font-bold mb-4 text-white">Manual Entry</h3>
                        <form onSubmit={handleManualSubmit}>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm font-medium mb-2 text-gray-300">Date</label>
                                    <input
                                        type="date"
                                        className="coastal-input"
                                        value={manualData.date}
                                        onChange={(e) => setManualData({...manualData, date: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2 text-gray-300">Steps</label>
                                    <input
                                        type="number"
                                        className="coastal-input"
                                        value={manualData.steps}
                                        onChange={(e) => setManualData({...manualData, steps: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2 text-gray-300">Distance (miles)</label>
                                    <input
                                        type="number"
                                        step="0.1"
                                        className="coastal-input"
                                        value={manualData.distance}
                                        onChange={(e) => setManualData({...manualData, distance: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2 text-gray-300">Active Minutes</label>
                                    <input
                                        type="number"
                                        className="coastal-input"
                                        value={manualData.activeMinutes}
                                        onChange={(e) => setManualData({...manualData, activeMinutes: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2 text-gray-300">Sleep (minutes)</label>
                                    <input
                                        type="number"
                                        className="coastal-input"
                                        value={manualData.sleepDuration}
                                        onChange={(e) => setManualData({...manualData, sleepDuration: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2 text-gray-300">Calories Burned</label>
                                    <input
                                        type="number"
                                        className="coastal-input"
                                        value={manualData.caloriesBurned}
                                        onChange={(e) => setManualData({...manualData, caloriesBurned: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2 text-gray-300">Resting HR</label>
                                    <input
                                        type="number"
                                        className="coastal-input"
                                        value={manualData.restingHeartRate}
                                        onChange={(e) => setManualData({...manualData, restingHeartRate: e.target.value})}
                                    />
                                </div>
                            </div>
                            <div className="flex gap-4">
                                <button type="submit" className="coastal-button">Save Data</button>
                                <button 
                                    type="button" 
                                    onClick={() => setShowManualEntry(false)}
                                    className="coastal-button bg-gray-600 hover:bg-gray-700"
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
        </div>
    );
};
        
// Enhanced Reports Component - Replace entire Reports component with this
const Reports = ({ user, isClient, showSuccess, showError }) => {
    const [selectedClient, setSelectedClient] = useState(isClient ? user._id : null);
    const [clients, setClients] = useState([]);
    const [reportType, setReportType] = useState('progress');
    
    useEffect(() => {
        if (!isClient && (user.roles?.includes('specialist') || user.roles?.includes('admin') || user.roles?.includes('owner'))) {
            fetchClients();
        }
    }, [isClient]);
    
    const fetchClients = async () => {
    const clients = await ClientManager.loadClients();
    setClients(clients);
};
    
    const generateReport = async () => {
        if (!selectedClient) {
            showError('Please select a client');
            return;
        }
        
        try {
            // Fetch ALL available data for comprehensive report
            const [workouts, measurements, nutrition, goals, tests] = await Promise.all([
                API_CONFIG.request(`/workouts/client/${selectedClient}`),
                API_CONFIG.request(`/measurements/client/${selectedClient}`),
                API_CONFIG.request(`/nutrition/client/${selectedClient}`),
                API_CONFIG.request(`/goals/client/${selectedClient}`),
                API_CONFIG.request(`/tests/client/${selectedClient}`).catch(() => ({ data: [] }))
            ]);
            
            const clientName = isClient ? user.name : clients.find(c => c._id === selectedClient)?.name;
            
            // Process and normalize data
            const workoutsData = Array.isArray(workouts) ? workouts : (workouts.data || []);
            const measurementsData = Array.isArray(measurements) ? measurements : (measurements.data || []);
            const goalsData = Array.isArray(goals) ? goals : (goals.data || []);
            const testsData = Array.isArray(tests) ? tests : (tests.data || []);
            const nutritionData = nutrition;
            
            // Calculate comprehensive metrics
            const metrics = calculateAllMetrics(workoutsData, measurementsData, nutritionData, goalsData);
            
            // Generate report based on type
            let report = '';
            if (reportType === 'progress') {
                report = generateComprehensiveProgressReport(clientName, metrics, {
                    workouts: workoutsData,
                    measurements: measurementsData,
                    nutrition: nutritionData,
                    goals: goalsData,
                    tests: testsData
                });
            } else if (reportType === 'workout') {
                report = generateDetailedWorkoutReport(clientName, workoutsData, metrics.workoutMetrics);
            } else if (reportType === 'nutrition') {
                report = generateDetailedNutritionReport(clientName, nutritionData, metrics.nutritionMetrics);
            }
            
            // Ask for export format
            const format = prompt('Export format? (txt, json, csv)', 'txt');
            
            if (format === 'json') {
                // Comprehensive JSON export with all data and metrics
                const exportData = {
                    exportInfo: {
                        date: new Date().toISOString(),
                        clientId: selectedClient,
                        clientName: clientName,
                        reportType: reportType,
                        dataRange: {
                            earliest: metrics.dateRange.earliest,
                            latest: metrics.dateRange.latest,
                            daysTracked: metrics.dateRange.totalDays
                        }
                    },
                    metrics: metrics,
                    rawData: {
                        workouts: workoutsData,
                        measurements: measurementsData,
                        nutrition: nutritionData,
                        goals: goalsData,
                        tests: testsData
                    }
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${reportType}-report-${clientName}-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } else if (format === 'csv') {
                const csvContent = generateCSVReport(reportType, clientName, metrics, {
                    workouts: workoutsData,
                    measurements: measurementsData,
                    nutrition: nutritionData,
                    goals: goalsData
                });
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${reportType}-report-${clientName}-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            } else {
                // Default text format
                const blob = new Blob([report], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${reportType}-report-${clientName}-${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            showSuccess('Report generated successfully');
        } catch (error) {
            console.error('Error generating report:', error);
            showError('Failed to generate report');
        }
    };
    
    // Master metrics calculator
    const calculateAllMetrics = (workouts, measurements, nutrition, goals) => {
        const now = new Date();
        
        // Date range calculation
        const allDates = [
            ...workouts.map(w => new Date(w.createdAt || w.scheduledDate)),
            ...measurements.map(m => new Date(m.date)),
            ...goals.map(g => new Date(g.createdAt))
        ].filter(d => d && !isNaN(d));
        
        const dateRange = {
            earliest: allDates.length ? new Date(Math.min(...allDates)) : now,
            latest: allDates.length ? new Date(Math.max(...allDates)) : now,
            totalDays: 0
        };
        dateRange.totalDays = Math.ceil((dateRange.latest - dateRange.earliest) / (1000 * 60 * 60 * 24)) || 1;
        
        // Workout metrics
        const completedWorkouts = workouts.filter(w => w.completed);
        const workoutMetrics = {
            total: workouts.length,
            completed: completedWorkouts.length,
            completionRate: workouts.length ? Math.round((completedWorkouts.length / workouts.length) * 100) : 0,
            frequency: {
                perWeek: dateRange.totalDays > 0 ? ((completedWorkouts.length / dateRange.totalDays) * 7).toFixed(1) : 0,
                perMonth: dateRange.totalDays > 0 ? ((completedWorkouts.length / dateRange.totalDays) * 30).toFixed(1) : 0
            },
            moodAverage: completedWorkouts.length ? 
                (completedWorkouts.reduce((sum, w) => sum + (w.moodFeedback || 3), 0) / completedWorkouts.length).toFixed(1) : 0,
            exerciseVolume: calculateExerciseVolume(workouts),
            strengthProgress: calculateStrengthProgress(workouts)
        };
        
        // Body composition metrics
        const sortedMeasurements = measurements.sort((a, b) => new Date(a.date) - new Date(b.date));
        const bodyMetrics = {
            weightChange: calculateWeightChange(sortedMeasurements),
            bodyFatChange: calculateBodyFatChange(sortedMeasurements),
            circumferenceChanges: calculateCircumferenceChanges(sortedMeasurements),
            bmi: calculateBMI(sortedMeasurements),
            trending: determineTrend(sortedMeasurements)
        };
        
        // Nutrition metrics
        const nutritionMetrics = {
            proteinAdherence: calculateMacroAdherence(nutrition?.protein),
            carbsAdherence: calculateMacroAdherence(nutrition?.carbs),
            fatAdherence: calculateMacroAdherence(nutrition?.fat),
            calorieAdherence: calculateMacroAdherence(nutrition?.calories),
            overallAdherence: calculateOverallNutritionAdherence(nutrition),
            dailyAverages: calculateDailyAverages(nutrition)
        };
        
        // Goals metrics
        const activeGoals = goals.filter(g => !g.isHabit && !g.completed);
        const completedGoals = goals.filter(g => !g.isHabit && g.completed);
        const habits = goals.filter(g => g.isHabit);
        
        const goalsMetrics = {
            totalGoals: goals.filter(g => !g.isHabit).length,
            activeGoals: activeGoals.length,
            completedGoals: completedGoals.length,
            goalCompletionRate: goals.filter(g => !g.isHabit).length ? 
                Math.round((completedGoals.length / goals.filter(g => !g.isHabit).length) * 100) : 0,
            averageProgress: calculateAverageGoalProgress(activeGoals),
            habits: {
                total: habits.length,
                weeklyAdherence: calculateHabitAdherence(habits)
            }
        };
        
        return {
            dateRange,
            workoutMetrics,
            bodyMetrics,
            nutritionMetrics,
            goalsMetrics,
            summary: {
                totalDataPoints: workouts.length + measurements.length + goals.length,
                overallProgress: calculateOverallProgress(workoutMetrics, bodyMetrics, goalsMetrics)
            }
        };
    };
    
    // Helper calculation functions
    const calculateExerciseVolume = (workouts) => {
        const exerciseData = {};
        workouts.forEach(w => {
            w.exercises?.forEach(e => {
                if (!exerciseData[e.name]) {
                    exerciseData[e.name] = {
                        totalSets: 0,
                        totalReps: 0,
                        totalVolume: 0,
                        maxWeight: 0,
                        sessions: 0
                    };
                }
                exerciseData[e.name].totalSets += e.sets || 0;
                exerciseData[e.name].totalReps += (e.sets * e.reps) || 0;
                exerciseData[e.name].totalVolume += (e.sets * e.reps * e.weight) || 0;
                exerciseData[e.name].maxWeight = Math.max(exerciseData[e.name].maxWeight, e.weight || 0);
                exerciseData[e.name].sessions++;
            });
        });
        return exerciseData;
    };
    
    const calculateStrengthProgress = (workouts) => {
        const exerciseProgress = {};
        const sortedWorkouts = workouts.sort((a, b) => new Date(a.createdAt || a.scheduledDate) - new Date(b.createdAt || b.scheduledDate));
        
        sortedWorkouts.forEach(w => {
            w.exercises?.forEach(e => {
                if (e.weight > 0) {
                    if (!exerciseProgress[e.name]) {
                        exerciseProgress[e.name] = { first: e.weight, last: e.weight, max: e.weight };
                    }
                    exerciseProgress[e.name].last = e.weight;
                    exerciseProgress[e.name].max = Math.max(exerciseProgress[e.name].max, e.weight);
                }
            });
        });
        
        Object.keys(exerciseProgress).forEach(exercise => {
            const data = exerciseProgress[exercise];
            data.improvement = ((data.last - data.first) / data.first * 100).toFixed(1);
            data.percentToMax = ((data.last / data.max) * 100).toFixed(1);
        });
        
        return exerciseProgress;
    };
    
    const calculateWeightChange = (measurements) => {
        if (measurements.length < 2) return { total: 0, percent: 0, rate: 0 };
        const first = measurements[0];
        const last = measurements[measurements.length - 1];
        const daysBetween = Math.ceil((new Date(last.date) - new Date(first.date)) / (1000 * 60 * 60 * 24));
        
        return {
            total: (last.weight - first.weight).toFixed(1),
            percent: ((last.weight - first.weight) / first.weight * 100).toFixed(1),
            rate: daysBetween > 0 ? ((last.weight - first.weight) / daysBetween * 7).toFixed(2) : 0,
            current: last.weight,
            starting: first.weight
        };
    };
    
    const calculateBodyFatChange = (measurements) => {
        const withBodyFat = measurements.filter(m => m.bodyFat);
        if (withBodyFat.length < 2) return { total: 0, percent: 0 };
        
        const first = withBodyFat[0];
        const last = withBodyFat[withBodyFat.length - 1];
        
        return {
            total: (last.bodyFat - first.bodyFat).toFixed(1),
            percent: ((last.bodyFat - first.bodyFat) / first.bodyFat * 100).toFixed(1),
            current: last.bodyFat,
            starting: first.bodyFat
        };
    };
    
    const calculateCircumferenceChanges = (measurements) => {
        const withCirc = measurements.filter(m => m.circumference);
        if (withCirc.length < 2) return {};
        
        const first = withCirc[0].circumference || {};
        const last = withCirc[withCirc.length - 1].circumference || {};
        const changes = {};
        
        Object.keys(last).forEach(key => {
            if (first[key] && last[key]) {
                changes[key] = {
                    change: (last[key] - first[key]).toFixed(1),
                    percent: ((last[key] - first[key]) / first[key] * 100).toFixed(1)
                };
            }
        });
        
        return changes;
    };
    
    const calculateBMI = (measurements) => {
        if (!measurements.length) return null;
        const latest = measurements[measurements.length - 1];
        // Assuming average height of 5'9" (69 inches) - would need height in user profile
        const heightInches = 69;
        const bmi = (latest.weight / (heightInches * heightInches)) * 703;
        return bmi.toFixed(1);
    };
    
    const determineTrend = (measurements) => {
        if (measurements.length < 3) return 'insufficient data';
        
        const recentMeasurements = measurements.slice(-5);
        let increases = 0;
        let decreases = 0;
        
        for (let i = 1; i < recentMeasurements.length; i++) {
            if (recentMeasurements[i].weight > recentMeasurements[i-1].weight) increases++;
            else if (recentMeasurements[i].weight < recentMeasurements[i-1].weight) decreases++;
        }
        
        if (increases > decreases) return 'gaining';
        if (decreases > increases) return 'losing';
        return 'maintaining';
    };
    
    const calculateMacroAdherence = (macro) => {
        if (!macro || !macro.target) return 0;
        return Math.min(Math.round((macro.current / macro.target) * 100), 100);
    };
    
    const calculateOverallNutritionAdherence = (nutrition) => {
        if (!nutrition) return 0;
        const adherences = [
            calculateMacroAdherence(nutrition.protein),
            calculateMacroAdherence(nutrition.carbs),
            calculateMacroAdherence(nutrition.fat),
            calculateMacroAdherence(nutrition.calories)
        ].filter(a => a > 0);
        
        return adherences.length ? Math.round(adherences.reduce((a, b) => a + b) / adherences.length) : 0;
    };
    
    const calculateDailyAverages = (nutrition) => {
        if (!nutrition?.dailyLogs || nutrition.dailyLogs.length === 0) {
            return {
                protein: nutrition?.protein?.current || 0,
                carbs: nutrition?.carbs?.current || 0,
                fat: nutrition?.fat?.current || 0,
                calories: nutrition?.calories?.current || 0
            };
        }
        
        const logs = nutrition.dailyLogs;
        return {
            protein: Math.round(logs.reduce((sum, log) => sum + (log.protein || 0), 0) / logs.length),
            carbs: Math.round(logs.reduce((sum, log) => sum + (log.carbs || 0), 0) / logs.length),
            fat: Math.round(logs.reduce((sum, log) => sum + (log.fat || 0), 0) / logs.length),
            calories: Math.round(logs.reduce((sum, log) => sum + (log.calories || 0), 0) / logs.length)
        };
    };
    
    const calculateAverageGoalProgress = (goals) => {
        if (!goals.length) return 0;
        
        const progresses = goals.map(goal => {
            if (!goal.target) return 0;
            if (goal.startingValue > goal.target) {
                // Decrease goal
                const totalDecrease = goal.startingValue - goal.target;
                const currentDecrease = goal.startingValue - goal.current;
                return Math.min(Math.round((currentDecrease / totalDecrease) * 100), 100);
            } else {
                // Increase goal
                return Math.min(Math.round((goal.current / goal.target) * 100), 100);
            }
        });
        
        return Math.round(progresses.reduce((a, b) => a + b, 0) / progresses.length);
    };
    
    const calculateHabitAdherence = (habits) => {
        if (!habits.length) return 0;
        
        const today = new Date();
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        let totalScheduled = 0;
        let totalCompleted = 0;
        
        habits.forEach(habit => {
            if (habit.scheduledDays && habit.completions) {
                for (let d = new Date(weekAgo); d <= today; d.setDate(d.getDate() + 1)) {
                    const dayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][d.getDay()];
                    if (habit.scheduledDays.includes(dayName)) {
                        totalScheduled++;
                        if (habit.completions[d.toDateString()]) {
                            totalCompleted++;
                        }
                    }
                }
            }
        });
        
        return totalScheduled > 0 ? Math.round((totalCompleted / totalScheduled) * 100) : 0;
    };
    
    const calculateOverallProgress = (workout, body, goals) => {
        const factors = [
            workout.completionRate,
            goals.goalCompletionRate,
            goals.averageProgress
        ].filter(f => f > 0);
        
        return factors.length ? Math.round(factors.reduce((a, b) => a + b) / factors.length) : 0;
    };
    
    // Enhanced report generators
    const generateComprehensiveProgressReport = (clientName, metrics, rawData) => {
        let report = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        report += `               ClockWork COMPREHENSIVE PROGRESS REPORT\n`;
        report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
        report += `CLIENT: ${clientName}\n`;
        report += `REPORT DATE: ${new Date().toLocaleDateString()}\n`;
        report += `TRACKING PERIOD: ${metrics.dateRange.earliest.toLocaleDateString()} to ${metrics.dateRange.latest.toLocaleDateString()}\n`;
        report += `TOTAL DAYS TRACKED: ${metrics.dateRange.totalDays}\n\n`;
        
        report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        report += `                          EXECUTIVE SUMMARY\n`;
        report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        report += `Overall Progress Score: ${metrics.summary.overallProgress}%\n`;
        report += `Total Data Points: ${metrics.summary.totalDataPoints}\n`;
        report += `Current Status: ${determineTrend(rawData.measurements)}\n\n`;
        
        report += `KEY ACHIEVEMENTS:\n`;
        if (metrics.bodyMetrics.weightChange.total < 0) {
            report += `‚úì Weight Loss: ${Math.abs(metrics.bodyMetrics.weightChange.total)} lbs\n`;
        }
        if (metrics.bodyMetrics.bodyFatChange.total < 0) {
            report += `‚úì Body Fat Reduction: ${Math.abs(metrics.bodyMetrics.bodyFatChange.total)}%\n`;
        }
        if (metrics.workoutMetrics.completionRate >= 80) {
            report += `‚úì Excellent Workout Adherence: ${metrics.workoutMetrics.completionRate}%\n`;
        }
        if (metrics.goalsMetrics.completedGoals > 0) {
            report += `‚úì Goals Completed: ${metrics.goalsMetrics.completedGoals}\n`;
        }
        report += `\n`;
        
        report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        report += `                         WORKOUT ANALYSIS\n`;
        report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        report += `Total Workouts: ${metrics.workoutMetrics.total}\n`;
        report += `Completed: ${metrics.workoutMetrics.completed}\n`;
        report += `Completion Rate: ${metrics.workoutMetrics.completionRate}%\n`;
        report += `Frequency: ${metrics.workoutMetrics.frequency.perWeek} per week\n`;
        report += `Average Mood Rating: ${metrics.workoutMetrics.moodAverage}/5\n\n`;
        
        report += `STRENGTH PROGRESS:\n`;
        report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
        Object.entries(metrics.workoutMetrics.strengthProgress).slice(0, 5).forEach(([exercise, data]) => {
            report += `${exercise}:\n`;
            report += `  Starting: ${data.first} lbs ‚Üí Current: ${data.last} lbs\n`;
            report += `  Improvement: ${data.improvement}% | Max: ${data.max} lbs\n`;
        });
        report += `\n`;
        
        report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        report += `                      BODY COMPOSITION\n`;
        report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        report += `WEIGHT TRACKING:\n`;
        report += `  Starting: ${metrics.bodyMetrics.weightChange.starting} lbs\n`;
        report += `  Current: ${metrics.bodyMetrics.weightChange.current} lbs\n`;
        report += `  Total Change: ${metrics.bodyMetrics.weightChange.total} lbs (${metrics.bodyMetrics.weightChange.percent}%)\n`;
        report += `  Weekly Rate: ${metrics.bodyMetrics.weightChange.rate} lbs/week\n`;
        report += `  Current BMI: ${metrics.bodyMetrics.bmi || 'N/A'}\n\n`;
        
        if (metrics.bodyMetrics.bodyFatChange.current) {
            report += `BODY FAT:\n`;
            report += `  Starting: ${metrics.bodyMetrics.bodyFatChange.starting}%\n`;
            report += `  Current: ${metrics.bodyMetrics.bodyFatChange.current}%\n`;
            report += `  Change: ${metrics.bodyMetrics.bodyFatChange.total}% (${metrics.bodyMetrics.bodyFatChange.percent}%)\n\n`;
        }
        
        if (Object.keys(metrics.bodyMetrics.circumferenceChanges).length > 0) {
            report += `CIRCUMFERENCE CHANGES:\n`;
            Object.entries(metrics.bodyMetrics.circumferenceChanges).forEach(([area, data]) => {
                report += `  ${area}: ${data.change}" (${data.percent}%)\n`;
            });
            report += `\n`;
        }
        
        report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        report += `                        NUTRITION TRACKING\n`;
        report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        report += `Overall Adherence: ${metrics.nutritionMetrics.overallAdherence}%\n\n`;
        report += `MACRO ADHERENCE:\n`;
        report += `  Protein: ${metrics.nutritionMetrics.proteinAdherence}%\n`;
        report += `  Carbohydrates: ${metrics.nutritionMetrics.carbsAdherence}%\n`;
        report += `  Fat: ${metrics.nutritionMetrics.fatAdherence}%\n`;
        report += `  Calories: ${metrics.nutritionMetrics.calorieAdherence}%\n\n`;
        report += `DAILY AVERAGES:\n`;
        report += `  Protein: ${metrics.nutritionMetrics.dailyAverages.protein}g\n`;
        report += `  Carbs: ${metrics.nutritionMetrics.dailyAverages.carbs}g\n`;
        report += `  Fat: ${metrics.nutritionMetrics.dailyAverages.fat}g\n`;
        report += `  Calories: ${metrics.nutritionMetrics.dailyAverages.calories}\n\n`;
        
        report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        report += `                        GOALS & HABITS\n`;
        report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        report += `GOALS:\n`;
        report += `  Total: ${metrics.goalsMetrics.totalGoals}\n`;
        report += `  Active: ${metrics.goalsMetrics.activeGoals}\n`;
        report += `  Completed: ${metrics.goalsMetrics.completedGoals}\n`;
        report += `  Completion Rate: ${metrics.goalsMetrics.goalCompletionRate}%\n`;
        report += `  Average Progress: ${metrics.goalsMetrics.averageProgress}%\n\n`;
        report += `HABITS:\n`;
        report += `  Total Tracked: ${metrics.goalsMetrics.habits.total}\n`;
        report += `  Weekly Adherence: ${metrics.goalsMetrics.habits.weeklyAdherence}%\n\n`;
        
        report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        report += `                     RECOMMENDATIONS\n`;
        report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        
        // Generate recommendations based on metrics
        if (metrics.workoutMetrics.completionRate < 70) {
            report += `‚Ä¢ Focus on improving workout consistency (currently ${metrics.workoutMetrics.completionRate}%)\n`;
        }
        if (metrics.workoutMetrics.frequency.perWeek < 3) {
            report += `‚Ä¢ Increase workout frequency to at least 3x per week\n`;
        }
        if (metrics.nutritionMetrics.proteinAdherence < 80) {
            report += `‚Ä¢ Improve protein intake consistency\n`;
        }
        if (metrics.goalsMetrics.averageProgress < 50) {
            report += `‚Ä¢ Review and adjust current goals for better achievability\n`;
        }
        if (metrics.workoutMetrics.moodAverage < 3) {
            report += `‚Ä¢ Consider adjusting workout intensity or recovery periods\n`;
        }
        
        report += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        report += `                    END OF REPORT\n`;
        report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        
        return report;
    };
    
    const generateDetailedWorkoutReport = (clientName, workouts, metrics) => {
        let report = `ClockWork WORKOUT ANALYSIS REPORT\n`;
        report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
        report += `Client: ${clientName}\n`;
        report += `Report Date: ${new Date().toLocaleDateString()}\n\n`;
        
        report += `SUMMARY STATISTICS\n`;
        report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
        report += `Total Workouts: ${metrics.total}\n`;
        report += `Completed: ${metrics.completed}\n`;
        report += `Completion Rate: ${metrics.completionRate}%\n`;
        report += `Weekly Frequency: ${metrics.frequency.perWeek}\n`;
        report += `Monthly Frequency: ${metrics.frequency.perMonth}\n`;
        report += `Average Mood: ${metrics.moodAverage}/5\n\n`;
        
        report += `EXERCISE VOLUME ANALYSIS\n`;
        report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
        Object.entries(metrics.exerciseVolume).forEach(([exercise, data]) => {
            report += `\n${exercise}:\n`;
            report += `  Total Sessions: ${data.sessions}\n`;
            report += `  Total Sets: ${data.totalSets}\n`;
            report += `  Total Reps: ${data.totalReps}\n`;
            report += `  Total Volume: ${data.totalVolume} lbs\n`;
            report += `  Max Weight: ${data.maxWeight} lbs\n`;
        });
        
        report += `\n\nSTRENGTH PROGRESSION\n`;
        report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
        Object.entries(metrics.strengthProgress).forEach(([exercise, data]) => {
            report += `\n${exercise}:\n`;
            report += `  Starting Weight: ${data.first} lbs\n`;
            report += `  Current Weight: ${data.last} lbs\n`;
            report += `  Maximum Weight: ${data.max} lbs\n`;
            report += `  Improvement: ${data.improvement}%\n`;
            report += `  Current vs Max: ${data.percentToMax}%\n`;
        });
        
        report += `\n\nWORKOUT HISTORY\n`;
        report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
        workouts.slice(-10).forEach(workout => {
            report += `\n${workout.name} - ${new Date(workout.scheduledDate || workout.createdAt).toLocaleDateString()}\n`;
            report += `  Status: ${workout.completed ? 'Completed' : 'Pending'}\n`;
            if (workout.moodFeedback) report += `  Mood: ${workout.moodFeedback}/5\n`;
            report += `  Exercises: ${workout.exercises?.length || 0}\n`;
        });
        
        return report;
    };
    
    const generateDetailedNutritionReport = (clientName, nutrition, metrics) => {
        let report = `ClockWork NUTRITION ANALYSIS REPORT\n`;
        report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
        report += `Client: ${clientName}\n`;
        report += `Report Date: ${new Date().toLocaleDateString()}\n\n`;
        
        report += `ADHERENCE SUMMARY\n`;
        report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
        report += `Overall Adherence: ${metrics.overallAdherence}%\n`;
        report += `Protein: ${metrics.proteinAdherence}%\n`;
        report += `Carbohydrates: ${metrics.carbsAdherence}%\n`;
        report += `Fat: ${metrics.fatAdherence}%\n`;
        report += `Calories: ${metrics.calorieAdherence}%\n\n`;
        
        if (nutrition) {
            report += `CURRENT TARGETS\n`;
            report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            report += `Protein: ${nutrition.protein?.target || 0}g\n`;
            report += `Carbs: ${nutrition.carbs?.target || 0}g\n`;
            report += `Fat: ${nutrition.fat?.target || 0}g\n`;
            report += `Calories: ${nutrition.calories?.target || 0}\n\n`;
            
            report += `CURRENT INTAKE\n`;
            report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            report += `Protein: ${nutrition.protein?.current || 0}g\n`;
            report += `Carbs: ${nutrition.carbs?.current || 0}g\n`;
            report += `Fat: ${nutrition.fat?.current || 0}g\n`;
            report += `Calories: ${nutrition.calories?.current || 0}\n\n`;
            
            if (nutrition.mealPlan) {
                report += `MEAL PLAN\n`;
                report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                if (nutrition.mealPlan.breakfast) report += `Breakfast: ${nutrition.mealPlan.breakfast}\n`;
                if (nutrition.mealPlan.lunch) report += `Lunch: ${nutrition.mealPlan.lunch}\n`;
                if (nutrition.mealPlan.dinner) report += `Dinner: ${nutrition.mealPlan.dinner}\n`;
                if (nutrition.mealPlan.snacks) report += `Snacks: ${nutrition.mealPlan.snacks}\n`;
            }
        }
        
        return report;
    };
    
    const generateCSVReport = (reportType, clientName, metrics, rawData) => {
        let csv = '';
        
        if (reportType === 'progress') {
            csv = 'Metric,Value,Target,Percentage\n';
            csv += `Workout Completion,${metrics.workoutMetrics.completed},${metrics.workoutMetrics.total},${metrics.workoutMetrics.completionRate}%\n`;
            csv += `Weight Change,${metrics.bodyMetrics.weightChange.total} lbs,N/A,${metrics.bodyMetrics.weightChange.percent}%\n`;
            csv += `Goals Completed,${metrics.goalsMetrics.completedGoals},${metrics.goalsMetrics.totalGoals},${metrics.goalsMetrics.goalCompletionRate}%\n`;
            csv += `Nutrition Adherence,${metrics.nutritionMetrics.overallAdherence}%,100%,${metrics.nutritionMetrics.overallAdherence}%\n`;
            csv += `\nDate,Weight,BodyFat,WorkoutCompleted\n`;
            
            rawData.measurements.forEach(m => {
                const workoutOnDate = rawData.workouts.find(w => 
                    new Date(w.scheduledDate).toDateString() === new Date(m.date).toDateString()
                );
                csv += `${new Date(m.date).toLocaleDateString()},${m.weight || ''},${m.bodyFat || ''},${workoutOnDate?.completed ? 'Yes' : 'No'}\n`;
            });
        } else if (reportType === 'workout') {
            csv = 'Date,Workout,Exercise,Sets,Reps,Weight,Volume,Completed,Mood\n';
            rawData.workouts.forEach(w => {
                w.exercises?.forEach(e => {
                    const volume = e.sets * e.reps * e.weight;
                    csv += `${new Date(w.scheduledDate || w.createdAt).toLocaleDateString()},${w.name},${e.name},${e.sets},${e.reps},${e.weight || 0},${volume},${w.completed ? 'Yes' : 'No'},${w.moodFeedback || ''}\n`;
                });
            });
        } else if (reportType === 'nutrition') {
            csv = 'Macro,Target,Current,Adherence\n';
            if (rawData.nutrition) {
                csv += `Protein,${rawData.nutrition.protein?.target || 0},${rawData.nutrition.protein?.current || 0},${metrics.nutritionMetrics.proteinAdherence}%\n`;
                csv += `Carbs,${rawData.nutrition.carbs?.target || 0},${rawData.nutrition.carbs?.current || 0},${metrics.nutritionMetrics.carbsAdherence}%\n`;
                csv += `Fat,${rawData.nutrition.fat?.target || 0},${rawData.nutrition.fat?.current || 0},${metrics.nutritionMetrics.fatAdherence}%\n`;
                csv += `Calories,${rawData.nutrition.calories?.target || 0},${rawData.nutrition.calories?.current || 0},${metrics.nutritionMetrics.calorieAdherence}%\n`;
            }
        }
        
        return csv;
    };
    
    return (
        <div className="space-y-6">
            <div className="dark-card p-6">
                <h2 className="text-2xl font-bold mb-4">
                    {isClient ? 'My Reports' : 'Generate Reports'}
                </h2>
                
                {!isClient && (
                    <select
                        className="coastal-input mb-4"
                        value={selectedClient || ''}
                        onChange={(e) => setSelectedClient(e.target.value)}
                    >
                        <option value="">Select a client...</option>
                        {clients.map(client => (
                            <option key={client._id} value={client._id}>
                                {client.name}
                            </option>
                        ))}
                    </select>
                )}
                
                {selectedClient && (
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div 
                            onClick={() => setReportType('progress')}
                            className={`cursor-pointer p-6 rounded-lg border-2 transition ${
                                reportType === 'progress' 
                                    ? 'border-blue-500 bg-blue-900 bg-opacity-30'  
                                    : 'border-gray-600 hover:border-gray-500 bg-gray-800'
                            }`}
                        >
                            <div className="text-center">
                                <span className="text-3xl">üìä</span>
                                <h3 className="font-semibold mt-2">Progress Report</h3>
                                <p className="text-sm text-gray-400 mt-1">Comprehensive analysis</p>
                            </div>
                        </div>
                        
                        <div 
                            onClick={() => setReportType('workout')}
                            className={`cursor-pointer p-6 rounded-lg border-2 transition ${
                                reportType === 'workout' 
                                    ? 'border-blue-500 bg-blue-900 bg-opacity-30'  
                                    : 'border-gray-600 hover:border-gray-500 bg-gray-800'
                            }`}
                        >
                            <div className="text-center">
                                <span className="text-3xl">üí™</span>
                                <h3 className="font-semibold mt-2">Workout Analysis</h3>
                                <p className="text-sm text-gray-400 mt-1">Exercise & strength data</p>
                            </div>
                        </div>
                        
                        <div 
                            onClick={() => setReportType('nutrition')}
                            className={`cursor-pointer p-6 rounded-lg border-2 transition ${
                                reportType === 'nutrition' 
                                    ? 'border-blue-500 bg-blue-900 bg-opacity-30'  
                                    : 'border-gray-600 hover:border-gray-500 bg-gray-800'
                            }`}
                        >
                            <div className="text-center">
                                <span className="text-3xl">ü•ó</span>
                                <h3 className="font-semibold mt-2">Nutrition Analysis</h3>
                                <p className="text-sm text-gray-400 mt-1">Macro & adherence data</p>
                            </div>
                        </div>
                    </div>
                )}
                
                {selectedClient && (
                    <button 
                        onClick={generateReport}
                        className="coastal-button mt-6"
                    >
                        <i className="fas fa-download mr-2"></i>
                        Generate {reportType === 'progress' ? 'Comprehensive Progress' : reportType === 'workout' ? 'Workout Analysis' : 'Nutrition Analysis'} Report
                    </button>
                )}
            </div>
        </div>
    );
};
        // === CALENDAR & SCHEDULING SYSTEM ===
// === CALENDAR & SCHEDULING SYSTEM WITH BACKEND + SMS ===
const Calendar = ({ user, showError, showSuccess }) => {
    const [view, setView] = useState('week');
    const [selectedDate, setSelectedDate] = useState(new Date());
    const [classes, setClasses] = useState([]);
    const [showClassForm, setShowClassForm] = useState(false);
    const [selectedClass, setSelectedClass] = useState(null);
    const [formData, setFormData] = useState({
        name: '',
        type: 'group',
        date: DateHandler.getCurrentETDate(),
        time: '09:00',
        duration: 60,
        capacity: 20,
        pricing: { amount: 0, timing: 'pre-pay' },
        description: ''
    });
    
    const isClient = user.roles?.includes('client');
    const canManage = user.roles?.includes('specialist') || user.roles?.includes('admin') || user.roles?.includes('owner');
    
    useEffect(() => {
        if (user.gymId) {
            fetchClasses();
        }
    }, [user.gymId]);
    
    // CONNECTED TO YOUR BACKEND
   const fetchClasses = async () => {
    try {
        // DEMO FIX: Use fallback gymId if user doesn't have one
        const gymId = user.gymId || 'demo-gym-123';
        
        const response = await API_CONFIG.request(`/classes/gym/${gymId}`);
        setClasses(Array.isArray(response) ? response : (response.data || []));
    } catch (error) {
        console.error('Error fetching classes:', error);
        setClasses([]); // Show empty calendar instead of crashing
    }
};
    
    // CONNECTED TO YOUR BACKEND
    const handleCreateClass = async (e) => {
    e.preventDefault();
    try {
        const classDate = new Date(`${formData.date}T${formData.time}`);
        
        // DEMO FIX: Use fallback gymId if user doesn't have one
        const gymId = user.gymId || 'demo-gym-123';
        await API_CONFIG.request(`/classes/gym/${gymId}`, {
            method: 'POST',
            body: JSON.stringify({
                ...formData,
                date: classDate.toISOString(),
                instructorId: user._id
            })
        });
        
        showSuccess('Class created successfully!');
        showSMSNotification(`SMS sent to instructor: Your ${formData.name} class is scheduled for ${formData.date} at ${formData.time}`);
        
        setShowClassForm(false);
        fetchClasses();
    } catch (error) {
        showError(error.message);
    }
};
    
    // CONNECTED TO YOUR BACKEND
    const handleBookClass = async (classId) => {
        try {
            // Get class details for payment
            const classToBook = classes.find(c => c._id === classId);
            
            // If payment required, process first
            if (classToBook.pricing?.amount > 0 && classToBook.pricing?.timing === 'pre-pay') {
                await API_CONFIG.request('/billing/pay/class', {
                    method: 'POST',
                    body: JSON.stringify({
                        classId: classId,
                        userId: user._id,
                        amount: classToBook.pricing.amount
                    })
                });
            }
            
            // Book the class
            await API_CONFIG.request(`/classes/${classId}/book`, {
                method: 'POST',
                body: JSON.stringify({ userId: user._id })
            });
            
            showSuccess('Class booked successfully!');
            
            // DEMO SMS NOTIFICATION
            showSMSNotification(`SMS sent to ${user.phone || '555-0123'}: You're booked for ${classToBook.name} on ${new Date(classToBook.date).toLocaleDateString()} at ${new Date(classToBook.date).toLocaleTimeString()}`);
            
            fetchClasses();
        } catch (error) {
            showError(error.message);
        }
    };
    
    // DEMO SMS SYSTEM
    const showSMSNotification = (message) => {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 9999;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        `;
        notification.innerHTML = `
            <div style="display: flex; align-items: start; gap: 12px;">
                <i class="fas fa-sms" style="font-size: 24px;"></i>
                <div>
                    <div style="font-weight: bold; margin-bottom: 4px;">üì± SMS Notification (Demo)</div>
                    <div style="font-size: 14px;">${message}</div>
                </div>
            </div>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    };
    
    const getWeekDays = () => {
        const start = new Date(selectedDate);
        start.setDate(start.getDate() - start.getDay());
        return Array.from({length: 7}, (_, i) => {
            const day = new Date(start);
            day.setDate(start.getDate() + i);
            return day;
        });
    };
    
    const weekDays = getWeekDays();
    
    return (
        <div className="space-y-6">
            <style>{`
                @keyframes slideIn {
                    from { transform: translateX(400px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(400px); opacity: 0; }
                }
            `}</style>
            
            <div className="dark-card p-6">
                <div className="flex justify-between items-center">
                    <h2 className="text-2xl font-bold text-white">
                        {isClient ? 'Browse Classes' : 'Class Schedule'}
                    </h2>
                    <div className="flex items-center gap-4">
                        {canManage && (
                            <button onClick={() => setShowClassForm(true)} className="coastal-button">
                                <i className="fas fa-plus mr-2"></i>Create Class
                            </button>
                        )}
                    </div>
                </div>
            </div>
            
            {/* CLASS CREATION FORM */}
            {showClassForm && (
                <div className="modal-overlay" onClick={() => setShowClassForm(false)}>
                    <div className="modal-content max-w-2xl" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-2xl font-bold text-white mb-6">Create Class</h3>
                        <form onSubmit={handleCreateClass}>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm font-medium mb-2 text-gray-300">Class Name</label>
                                    <input
                                        type="text"
                                        className="coastal-input"
                                        value={formData.name}
                                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                                        placeholder="e.g., Morning HIIT"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2 text-gray-300">Class Type</label>
                                    <select
                                        className="coastal-input"
                                        value={formData.type}
                                        onChange={(e) => setFormData({...formData, type: e.target.value})}
                                    >
                                        <option value="group">Group Class</option>
                                        <option value="1on1">1-on-1 Session</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2 text-gray-300">Date</label>
                                    <input
                                        type="date"
                                        className="coastal-input"
                                        value={formData.date}
                                        onChange={(e) => setFormData({...formData, date: e.target.value})}
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2 text-gray-300">Time</label>
                                    <input
                                        type="time"
                                        className="coastal-input"
                                        value={formData.time}
                                        onChange={(e) => setFormData({...formData, time: e.target.value})}
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2 text-gray-300">Duration (min)</label>
                                    <input
                                        type="number"
                                        className="coastal-input"
                                        value={formData.duration}
                                        onChange={(e) => setFormData({...formData, duration: parseInt(e.target.value)})}
                                        min="15"
                                        step="15"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2 text-gray-300">Capacity</label>
                                    <input
                                        type="number"
                                        className="coastal-input"
                                        value={formData.capacity}
                                        onChange={(e) => setFormData({...formData, capacity: parseInt(e.target.value)})}
                                        min="1"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2 text-gray-300">Price ($)</label>
                                    <input
                                        type="number"
                                        className="coastal-input"
                                        value={formData.pricing.amount}
                                        onChange={(e) => setFormData({
                                            ...formData, 
                                            pricing: {...formData.pricing, amount: parseFloat(e.target.value)}
                                        })}
                                        min="0"
                                        step="0.01"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2 text-gray-300">Payment Timing</label>
                                    <select
                                        className="coastal-input"
                                        value={formData.pricing.timing}
                                        onChange={(e) => setFormData({
                                            ...formData,
                                            pricing: {...formData.pricing, timing: e.target.value}
                                        })}
                                    >
                                        <option value="pre-pay">Pre-Pay</option>
                                        <option value="on-arrival">On Arrival</option>
                                        <option value="post-service">Post-Service</option>
                                        <option value="package">Package</option>
                                    </select>
                                </div>
                                <div className="col-span-2">
                                    <label className="block text-sm font-medium mb-2 text-gray-300">Description</label>
                                    <textarea
                                        className="coastal-input"
                                        rows="3"
                                        value={formData.description}
                                        onChange={(e) => setFormData({...formData, description: e.target.value})}
                                        placeholder="Class details..."
                                    />
                                </div>
                            </div>
                            <div className="flex gap-4">
                                <button type="submit" className="coastal-button flex-1">
                                    Create Class
                                </button>
                                <button type="button" onClick={() => setShowClassForm(false)} className="coastal-button bg-gray-600">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
            
            {/* WEEK CALENDAR GRID */}
            <div className="dark-card p-6">
                <div className="grid grid-cols-7 gap-2">
                    {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => (
                        <div key={day} className="text-center font-bold text-gray-400 pb-4">
                            <div>{day}</div>
                            <div className="text-2xl text-white mt-2">{weekDays[i].getDate()}</div>
                        </div>
                    ))}
                    
                    {weekDays.map((day, i) => {
                        const dayClasses = classes.filter(c => 
                            new Date(c.date).toDateString() === day.toDateString()
                        );
                        
                        return (
                            <div key={i} className="min-h-[200px] bg-gray-800 rounded-lg p-2 space-y-2">
                                {dayClasses.length === 0 ? (
                                    <div className="text-center text-gray-500 text-sm mt-8">No classes</div>
                                ) : (
                                    dayClasses.map(cls => {
                                        const isBooked = cls.booked?.includes(user._id);
                                        const isFull = cls.booked?.length >= cls.capacity;
                                        
                                        return (
                                            <div
                                                key={cls._id}
                                                onClick={() => setSelectedClass(cls)}
                                                className={`p-2 rounded cursor-pointer transition hover:opacity-80 ${
                                                    cls.type === 'group' ? 'bg-blue-900 bg-opacity-50' :
                                                    'bg-green-900 bg-opacity-50'
                                                }`}
                                            >
                                                <div className="text-xs font-bold truncate text-white">{cls.name}</div>
                                                <div className="text-xs text-gray-400">
                                                    {new Date(cls.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                                </div>
                                                <div className="text-xs text-gray-400">
                                                    {cls.booked?.length || 0}/{cls.capacity}
                                                </div>
                                                {cls.pricing?.amount > 0 && (
                                                    <div className="text-xs text-green-400">${cls.pricing.amount}</div>
                                                )}
                                                {isBooked && (
                                                    <div className="text-xs text-green-400 font-bold">‚úì Booked</div>
                                                )}
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>
            
            {/* CLASS DETAILS MODAL */}
            {selectedClass && (
                <div className="modal-overlay" onClick={() => setSelectedClass(null)}>
                    <div className="modal-content max-w-xl" onClick={(e) => e.stopPropagation()}>
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h3 className="text-2xl font-bold text-white">{selectedClass.name}</h3>
                                <span className={`inline-block px-3 py-1 rounded-full text-xs font-semibold mt-2 ${
                                    selectedClass.type === 'group' ? 'bg-blue-500' : 'bg-green-500'
                                }`}>
                                    {selectedClass.type === 'group' ? 'Group Class' : '1-on-1 Session'}
                                </span>
                            </div>
                            <button onClick={() => setSelectedClass(null)} className="text-gray-400 hover:text-white">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div className="space-y-4 mb-6">
                            <div className="flex items-center gap-3 text-gray-300">
                                <i className="fas fa-calendar text-blue-400"></i>
                                <span>{new Date(selectedClass.date).toLocaleDateString('en-US', {
                                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                                })}</span>
                            </div>
                            <div className="flex items-center gap-3 text-gray-300">
                                <i className="fas fa-clock text-blue-400"></i>
                                <span>{new Date(selectedClass.date).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</span>
                                <span className="text-gray-500">({selectedClass.duration} min)</span>
                            </div>
                            <div className="flex items-center gap-3 text-gray-300">
                                <i className="fas fa-users text-blue-400"></i>
                                <span>{selectedClass.booked?.length || 0} / {selectedClass.capacity} enrolled</span>
                            </div>
                            {selectedClass.pricing?.amount > 0 && (
                                <div className="flex items-center gap-3 text-gray-300">
                                    <i className="fas fa-dollar-sign text-green-400"></i>
                                    <span className="text-xl font-bold text-green-400">${selectedClass.pricing.amount}</span>
                                    <span className="text-sm text-gray-500">
                                        ({selectedClass.pricing.timing.replace('-', ' ')})
                                    </span>
                                </div>
                            )}
                            {selectedClass.description && (
                                <div className="bg-gray-800 rounded-lg p-4">
                                    <p className="text-gray-300">{selectedClass.description}</p>
                                </div>
                            )}
                        </div>
                        
                        {isClient && !selectedClass.booked?.includes(user._id) && (
                            <button 
                                onClick={() => {
                                    handleBookClass(selectedClass._id);
                                    setSelectedClass(null);
                                }} 
                                className="coastal-button w-full"
                                disabled={selectedClass.booked?.length >= selectedClass.capacity}
                            >
                                {selectedClass.booked?.length >= selectedClass.capacity ? 'Class Full' : 'Book This Class'}
                            </button>
                        )}
                        
                        {isClient && selectedClass.booked?.includes(user._id) && (
                            <button className="coastal-button bg-green-600 w-full" disabled>
                                <i className="fas fa-check-circle mr-2"></i>
                                You're Booked!
                            </button>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
};
// Class Form Modal
const ClassFormModal = ({ user, onClose, onSuccess, showError }) => {
    const [formData, setFormData] = useState({
        name: '',
        type: 'group',
        date: DateHandler.getCurrentETDate(),
        time: '09:00',
        duration: 60,
        capacity: 20,
        instructorId: user._id,
        pricing: {
            amount: 0,
            timing: 'pre-pay'
        },
        recurrence: 'none',
        description: ''
    });
    
    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            const classDate = new Date(`${formData.date}T${formData.time}`);
            
            await API_CONFIG.createClass(user.gymId, {
                ...formData,
                date: classDate.toISOString()
            });
            
            onSuccess();
        } catch (error) {
            showError(error.message);
        }
    };
    
    return (
        <div className="modal-overlay" onClick={onClose}>
            <div className="modal-content max-w-2xl" onClick={(e) => e.stopPropagation()}>
                <div className="flex justify-between items-center mb-6">
                    <h3 className="text-2xl font-bold text-white">Create Class</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-white">
                        <i className="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form onSubmit={handleSubmit}>
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-sm font-medium mb-2 text-gray-300">Class Name</label>
                            <input
                                type="text"
                                className="coastal-input"
                                value={formData.name}
                                onChange={(e) => setFormData({...formData, name: e.target.value})}
                                placeholder="e.g., Morning HIIT"
                                required
                            />
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium mb-2 text-gray-300">Class Type</label>
                            <select
                                className="coastal-input"
                                value={formData.type}
                                onChange={(e) => setFormData({...formData, type: e.target.value})}
                            >
                                <option value="group">Group Class</option>
                                <option value="1on1">1-on-1 Session</option>
                                <option value="appointment">Appointment</option>
                            </select>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium mb-2 text-gray-300">Date</label>
                            <input
                                type="date"
                                className="coastal-input"
                                value={formData.date}
                                onChange={(e) => setFormData({...formData, date: e.target.value})}
                                required
                            />
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium mb-2 text-gray-300">Time</label>
                            <input
                                type="time"
                                className="coastal-input"
                                value={formData.time}
                                onChange={(e) => setFormData({...formData, time: e.target.value})}
                                required
                            />
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium mb-2 text-gray-300">Duration (minutes)</label>
                            <input
                                type="number"
                                className="coastal-input"
                                value={formData.duration}
                                onChange={(e) => setFormData({...formData, duration: parseInt(e.target.value)})}
                                min="15"
                                step="15"
                            />
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium mb-2 text-gray-300">Capacity</label>
                            <input
                                type="number"
                                className="coastal-input"
                                value={formData.capacity}
                                onChange={(e) => setFormData({...formData, capacity: parseInt(e.target.value)})}
                                min="1"
                            />
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium mb-2 text-gray-300">Price ($)</label>
                            <input
                                type="number"
                                className="coastal-input"
                                value={formData.pricing.amount}
                                onChange={(e) => setFormData({
                                    ...formData, 
                                    pricing: {...formData.pricing, amount: parseFloat(e.target.value)}
                                })}
                                min="0"
                                step="0.01"
                            />
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium mb-2 text-gray-300">Payment Timing</label>
                            <select
                                className="coastal-input"
                                value={formData.pricing.timing}
                                onChange={(e) => setFormData({
                                    ...formData,
                                    pricing: {...formData.pricing, timing: e.target.value}
                                })}
                            >
                                <option value="pre-pay">Pre-Pay (before booking)</option>
                                <option value="on-arrival">On Arrival</option>
                                <option value="post-service">Post-Service</option>
                                <option value="package">Package/Membership</option>
                            </select>
                        </div>
                        
                        <div className="col-span-2">
                            <label className="block text-sm font-medium mb-2 text-gray-300">Recurrence</label>
                            <select
                                className="coastal-input"
                                value={formData.recurrence}
                                onChange={(e) => setFormData({...formData, recurrence: e.target.value})}
                            >
                                <option value="none">One-time only</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        
                        <div className="col-span-2">
                            <label className="block text-sm font-medium mb-2 text-gray-300">Description (optional)</label>
                            <textarea
                                className="coastal-input"
                                rows="3"
                                value={formData.description}
                                onChange={(e) => setFormData({...formData, description: e.target.value})}
                                placeholder="Class details, requirements, what to bring..."
                            />
                        </div>
                    </div>
                    
                    <div className="flex gap-4">
                        <button type="submit" className="coastal-button flex-1">
                            <i className="fas fa-check mr-2"></i>Create Class
                        </button>
                        <button type="button" onClick={onClose} className="coastal-button bg-gray-600 hover:bg-gray-700">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

// Class Details Modal
const ClassDetailsModal = ({ classData, user, isClient, canManage, onClose, onBook, showError, showSuccess }) => {
    const [showPayment, setShowPayment] = useState(false);
    const isBooked = classData.booked?.includes(user._id);
    const isFull = classData.booked?.length >= classData.capacity;
    const spotsLeft = classData.capacity - (classData.booked?.length || 0);
    
    const handleBooking = () => {
        if (classData.pricing?.amount > 0 && classData.pricing?.timing === 'pre-pay') {
            setShowPayment(true);
        } else {
            onBook(classData._id);
            onClose();
        }
    };
    
    const handleDelete = async () => {
        if (confirm('Delete this class?')) {
            try {
                await API_CONFIG.request(`/classes/${classData._id}`, { method: 'DELETE' });
                showSuccess('Class deleted');
                onClose();
            } catch (error) {
                showError(error.message);
            }
        }
    };
    
    return (
        <div className="modal-overlay" onClick={onClose}>
            <div className="modal-content max-w-xl" onClick={(e) => e.stopPropagation()}>
                <div className="flex justify-between items-start mb-4">
                    <div>
                        <h3 className="text-2xl font-bold text-white">{classData.name}</h3>
                        <span className={`inline-block px-3 py-1 rounded-full text-xs font-semibold mt-2 ${
                            classData.type === 'group' ? 'bg-blue-500' :
                            classData.type === '1on1' ? 'bg-green-500' : 'bg-purple-500'
                        }`}>
                            {classData.type === 'group' ? 'Group Class' : 
                             classData.type === '1on1' ? '1-on-1 Session' : 'Appointment'}
                        </span>
                    </div>
                    <button onClick={onClose} className="text-gray-400 hover:text-white">
                        <i className="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div className="space-y-4 mb-6">
                    <div className="flex items-center gap-3 text-gray-300">
                        <i className="fas fa-calendar text-blue-400"></i>
                        <span>{new Date(classData.date).toLocaleDateString('en-US', {
                            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                        })}</span>
                    </div>
                    
                    <div className="flex items-center gap-3 text-gray-300">
                        <i className="fas fa-clock text-blue-400"></i>
                        <span>{new Date(classData.date).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</span>
                        <span className="text-gray-500">({classData.duration || 60} min)</span>
                    </div>
                    
                    <div className="flex items-center gap-3 text-gray-300">
                        <i className="fas fa-users text-blue-400"></i>
                        <span>{classData.booked?.length || 0} / {classData.capacity} enrolled</span>
                        {isFull && <span className="text-red-400 text-sm font-semibold">FULL</span>}
                        {!isFull && spotsLeft <= 3 && (
                            <span className="text-yellow-400 text-sm">Only {spotsLeft} spots left!</span>
                        )}
                    </div>
                    
                    {classData.pricing?.amount > 0 && (
                        <div className="flex items-center gap-3 text-gray-300">
                            <i className="fas fa-dollar-sign text-green-400"></i>
                            <span className="text-xl font-bold text-green-400">${classData.pricing.amount}</span>
                            <span className="text-sm text-gray-500">
                                ({classData.pricing.timing.replace('-', ' ')})
                            </span>
                        </div>
                    )}
                    
                    {classData.description && (
                        <div className="bg-gray-800 rounded-lg p-4">
                            <p className="text-gray-300">{classData.description}</p>
                        </div>
                    )}
                </div>
                
                <div className="flex gap-3">
                    {isClient && !isBooked && !isFull && (
                        <button onClick={handleBooking} className="coastal-button flex-1">
                            <i className="fas fa-check mr-2"></i>
                            Book This Class
                        </button>
                    )}
                    
                    {isClient && isBooked && (
                        <button className="coastal-button bg-green-600 flex-1" disabled>
                            <i className="fas fa-check-circle mr-2"></i>
                            You're Booked!
                        </button>
                    )}
                    
                    {isClient && isFull && !isBooked && (
                        <button className="coastal-button bg-gray-600 flex-1" disabled>
                            <i className="fas fa-ban mr-2"></i>
                            Class Full
                        </button>
                    )}
                    
                    {canManage && (
                        <>
                            <button onClick={() => alert('Edit coming soon')} className="coastal-button">
                                <i className="fas fa-edit"></i>
                            </button>
                            <button onClick={handleDelete} className="coastal-button bg-red-600 hover:bg-red-700">
                                <i className="fas fa-trash"></i>
                            </button>
                        </>
                    )}
                </div>
                
                {showPayment && (
                    <PaymentModal
                        amount={classData.pricing.amount}
                        classData={classData}
                        onSuccess={() => {
                            onBook(classData._id);
                            setShowPayment(false);
                            onClose();
                        }}
                        onClose={() => setShowPayment(false)}
                        showError={showError}
                    />
                )}
            </div>
        </div>
    );
};

// Payment Modal
const PaymentModal = ({ amount, classData, onSuccess, onClose, showError }) => {
    const [processing, setProcessing] = useState(false);
    const [cardInfo, setCardInfo] = useState({
        number: '',
        expiry: '',
        cvc: '',
        name: ''
    });
    
    const handlePayment = async (e) => {
        e.preventDefault();
        setProcessing(true);
        
        try {
            await API_CONFIG.processPayment({
                amount: amount,
                classId: classData._id,
                paymentMethod: 'card',
                cardInfo: cardInfo
            });
            
            onSuccess();
        } catch (error) {
            showError(error.message);
        } finally {
            setProcessing(false);
        }
    };
    
    return (
        <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
            <div className="bg-gray-800 rounded-lg p-6 max-w-md w-full">
                <h3 className="text-xl font-bold mb-4 text-white">Complete Payment</h3>
                
                <div className="bg-blue-900 bg-opacity-30 rounded-lg p-4 mb-6">
                    <div className="flex justify-between items-center">
                        <span className="text-gray-300">Total Amount:</span>
                        <span className="text-2xl font-bold text-green-400">${amount}</span>
                    </div>
                </div>
                
                <form onSubmit={handlePayment}>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium mb-2 text-gray-300">Card Number</label>
                            <input
                                type="text"
                                className="coastal-input"
                                placeholder="4242 4242 4242 4242"
                                value={cardInfo.number}
                                onChange={(e) => setCardInfo({...cardInfo, number: e.target.value})}
                                required
                            />
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-2 text-gray-300">Expiry</label>
                                <input
                                    type="text"
                                    className="coastal-input"
                                    placeholder="MM/YY"
                                    value={cardInfo.expiry}
                                    onChange={(e) => setCardInfo({...cardInfo, expiry: e.target.value})}
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-2 text-gray-300">CVC</label>
                                <input
                                    type="text"
                                    className="coastal-input"
                                    placeholder="123"
                                    value={cardInfo.cvc}
                                    onChange={(e) => setCardInfo({...cardInfo, cvc: e.target.value})}
                                    required
                                />
                            </div>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium mb-2 text-gray-300">Cardholder Name</label>
                            <input
                                type="text"
                                className="coastal-input"
                                placeholder="John Doe"
                                value={cardInfo.name}
                                onChange={(e) => setCardInfo({...cardInfo, name: e.target.value})}
                                required
                            />
                        </div>
                    </div>
                    
                    <div className="flex gap-3 mt-6">
                        <button 
                            type="submit" 
                            className="coastal-button flex-1"
                            disabled={processing}
                        >
                            {processing ? 'Processing...' : `Pay $${amount}`}
                        </button>
                        <button 
                            type="button" 
                            onClick={onClose}
                            className="coastal-button bg-gray-600 hover:bg-gray-700"
                            disabled={processing}
                        >
                            Cancel
                        </button>
                    </div>
                </form>
                
                <p className="text-xs text-gray-500 mt-4 text-center">
                    <i className="fas fa-lock mr-1"></i>
                    Secured by Stripe
                </p>
            </div>
        </div>
    );
};
        // Trial Countdown Banner
const TrialBanner = ({ user }) => {
    const [daysLeft, setDaysLeft] = useState(null);
    
    useEffect(() => {
        if (user.trialActive && user.trialStartDate) {
            const start = new Date(user.trialStartDate);
            const end = new Date(start.getTime() + (SYSTEM_CONFIG.TRIAL_DAYS * 24 * 60 * 60 * 1000));
            const remaining = Math.ceil((end - Date.now()) / (1000 * 60 * 60 * 24));
            setDaysLeft(Math.max(0, remaining));
        }
    }, [user]);
    
    if (!user.trialActive || daysLeft === null) return null;
    
    return (
        <div className={`${daysLeft <= 2 ? 'bg-red-900' : 'bg-blue-900'} bg-opacity-30 border ${daysLeft <= 2 ? 'border-red-500' : 'border-blue-500'} rounded-lg p-4 mb-6 flex items-center justify-between`}>
            <div className="flex items-center gap-3">
                <i className={`fas fa-clock text-2xl ${daysLeft <= 2 ? 'text-red-400' : 'text-blue-400'}`}></i>
                <div>
                    <p className="font-semibold text-white">
                        {daysLeft > 0 ? `${daysLeft} days left in your free trial` : 'Trial expired'}
                    </p>
                    <p className="text-sm text-gray-400">Upgrade to continue using ClockWork</p>
                </div>
            </div>
            <button className="coastal-button bg-green-500 hover:bg-green-600">
                Upgrade Now
            </button>
        </div>
    );
};
            
            // Setup Progress Widget
const SetupProgressWidget = ({ user }) => {
    const [progress, setProgress] = useState(null);
    const [percentage, setPercentage] = useState(0);
    
    useEffect(() => {
        fetchProgress();
    }, [user.gymId]);
    
    const fetchProgress = async () => {
        try {
            const data = await API_CONFIG.getGymProgress(user.gymId);
            const setupProgress = data.setupProgress || {};
            setProgress(setupProgress);
            
            const completed = Object.values(setupProgress).filter(Boolean).length;
            setPercentage(Math.round((completed / SYSTEM_CONFIG.SETUP_STEPS.length) * 100));
        } catch (error) {
            console.error('Progress fetch failed:', error);
        }
    };
    
    if (!progress || percentage === 100) return null;
    
    return (
        <div className="dark-card p-6 mb-6">
            <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-bold text-white">Setup Progress</h3>
                <div className="text-2xl font-bold text-blue-400">{percentage}%</div>
            </div>
            
            <div className="progress-bar mb-4" style={{height: '12px'}}>
                <div 
                    className="progress-bar-fill bg-gradient-to-r from-blue-500 to-green-500"
                    style={{width: `${percentage}%`}}
                ></div>
            </div>
            
            <div className="space-y-2">
                {SYSTEM_CONFIG.SETUP_STEPS.map(step => (
                    <div 
                        key={step.id}
                        className={`flex items-center gap-3 p-2 rounded ${
                            progress[step.id] ? 'bg-green-900 bg-opacity-20' : 'bg-gray-800'
                        }`}
                    >
                        <div className={`w-5 h-5 rounded-full flex items-center justify-center ${
                            progress[step.id] ? 'bg-green-500' : 'bg-gray-600'
                        }`}>
                            {progress[step.id] && <i className="fas fa-check text-white text-xs"></i>}
                        </div>
                        <span className={`text-sm ${progress[step.id] ? 'text-green-400' : 'text-gray-400'}`}>
                            {step.label}
                        </span>
                    </div>
                ))}
            </div>
        </div>
    );
};
            
        // Tests Component (unchanged)
       // Replace the Tests component (around line 4951) with this fixed version:

const Tests = ({ user, showError, showSuccess }) => {
    console.log('Tests component rendered!', user);  // ADD THIS LINE
    const [tests, setTests] = useState([]);
    const [selectedClient, setSelectedClient] = useState(null);
    const [clients, setClients] = useState([]);
    const [showForm, setShowForm] = useState(false);
    const [editingTest, setEditingTest] = useState(null);
    const [formData, setFormData] = useState({
        testName: '',
        category: 'other', // Default to 'other' which is valid
        results: '',
        notes: ''
    });
    
    // Category options matching backend enum
    const categoryOptions = [
        { value: 'body-composition', label: 'Body Composition', icon: 'üìä' },
        { value: 'cardiovascular', label: 'Cardiovascular', icon: '‚ù§Ô∏è' },
        { value: 'strength', label: 'Strength', icon: 'üí™' },
        { value: 'flexibility', label: 'Flexibility', icon: 'ü§∏' },
        { value: 'other', label: 'Other Assessment', icon: 'üìù' }
    ];
    
    useEffect(() => {
        fetchClients();
        if (selectedClient) {
            fetchTests();
        }
    }, [selectedClient]);
    
    const fetchClients = async () => {
    const clients = await ClientManager.loadClients();
    setClients(clients);
};
    
    const fetchTests = async () => {
        try {
            const data = await API_CONFIG.request(`/tests/client/${selectedClient}`);
            setTests(Array.isArray(data) ? data : (data.data || []));
        } catch (error) {
            console.error('Error fetching tests:', error);
        }
    };
    
    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            const submitData = {
                name: formData.testName,
                category: formData.category, // Use the selected category
                results: formData.results,
                notes: formData.notes,
                date: DateHandler.toDatabase(DateHandler.getCurrentETDate()) // Add date field
            };
            
            if (editingTest) {
                await API_CONFIG.request(`/tests/${editingTest._id}`, {
                    method: 'PUT',
                    body: JSON.stringify(submitData)
                });
                showSuccess('Assessment updated successfully');
            } else {
                await API_CONFIG.request(`/tests/client/${selectedClient}`, {
                    method: 'POST',
                    body: JSON.stringify(submitData)
                });
                showSuccess('Assessment recorded successfully');
            }
            
            setShowForm(false);
            setEditingTest(null);
            fetchTests();
            setFormData({
                testName: '',
                category: 'other',
                results: '',
                notes: ''
            });
        } catch (error) {
            showError(error.message);
        }
    };
    
    const handleEdit = (test) => {
        setEditingTest(test);
        setFormData({
            testName: test.name || '',
            category: test.category || 'other',
            results: test.results || '',
            notes: test.notes || ''
        });
        setShowForm(true);
    };
    
    const handleDelete = async (testId) => {
        if (confirm('Delete this assessment?')) {
            try {
                await API_CONFIG.request(`/tests/${testId}`, {
                    method: 'DELETE'
                });
                showSuccess('Assessment deleted');
                fetchTests();
            } catch (error) {
                showError(error.message);
            }
        }
    };
    
    const getCategoryIcon = (category) => {
        const cat = categoryOptions.find(c => c.value === category);
        return cat ? cat.icon : 'üìù';
    };
    
    const getCategoryLabel = (category) => {
        const cat = categoryOptions.find(c => c.value === category);
        return cat ? cat.label : category;
    };
    
    return (
        <div className="space-y-6">
            <div className="dark-card p-6">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-bold text-white">Tests & Assessments</h2>
                    {selectedClient && (
                        <button onClick={() => setShowForm(true)} className="coastal-button">
                            <i className="fas fa-plus mr-2"></i>
                            Add Assessment
                        </button>
                    )}
                </div>
                
                <select
                    className="coastal-input"
                    value={selectedClient || ''}
                    onChange={(e) => setSelectedClient(e.target.value)}
                >
                    <option value="">Select a client...</option>
                    {clients.map(client => (
                        <option key={client._id} value={client._id}>
                            {client.name}
                        </option>
                    ))}
                </select>
            </div>
            
            {showForm && (
                <div className="dark-card p-6">
                    <h3 className="text-xl font-semibold mb-4">
                        {editingTest ? 'Edit Assessment' : 'Log Assessment'}
                    </h3>
                    <form onSubmit={handleSubmit}>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-2">
                                    Test/Assessment Name
                                </label>
                                <input
                                    type="text"
                                    className="coastal-input"
                                    placeholder="e.g., VO2 Max, 1RM Bench Press, Body Fat %, Sit and Reach, etc."
                                    value={formData.testName}
                                    onChange={(e) => setFormData({...formData, testName: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium mb-2">
                                    Category
                                </label>
                                <select
                                    className="coastal-input"
                                    value={formData.category}
                                    onChange={(e) => setFormData({...formData, category: e.target.value})}
                                    required
                                >
                                    {categoryOptions.map(cat => (
                                        <option key={cat.value} value={cat.value}>
                                            {cat.icon} {cat.label}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium mb-2">
                                    Results/Data
                                </label>
                                <textarea
                                    className="coastal-input"
                                    rows="3"
                                    placeholder="Enter test results, measurements, scores, observations, etc."
                                    value={formData.results}
                                    onChange={(e) => setFormData({...formData, results: e.target.value})}
                                    required
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium mb-2">
                                    Additional Notes (Optional)
                                </label>
                                <textarea
                                    className="coastal-input"
                                    rows="2"
                                    placeholder="Any additional observations, client feedback, or notes"
                                    value={formData.notes}
                                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                />
                            </div>
                        </div>
                        
                        <div className="flex gap-4 mt-6">
                            <button type="submit" className="coastal-button">
                                {editingTest ? 'Update' : 'Save'} Assessment
                            </button>
                            <button 
                                type="button" 
                                onClick={() => {
                                    setShowForm(false);
                                    setEditingTest(null);
                                    setFormData({
                                        testName: '',
                                        category: 'other',
                                        results: '',
                                        notes: ''
                                    });
                                }} 
                                className="coastal-button bg-gray-600 hover:bg-gray-700"
                            >
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            )}
            
            {selectedClient && tests.length > 0 && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {tests.map(test => (
                        <div key={test._id} className="dark-card p-6">
                            <div className="flex justify-between items-start mb-2">
                                <div className="flex items-start gap-2">
                                    <span className="text-2xl">{getCategoryIcon(test.category)}</span>
                                    <div>
                                        <h3 className="text-lg font-semibold">{test.name}</h3>
                                        <span className="text-xs bg-gray-100 px-2 py-1 rounded">
                                            {getCategoryLabel(test.category)}
                                        </span>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => handleEdit(test)}
                                        className="text-blue-500 hover:text-blue-600"
                                    >
                                        <i className="fas fa-edit"></i>
                                    </button>
                                    <button
                                        onClick={() => handleDelete(test._id)}
                                        className="text-red-500 hover:text-red-600"
                                    >
                                        <i className="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <p className="text-sm text-gray-400 mb-3">
                                {DateHandler.toDisplay(test.date || test.createdAt)}
                            </p>
                            <div className="bg-gray-800 p-3 rounded mb-2">
                                <p className="text-sm font-medium text-gray-700 mb-1">Results:</p>
                                <p className="text-gray-800 whitespace-pre-wrap">{test.results}</p>
                            </div>
                            {test.notes && (
                                <div className="bg-blue-50 p-3 rounded">
                                    <p className="text-sm font-medium text-gray-700 mb-1">Notes:</p>
                                    <p className="text-gray-800 whitespace-pre-wrap">{test.notes}</p>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            )}
            
            {selectedClient && tests.length === 0 && (
                <div className="dark-card p-8 text-center text-gray-500">
                    <p>No assessments recorded yet.</p>
                    <p className="mt-2">Click "Add Assessment" to log test results or client notes.</p>
                </div>
            )}
        </div>
    );
};
     
        
        // Users Component (unchanged)
        const Users = ({ user, showError, showSuccess }) => {
             console.log('Users component rendered!', user);  // ADD THIS LINE
            const [users, setUsers] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [formData, setFormData] = useState({
                name: '',
                email: '',
                password: '',
                roles: []
            });
            
            useEffect(() => {
                fetchUsers();
            }, []);
            
            // ADD THIS:
const fetchUsers = async () => {
    try {
        const data = await API_CONFIG.request('/users');
        setUsers(data);  // data is already the users array
        
        // Update ClientManager with client users
        const clientUsers = data.filter(u => u.roles && u.roles.includes('client'));
        ClientManager.clients = clientUsers;
        ClientManager.loaded = true;
        console.log(`Updated ClientManager with ${clientUsers.length} clients from ${data.length} users`);
        
        // Force update all client dropdowns by resetting the cache
        window.ClientManager = ClientManager;
        
    } catch (error) {
        console.error('Error fetching users:', error);
        setUsers([]);
    }
};
            
            const handleSubmit = async (e) => {
    e.preventDefault();
    
    // Validate password match for new users
    if (!editingUser && formData.password !== formData.confirmPassword) {
        showError('Passwords do not match');
        return;
    }
    
    try {
        if (editingUser) {
            await API_CONFIG.request(`/users/${editingUser._id}`, {
                            method: 'PUT',
                            body: JSON.stringify(formData)
                        });
                        showSuccess('User updated successfully');
                    } else {
                        await API_CONFIG.request('/auth/register', {
                            method: 'POST',
                            body: JSON.stringify(formData)
                        });
                        showSuccess('User created successfully');
                    }
                    setShowForm(false);
                    setEditingUser(null);
                    fetchUsers();
                    setFormData({
    name: '',
    email: '',
    password: '',
    confirmPassword: '',
    roles: []
});
                } catch (error) {
                    showError(error.message);
                }
            };
            
            const handleEdit = (user) => {
                setEditingUser(user);
                setFormData({
                    name: user.name,
                    email: user.email,
                    password: '',
                    roles: user.roles
                });
                setShowForm(true);
            };
            
            const handleDelete = async (userId) => {
                if (confirm('Are you sure you want to delete this user?')) {
                    try {
                        await API_CONFIG.request(`/users/${userId}`, {
                            method: 'DELETE'
                        });
                        showSuccess('User deleted successfully');
                        fetchUsers();
                    } catch (error) {
                        showError(error.message);
                    }
                }
            };
            
            return (
                <div className="space-y-6">
                    <div className="coastal-card p-6">
    <div className="flex justify-between items-center mb-4">
        <h2 className="text-2xl font-bold">User Management</h2>
        <div className="flex gap-2">
            <button 
    onClick={async () => {
        await fetchUsers();
        const clientCount = ClientManager.clients.length;
        showSuccess(`Refreshed: ${users.length} users loaded, ${clientCount} are clients`);
    }} 
    className="coastal-button bg-gray-500"
>
                <i className="fas fa-sync-alt mr-2"></i>
                Refresh
            </button>
            <button onClick={() => setShowForm(true)} className="coastal-button">
                <i className="fas fa-plus mr-2"></i>
                Add User
            </button>
        </div>
    </div>
</div>
                    
                    {showForm && (
                        <div className="coastal-card p-6">
                            <h3 className="text-xl font-semibold mb-4">
                                {editingUser ? 'Edit User' : 'Create User'}
                            </h3>
                            <form onSubmit={handleSubmit}>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Name</label>
                                        <input
                                            type="text"
                                            className="coastal-input"
                                            value={formData.name}
                                            onChange={(e) => setFormData({...formData, name: e.target.value})}
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Email</label>
                                        <input
                                            type="email"
                                            className="coastal-input"
                                            value={formData.email}
                                            onChange={(e) => setFormData({...formData, email: e.target.value})}
                                            required
                                        />
                                    </div>
                                </div>
                                
                                {!editingUser && (
    <>
        <div className="mb-4">
            <label className="block text-sm font-medium mb-2">Password</label>
            <input
                type="password"
                className="coastal-input"
                value={formData.password}
                onChange={(e) => setFormData({...formData, password: e.target.value})}
                required
            />
        </div>
        <div className="mb-4">
            <label className="block text-sm font-medium mb-2">Confirm Password</label>
            <input
                type="password"
                className="coastal-input"
                value={formData.confirmPassword || ''}
                onChange={(e) => setFormData({...formData, confirmPassword: e.target.value})}
                required
            />
        </div>
    </>
)}
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-2">Roles</label>
                                    <div className="flex gap-4">
                                        {['client', 'specialist', 'admin', 'owner', 'engineer'].map(role => (
                                            <label key={role} className="flex items-center">
                                                <input
                                                    type="checkbox"
                                                    checked={formData.roles.includes(role)}
                                                    onChange={(e) => {
                                                        if (e.target.checked) {
                                                            setFormData({
                                                                ...formData,
                                                                roles: [...formData.roles, role]
                                                            });
                                                        } else {
                                                            setFormData({
                                                                ...formData,
                                                                roles: formData.roles.filter(r => r !== role)
                                                            });
                                                        }
                                                    }}
                                                    className="mr-2"
                                                />
                                                {role}
                                            </label>
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="flex gap-4">
                                    <button type="submit" className="coastal-button">
                                        {editingUser ? 'Update' : 'Create'} User
                                    </button>
                                    <button 
                                        type="button" 
                                        onClick={() => {
                                            setShowForm(false);
                                            setEditingUser(null);
                                            setFormData({
                                                name: '',
                                                email: '',
                                                password: '',
                                                roles: []
                                            });
                                        }} 
                                        className="coastal-button bg-gray-500"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {users.map(u => (
                            <div key={u._id} className="coastal-card p-4">
                                <div className="flex justify-between items-start mb-2">
                                    <div>
                                        <h3 className="font-semibold">{u.name}</h3>
                                        <p className="text-sm text-gray-600">{u.email}</p>
                                    </div>
                                    <div className="flex gap-1">
                                        <button
                                            onClick={() => handleEdit(u)}
                                            className="text-blue-500 hover:text-blue-600"
                                        >
                                            <i className="fas fa-edit"></i>
                                        </button>
                                        {u._id !== user._id && (
                                            <button
                                                onClick={() => handleDelete(u._id)}
                                                className="text-red-500 hover:text-red-600"
                                            >
                                                <i className="fas fa-trash"></i>
                                            </button>
                                        )}
                                    </div>
                                </div>
                                <div className="flex flex-wrap gap-1">
                                    {u.roles.map(role => (
                                        <span key={role} className={`px-2 py-1 rounded text-xs font-semibold badge-${role}`}>
                                            {role}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        // Render the app
       const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
// Phoenix of Tesla‚Ñ¢ Theatrical Background System
(() => {
    // Initialize Phoenix on page load
    const initPhoenix = () => {
        // Create canvas
        const phoenixCanvas = document.createElement('canvas');
        phoenixCanvas.id = 'phoenix-canvas';
        phoenixCanvas.width = window.innerWidth;
        phoenixCanvas.height = window.innerHeight;
        document.body.insertBefore(phoenixCanvas, document.body.firstChild);
        const ctx = phoenixCanvas.getContext('2d');
        
        // Particle system
        const particles = [];
        const embers = [];
        
        class Particle {
            constructor(x, y, type = 'fire') {
                this.x = x;
                this.y = y;
                this.type = type;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = type === 'fire' ? -Math.random() * 2 : Math.random() * 0.5;
                this.size = Math.random() * 4 + 2;
                this.life = 1;
                this.decay = Math.random() * 0.02 + 0.005;
                this.color = type === 'fire' 
                    ? `hsl(${Math.random() * 60 + 10}, 100%, ${Math.random() * 50 + 50}%)`
                    : `hsl(${Math.random() * 30 + 15}, 100%, ${Math.random() * 30 + 60}%)`;
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= this.decay;
                this.size *= 0.98;
                if (this.type === 'ember') {
                    this.vy += 0.05;
                }
            }
            
            draw(ctx) {
                ctx.save();
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.shadowBlur = 10;
                ctx.shadowColor = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }
        
        // Phoenix object
        const phoenix = {
            x: -200,
            y: window.innerHeight * 0.5,
            targetY: window.innerHeight * 0.5,
            speed: 1,
            wingPhase: 0,
            time: 0,
            
            update() {
                this.time += 0.03;
                this.x += this.speed;
                
                this.targetY = (window.innerHeight * 0.5) + Math.sin(this.time) * 60;
                this.y += (this.targetY - this.y) * 0.05;
                
                this.wingPhase = Math.sin(this.time * 2) * 0.5 + 0.5;
                
                if (this.x > window.innerWidth + 200) {
                    this.x = -200;
                }
                
                if (Math.random() < 0.7) {
                    particles.push(new Particle(
                        this.x + Math.random() * 40 - 20,
                        this.y + Math.random() * 20 - 10,
                        'fire'
                    ));
                }
                
                if (Math.random() < 0.1) {
                    embers.push(new Particle(
                        this.x,
                        this.y,
                        'ember'
                    ));
                }
            },
            
            draw(ctx) {
                ctx.save();
                
                // Multiple glow layers
                for(let i = 3; i > 0; i--) {
                    const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, 40 * i);
                    gradient.addColorStop(0, `rgba(255, 200, 0, ${0.3/i})`);
                    gradient.addColorStop(0.5, `rgba(255, 100, 0, ${0.2/i})`);
                    gradient.addColorStop(1, 'rgba(255, 0, 0, 0)');
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 40 * i, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // Wing trails
                ctx.strokeStyle = 'rgba(255, 150, 0, 0.9)';
                ctx.lineWidth = 5;
                ctx.shadowBlur = 30;
                ctx.shadowColor = '#ff6600';
                ctx.lineCap = 'round';
                
                // Left wing
                for(let i = 0; i < 3; i++) {
                    ctx.globalAlpha = 1 - (i * 0.3);
                    ctx.beginPath();
                    ctx.moveTo(this.x - i * 10, this.y);
                    ctx.quadraticCurveTo(
                        this.x - 50 - this.wingPhase * 30 - i * 15, 
                        this.y - 40,
                        this.x - 100 - i * 10, 
                        this.y
                    );
                    ctx.stroke();
                }
                
                // Right wing
                for(let i = 0; i < 3; i++) {
                    ctx.globalAlpha = 1 - (i * 0.3);
                    ctx.beginPath();
                    ctx.moveTo(this.x + i * 10, this.y);
                    ctx.quadraticCurveTo(
                        this.x + 50 + this.wingPhase * 30 + i * 15, 
                        this.y - 40,
                        this.x + 100 + i * 10, 
                        this.y
                    );
                    ctx.stroke();
                }
                
                ctx.restore();
            }
        };
        
        // Animation loop
        function animate() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, phoenixCanvas.width, phoenixCanvas.height);
            
            phoenix.update();
            phoenix.draw(ctx);
            
            particles.forEach((p, i) => {
                p.update();
                p.draw(ctx);
                if (p.life <= 0 || p.size <= 0.1) {
                    particles.splice(i, 1);
                }
            });
            
            embers.forEach((e, i) => {
                e.update();
                e.draw(ctx);
                if (e.life <= 0 || e.y > phoenixCanvas.height) {
                    embers.splice(i, 1);
                }
            });
            
            requestAnimationFrame(animate);
        }
        
        // Fire boost interval
        setInterval(() => {
            if (particles.length < 500) {
                for (let i = 0; i < 5; i++) {
                    particles.push(new Particle(
                        phoenix.x - Math.random() * 100,
                        phoenix.y + Math.random() * 40 - 20,
                        'fire'
                    ));
                }
            }
        }, 50);
        
        // Handle resize
        window.addEventListener('resize', () => {
            phoenixCanvas.width = window.innerWidth;
            phoenixCanvas.height = window.innerHeight;
        });
        
        // Ensure login form is clickable
        const root = document.getElementById('root');
        if (root) {
            root.style.position = 'relative';
            root.style.zIndex = '10';
        }
        
        // Start animation
        animate();
        console.log('Phoenix of Tesla‚Ñ¢ System Initialized');
    };
    
    // Start Phoenix after DOM loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPhoenix);
    } else {
        initPhoenix();
    }
})();
    </script>
</body>
</html>
